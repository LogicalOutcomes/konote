{% extends "portal/base_portal.html" %}
{% load i18n %}
{% load survey_tags %}

{% block title %}{{ survey.name }}{% endblock %}

{% block content %}
<h1>{{ survey.name }}</h1>

{% if survey.description %}
<p>{{ survey.description }}</p>
{% endif %}

{% if is_multi_page %}
<div class="survey-progress" role="status" aria-live="polite">
    <small>{% blocktrans with current=page_num total=total_pages %}Page {{ current }} of {{ total }}{% endblocktrans %}</small>
    <progress value="{{ page_num }}" max="{{ total_pages }}" aria-label="{% trans 'Survey progress' %}"></progress>
</div>
{% endif %}

<div id="save-status" aria-live="polite"></div>

{% if errors %}
<article class="portal-message portal-message-error" role="alert">
    <p><strong>{% trans "Please answer all required questions:" %}</strong></p>
    <ul>
    {% for err in errors %}
        <li>{{ err }}</li>
    {% endfor %}
    </ul>
</article>
{% endif %}

<form method="post" id="survey-form">
    {% csrf_token %}

    {% for section in sections %}
    <fieldset class="survey-section">
        <legend><strong>{{ section.title }}</strong></legend>
        {% if section.instructions %}<p>{{ section.instructions }}</p>{% endif %}

        {% for question in section.questions.all %}
        <div class="survey-question" style="margin-bottom:1.5rem">

            {% if question.question_type == "short_text" %}
            <label for="q_{{ question.pk }}">
                {{ question.question_text }}{% if question.required %} <abbr title="{% trans 'required' %}" aria-hidden="true">*</abbr>{% endif %}
            </label>
            <input type="text" id="q_{{ question.pk }}" name="q_{{ question.pk }}"
                   value="{{ question.pk|partial_value:partial_answers }}"
                   {% if question.required %}required aria-required="true"{% endif %}
                   hx-post="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                   hx-trigger="blur"
                   hx-vals='{"question_id": "{{ question.pk }}"}'
                   hx-include="[name=csrfmiddlewaretoken]"
                   hx-target="#save-status"
                   hx-swap="innerHTML">

            {% elif question.question_type == "long_text" %}
            <label for="q_{{ question.pk }}">
                {{ question.question_text }}{% if question.required %} <abbr title="{% trans 'required' %}" aria-hidden="true">*</abbr>{% endif %}
            </label>
            <textarea id="q_{{ question.pk }}" name="q_{{ question.pk }}" rows="4"
                      {% if question.required %}required aria-required="true"{% endif %}
                      hx-post="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                      hx-trigger="blur"
                      hx-vals='{"question_id": "{{ question.pk }}"}'
                      hx-include="[name=csrfmiddlewaretoken]"
                      hx-target="#save-status"
                      hx-swap="innerHTML">{{ question.pk|partial_value:partial_answers }}</textarea>

            {% elif question.question_type == "yes_no" %}
            <label for="q_{{ question.pk }}">
                {{ question.question_text }}{% if question.required %} <abbr title="{% trans 'required' %}" aria-hidden="true">*</abbr>{% endif %}
            </label>
            <select id="q_{{ question.pk }}" name="q_{{ question.pk }}"
                    {% if question.required %}required aria-required="true"{% endif %}
                    hx-post="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                    hx-trigger="change"
                    hx-vals='{"question_id": "{{ question.pk }}"}'
                    hx-include="[name=csrfmiddlewaretoken]"
                    hx-target="#save-status"
                    hx-swap="innerHTML">
                <option value="">—</option>
                <option value="1" {% if question.pk|partial_value:partial_answers == "1" %}selected{% endif %}>{% trans "Yes" %}</option>
                <option value="0" {% if question.pk|partial_value:partial_answers == "0" %}selected{% endif %}>{% trans "No" %}</option>
            </select>

            {% elif question.question_type == "single_choice" %}
            <fieldset class="survey-question-group">
                <legend>
                    {{ question.question_text }}{% if question.required %} <abbr title="{% trans 'required' %}" aria-hidden="true">*</abbr>{% endif %}
                </legend>
                {% for opt in question.options_json %}
                <label>
                    <input type="radio" name="q_{{ question.pk }}" value="{{ opt.value }}"
                           {% if question.pk|partial_value:partial_answers == opt.value %}checked{% endif %}
                           {% if question.required %}required{% endif %}
                           hx-post="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                           hx-trigger="change"
                           hx-vals='{"question_id": "{{ question.pk }}"}'
                           hx-include="[name=csrfmiddlewaretoken]"
                           hx-target="#save-status"
                           hx-swap="innerHTML">
                    {{ opt.label }}
                </label>
                {% endfor %}
            </fieldset>

            {% elif question.question_type == "multiple_choice" %}
            <fieldset class="survey-question-group">
                <legend>
                    {{ question.question_text }}{% if question.required %} <abbr title="{% trans 'required' %}" aria-hidden="true">*</abbr>{% endif %}
                </legend>
                {% with saved_multi=question.pk|partial_value:partial_answers %}
                {% for opt in question.options_json %}
                <label>
                    <input type="checkbox" name="q_{{ question.pk }}" value="{{ opt.value }}"
                           {% if opt.value|in_multi_value:saved_multi %}checked{% endif %}
                           onchange="htmxSaveCheckboxGroup(this)"
                           data-save-url="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                           data-question-id="{{ question.pk }}">
                    {{ opt.label }}
                </label>
                {% endfor %}
                {% endwith %}
            </fieldset>

            {% elif question.question_type == "rating_scale" %}
            <fieldset class="survey-question-group">
                <legend>
                    {{ question.question_text }}{% if question.required %} <abbr title="{% trans 'required' %}" aria-hidden="true">*</abbr>{% endif %}
                </legend>
                <div role="group" class="rating-scale">
                {% for opt in question.options_json %}
                    <label style="text-align:center">
                        <input type="radio" name="q_{{ question.pk }}" value="{{ opt.value }}"
                               {% if question.pk|partial_value:partial_answers == opt.value %}checked{% endif %}
                               {% if question.required %}required{% endif %}
                               hx-post="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                               hx-trigger="change"
                               hx-vals='{"question_id": "{{ question.pk }}"}'
                               hx-include="[name=csrfmiddlewaretoken]"
                               hx-target="#save-status"
                               hx-swap="innerHTML">
                        {{ opt.label }}
                    </label>
                {% endfor %}
                </div>
            </fieldset>
            {% endif %}

        </div>
        {% endfor %}
    </fieldset>
    {% endfor %}

    <div class="survey-nav">
        {% if is_multi_page and page_num > 1 %}
        <a href="?page={{ page_num|add:"-1" }}" class="outline" role="button">&larr; {% trans "Back" %}</a>
        {% endif %}

        {% if is_multi_page and not is_last_page %}
        <button type="submit" name="action" value="next">{% trans "Next" %} &rarr;</button>
        {% else %}
        <button type="submit" name="action" value="submit">{% trans "Submit" %}</button>
        {% endif %}
    </div>
</form>

<p><a href="{% url 'portal:surveys' %}">&larr; {% trans "Back to surveys" %}</a></p>

<style>
.survey-progress { margin-bottom: 1rem; }
.survey-progress progress { width: 100%; height: 0.5rem; margin-top: 0.25rem; }
.survey-question-group { border: none; padding: 0; margin: 0; }
.survey-question-group legend { font-weight: normal; padding: 0; margin-bottom: 0.5rem; }
.survey-nav { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem; }
.save-indicator { color: var(--pico-muted-color); font-size: 0.875rem; }
.save-error { color: var(--pico-del-color); font-size: 0.875rem; }
@media (prefers-reduced-motion: no-preference) {
    .save-indicator {
        animation: fade-out 2s ease-in forwards;
        animation-delay: 1s;
    }
}
@keyframes fade-out {
    from { opacity: 1; }
    to { opacity: 0; }
}
</style>

<script>
/* Auto-save for multiple_choice checkboxes — collects all checked values */
function htmxSaveCheckboxGroup(el) {
    var name = el.name;
    var form = el.closest('form');
    var checked = form.querySelectorAll('input[name="' + name + '"]:checked');
    var values = Array.from(checked).map(function(cb) { return cb.value; }).join(';');
    var csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(el.dataset.saveUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'HX-Request': 'true',
            'X-CSRFToken': csrfToken
        },
        body: 'question_id=' + el.dataset.questionId + '&value=' + encodeURIComponent(values)
    })
    .then(function(r) { return r.text(); })
    .then(function(html) { document.getElementById('save-status').innerHTML = html; })
    .catch(function() {
        document.getElementById('save-status').innerHTML =
            '<span role="status" class="save-error">Could not save</span>';
    });
}

/* Focus management: after page load, focus page heading if multi-page */
document.addEventListener('DOMContentLoaded', function() {
    var progress = document.querySelector('.survey-progress');
    if (progress) {
        var heading = document.querySelector('h1');
        if (heading) {
            heading.setAttribute('tabindex', '-1');
            heading.focus();
        }
    }
});
</script>
{% endblock %}

