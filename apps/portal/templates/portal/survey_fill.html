{% extends "portal/base_portal.html" %}
{% load i18n portal_tags %}

{% block title %}{{ survey.name }}{% endblock %}

{% block content %}
<h1>{{ survey.name }}</h1>

{% if survey.description %}
<p>{{ survey.description }}</p>
{% endif %}

<p class="autosave-notice" aria-live="polite">
    <small>{% trans "Your answers are being saved automatically." %}</small>
</p>

{% if errors %}
<article class="portal-message portal-message-error" role="alert">
    <p><strong>{% trans "Please answer all required questions:" %}</strong></p>
    <ul>
    {% for err in errors %}
        <li>{{ err }}</li>
    {% endfor %}
    </ul>
</article>
{% endif %}

<form method="post">
    {% csrf_token %}

    {% for section in sections %}
    <fieldset>
        <legend>{{ section.title }}</legend>
        {% if section.instructions %}<p>{{ section.instructions }}</p>{% endif %}

        {% for question in section.questions.all %}
        <div style="margin-bottom:1.5rem">
            <label for="q_{{ question.pk }}">
                {{ question.question_text }}{% if question.required %} <abbr title="{% trans 'required' %}">*</abbr>{% endif %}
            </label>

            {% if question.question_type == "short_text" %}
            <input type="text" id="q_{{ question.pk }}" name="q_{{ question.pk }}"
                   value="{{ partials|dict_get:question.pk }}"
                   hx-post="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                   hx-trigger="blur" hx-swap="none"
                   hx-vals='{"question_id": "{{ question.pk }}", "value": ""}'
                   data-autosave-field
                   {% if question.required %}required{% endif %}>

            {% elif question.question_type == "long_text" %}
            <textarea id="q_{{ question.pk }}" name="q_{{ question.pk }}" rows="4"
                      hx-post="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                      hx-trigger="blur" hx-swap="none"
                      hx-vals='{"question_id": "{{ question.pk }}", "value": ""}'
                      data-autosave-field
                      {% if question.required %}required{% endif %}>{{ partials|dict_get:question.pk }}</textarea>

            {% elif question.question_type == "yes_no" %}
            {% with partial_val=partials|dict_get:question.pk %}
            <select id="q_{{ question.pk }}" name="q_{{ question.pk }}"
                    hx-post="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                    hx-trigger="change" hx-swap="none"
                    hx-vals='{"question_id": "{{ question.pk }}", "value": ""}'
                    data-autosave-field
                    {% if question.required %}required{% endif %}>
                <option value="">—</option>
                <option value="1" {% if partial_val == "1" %}selected{% endif %}>{% trans "Yes" %}</option>
                <option value="0" {% if partial_val == "0" %}selected{% endif %}>{% trans "No" %}</option>
            </select>
            {% endwith %}

            {% elif question.question_type == "single_choice" %}
            {% with partial_val=partials|dict_get:question.pk %}
            {% for opt in question.options_json %}
            <label>
                <input type="radio" name="q_{{ question.pk }}" value="{{ opt.value }}"
                       hx-post="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                       hx-trigger="change" hx-swap="none"
                       hx-vals='{"question_id": "{{ question.pk }}", "value": "{{ opt.value }}"}'
                       {% if partial_val == opt.value %}checked{% endif %}>
                {{ opt.label }}
            </label>
            {% endfor %}
            {% endwith %}

            {% elif question.question_type == "multiple_choice" %}
            {% with partial_val=partials|dict_get:question.pk %}
            {% for opt in question.options_json %}
            <label>
                <input type="checkbox" name="q_{{ question.pk }}" value="{{ opt.value }}"
                       hx-post="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                       hx-trigger="change" hx-swap="none"
                       hx-vals='{"question_id": "{{ question.pk }}"}'
                       data-autosave-checkbox
                       {% if opt.value in partial_val %}checked{% endif %}>
                {{ opt.label }}
            </label>
            {% endfor %}
            {% endwith %}

            {% elif question.question_type == "rating_scale" %}
            {% with partial_val=partials|dict_get:question.pk %}
            <div role="group">
            {% for opt in question.options_json %}
                <label style="text-align:center">
                    <input type="radio" name="q_{{ question.pk }}" value="{{ opt.value }}"
                           hx-post="{% url 'portal:survey_autosave' assignment_id=assignment.pk %}"
                           hx-trigger="change" hx-swap="none"
                           hx-vals='{"question_id": "{{ question.pk }}", "value": "{{ opt.value }}"}'
                           {% if partial_val == opt.value %}checked{% endif %}>
                    {{ opt.label }}
                </label>
            {% endfor %}
            </div>
            {% endwith %}
            {% endif %}
        </div>
        {% endfor %}
    </fieldset>
    {% endfor %}

    <button type="submit">{% trans "Submit" %}</button>
</form>

<p><a href="{% url 'portal:surveys' %}">← {% trans "Back to surveys" %}</a></p>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // Configure HTMX to send CSRF token with all requests
    var csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        document.body.addEventListener('htmx:configRequest', function(event) {
            event.detail.headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
        });
    }

    // For text inputs and textareas, send the current field value
    document.querySelectorAll('[data-autosave-field]').forEach(function(el) {
        el.addEventListener('htmx:configRequest', function(event) {
            event.detail.parameters['value'] = el.value;
        });
    });

    // For checkboxes (multiple_choice), collect all checked values and send as semicolon-separated
    document.querySelectorAll('[data-autosave-checkbox]').forEach(function(el) {
        el.addEventListener('htmx:configRequest', function(event) {
            var name = el.getAttribute('name');
            var checked = document.querySelectorAll('input[name="' + name + '"]:checked');
            var values = [];
            checked.forEach(function(cb) { values.push(cb.value); });
            event.detail.parameters['value'] = values.join(';');
        });
    });
})();
</script>
{% endblock %}
