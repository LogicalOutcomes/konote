{% load i18n %}
{% load static %}
{% load permissions_tags %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{{ site.product_name|default:"KoNote" }}{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" href="{% static 'img/favicon.svg' %}" type="image/svg+xml">
    <link rel="icon" href="{% static 'img/favicon.ico' %}" sizes="any">
    <link rel="apple-touch-icon" href="{% static 'img/apple-touch-icon.png' %}">
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="theme-color" content="{{ site.brand_color|default:'#3176aa' }}">

    <!-- Pico CSS — classless, accessible defaults -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

    <!-- Theme (brand identity — swappable per agency) -->
    <link rel="stylesheet" href="{% static 'css/theme.css' %}">

    {% if site.brand_color %}
    <!-- Agency brand colour override -->
    <style>
    :root {
        --kn-primary: {{ site.brand_color }};
        --kn-primary-hover: {{ site.brand_color_hover|default:site.brand_color }};
        --kn-primary-focus: {{ site.brand_color_focus|default:"rgba(49, 118, 170, 0.25)" }};
        --kn-primary-subtle: {{ site.brand_color_subtle|default:"rgba(49, 118, 170, 0.08)" }};
        --pico-primary: var(--kn-primary);
        --pico-primary-hover: var(--kn-primary-hover);
        --pico-primary-focus: var(--kn-primary-focus);
    }
    </style>
    {% endif %}

    <!-- App structure styles -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- BLOCKER-1: Skip-to-content link — WCAG 2.4.1 bypass block -->
    <a href="#main-content" class="visually-hidden-focusable">{% trans "Skip to main content" %}</a>

    <!-- Loading bar — shown during HTMX requests -->
    <div id="loading-bar" class="loading-bar htmx-indicator"></div>

    {% if user.is_authenticated and user.is_demo %}
    <div class="demo-banner" role="alert" aria-live="polite">
        <strong>{% trans "Demo Mode:" %}</strong> {% blocktrans with name=user.display_name %}You are logged in as {{ name }}. Changes affect demo data only.{% endblocktrans %}
    </div>
    {% endif %}

    {% if overdue_reports %}
    <div class="report-deadline-banner report-deadline-overdue" role="alert">
        <strong>{% trans "Overdue:" %}</strong>
        {% for schedule in overdue_reports %}
        {{ schedule.name }} ({% trans "due" %} {{ schedule.due_date|date:"M j" }}){% if not forloop.last %}, {% endif %}
        {% endfor %}
        — <a href="{% url 'reports:schedule_list' %}">{% trans "View schedules" %}</a>
    </div>
    {% elif upcoming_reports %}
    <div class="report-deadline-banner report-deadline-upcoming" role="status">
        <strong>{% trans "Upcoming:" %}</strong>
        {% for schedule in upcoming_reports %}
        {{ schedule.name }} ({% trans "due" %} {{ schedule.due_date|date:"M j" }}){% if not forloop.last %}, {% endif %}
        {% endfor %}
        — <a href="{% url 'reports:schedule_list' %}">{% trans "View schedules" %}</a>
    </div>
    {% endif %}

    {% if not user.is_authenticated %}
    <nav class="container-fluid">
        <ul>
            <li><a href="/" class="contrast">
                <strong>{{ site.product_name|default:"KoNote" }}</strong>
            </a></li>
        </ul>
        <ul>
            <li><a href="{% url 'auth_app:login' %}">{% trans "Sign In" %}</a></li>
            <li>{% include "_lang_toggle.html" with inline=True form_class="nav-lang-form" %}</li>
        </ul>
    </nav>
    {% endif %}

    {% if user.is_authenticated %}
    <nav class="container-fluid">
        <ul>
            <li><a href="{% if is_admin_only %}{% url 'admin_settings:dashboard' %}{% else %}/{% endif %}" class="contrast">
                <strong>{{ site.product_name|default:"KoNote" }}</strong>
            </a></li>
            <li>
                <!-- Mobile menu toggle -->
                <button type="button" id="nav-toggle" class="nav-toggle" aria-expanded="false" aria-controls="nav-menu" aria-label="{% trans 'Toggle navigation menu' %}">
                    <span class="nav-toggle-icon" aria-hidden="true"></span>
                </button>
            </li>
        </ul>
        <ul id="nav-menu">
            {% has_permission "client.view_name" as can_see_clients %}
            {% has_permission "metric.view_aggregate" as can_see_insights %}
            {% has_permission "report.program_report" as can_see_reports %}
            {% has_permission "group.view_roster" as can_see_groups %}
            {% if can_see_clients %}
            <li><a href="/"{% if nav_active == "clients" %} class="nav-active" aria-current="page"{% endif %}>{{ term.client_plural|default:"Participants" }}</a></li>
            {% endif %}
            {% if features.groups and can_see_groups %}
            <li><a href="/groups/"{% if nav_active == "groups" %} class="nav-active" aria-current="page"{% endif %}>{{ term.group_plural|default:"Groups" }}</a></li>
            {% endif %}
            {% if features.circles and user_permissions.circle_view %}
            <li><a href="/circles/"{% if nav_active == "circles" %} class="nav-active" aria-current="page"{% endif %}>{{ term.circle_plural|default:"Circles" }}</a></li>
            {% endif %}
            {% has_permission "meeting.view" as can_see_meetings %}
            {% if can_see_meetings %}
            <li><a href="{% url 'events:meeting_list' %}"{% if nav_active == "meetings" %} class="nav-active" aria-current="page"{% endif %}>{% trans "Meetings" %}</a></li>
            {% endif %}
            {% has_permission "message.view" as can_see_messages %}
            {% if can_see_messages %}
            <li><a href="{% url 'communications:my_messages' %}"{% if nav_active == "messages" %} class="nav-active" aria-current="page"{% endif %}>{% trans "Messages" %}{% if unread_message_count %} <span class="badge badge-warning">{{ unread_message_count }}</span>{% endif %}</a></li>
            {% endif %}
            {% if has_program_roles and not can_see_clients %}
            <li><a href="{% url 'clients:executive_dashboard' %}"{% if nav_active == "executive" %} class="nav-active" aria-current="page"{% endif %}>{% trans "Dashboard" %}</a></li>
            {% endif %}
            {% if features.programs %}
            <li><a href="/programs/"{% if nav_active == "programs" %} class="nav-active" aria-current="page"{% endif %}>{{ term.program_plural|default:"Programs" }}</a></li>
            {% endif %}
            {% if can_see_insights %}
            <li><a href="/reports/insights/"{% if nav_active == "insights" %} class="nav-active" aria-current="page"{% endif %}>{% trans "Insights" %}</a></li>
            {% endif %}
            {% if can_see_reports or user.is_admin %}
            <li>
                <details class="dropdown" role="list">
                    <summary aria-haspopup="listbox"{% if nav_active == "reports" %} class="nav-active" aria-current="page"{% endif %}>{% trans "Reports" %}</summary>
                    <ul role="listbox">
                        <li><a href="{% url 'reports:generate_report' %}">{% trans "Generate Report" %}</a></li>
                        <li><a href="{% url 'reports:export_form' %}">{% trans "Custom Export" %}</a></li>
                    </ul>
                </details>
            </li>
            {% endif %}
            {% has_permission "alert.review_cancel_recommendation" as can_review_recommendations %}
            {% if can_review_recommendations %}
            <li><a href="{% url 'events:alert_recommendation_queue' %}"{% if nav_active == "recommendations" %} class="nav-active" aria-current="page"{% endif %}>{% trans "Approvals" %}{% if pending_recommendation_count %} <span class="badge badge-warning">{{ pending_recommendation_count }}</span>{% endif %}</a></li>
            {% endif %}
            {% if user.is_admin %}
            <li>
                <details class="dropdown" role="list">
                    <summary aria-haspopup="listbox"{% if nav_active == "admin" %} class="nav-active" aria-current="page"{% endif %}>{% trans "Admin" %}</summary>
                    <ul role="listbox">
                        <li><a href="{% url 'reports:team_meeting_view' %}">{% trans "Team Activity" %}</a></li>
                        <li><a href="{% url 'suggestion_themes:theme_list' %}">{% trans "Suggestion Themes" %}</a></li>
                        <li><a href="{% url 'metrics:metric_library' %}">{{ term.metric_plural|default:"Metrics" }}</a></li>
                        <li><a href="{% url 'plan_templates:template_list' %}">{% trans "Plan Templates" %}</a></li>
                        <li><a href="{% url 'note_templates:template_list' %}">{% trans "Note Templates" %}</a></li>
                        <li><a href="{% url 'event_types:event_type_list' %}">{% trans "Event Types" %}</a></li>
                        {% if features.surveys %}
                        <li><a href="{% url 'survey_manage:survey_list' %}"{% if nav_active == "surveys" %} class="nav-active"{% endif %}>{% trans "Surveys" %}</a></li>
                        {% endif %}
                        <li><a href="{% url 'registration:registration_link_list' %}">{% trans "Registration Links" %}</a></li>
                        <li><a href="{% url 'registration:submission_list' %}">{% trans "Pending Submissions" %}{% if pending_submissions_count %} <span class="badge badge-warning">{{ pending_submissions_count }}</span>{% endif %}</a></li>
                        <li><a href="{% url 'admin_settings:dashboard' %}">{% trans "Settings" %}</a></li>
                        <li><a href="{% url 'admin_settings:report_template_list' %}">{% trans "Report Templates" %}</a></li>
                        <li><a href="{% url 'reports:oversight_list' %}">{% trans "Safety Oversight" %}</a></li>
                        <li><a href="{% url 'admin_users:invite_list' %}">{% trans "New Users" %}</a></li>
                        <li><a href="{% url 'audit:audit_log_list' %}">{% trans "Audit Log" %}</a></li>
                        <li><a href="{% url 'merge_candidates_list' %}">{% trans "Merge Duplicates" %}</a></li>
                        <li><a href="{% url 'erasure_pending_list' %}">{% blocktrans with term=term.client|default:"Participant" %}Erase {{ term }} Data{% endblocktrans %}{% if pending_erasure_count %} <span class="badge badge-warning">{{ pending_erasure_count }}</span>{% endif %}</a></li>
                    </ul>
                </details>
            </li>
            {% else %}
            {% has_permission "user.manage" as can_manage_users %}
            {% has_permission "template.plan.manage" as can_manage_plan_templates %}
            {% has_permission "template.note.manage" as can_manage_note_templates %}
            {% has_permission "event_type.manage" as can_manage_event_types %}
            {% has_permission "metric.manage" as can_manage_metrics %}
            {% has_permission "registration.manage" as can_manage_registration %}
            {% has_permission "audit.view" as can_see_audit %}
            {% if not is_executive_only %}
            {% if can_manage_users or can_manage_plan_templates or can_manage_note_templates or can_manage_event_types or can_manage_metrics or can_manage_registration or can_see_audit %}
            <li>
                <details class="dropdown" role="list">
                    <summary aria-haspopup="listbox"{% if nav_active == "admin" %} class="nav-active" aria-current="page"{% endif %}>{% trans "Manage" %}</summary>
                    <ul role="listbox">
                        <li><a href="{% url 'reports:team_meeting_view' %}">{% trans "Team Activity" %}</a></li>
                        {% has_permission "suggestion_theme.view" as can_see_themes %}
                        {% if can_see_themes %}
                        <li><a href="{% url 'suggestion_themes:theme_list' %}">{% trans "Suggestion Themes" %}</a></li>
                        {% endif %}
                        {% if can_manage_users %}
                        <li><a href="{% url 'admin_users:user_list' %}">{% trans "Team Members" %}</a></li>
                        {% endif %}
                        {% if can_manage_plan_templates %}
                        <li><a href="{% url 'plan_templates:template_list' %}">{% trans "Plan Templates" %}</a></li>
                        {% endif %}
                        {% if can_manage_note_templates %}
                        <li><a href="{% url 'note_templates:template_list' %}">{% trans "Note Templates" %}</a></li>
                        {% endif %}
                        {% if can_manage_note_templates and features.surveys %}
                        <li><a href="{% url 'survey_manage:survey_list' %}"{% if nav_active == "surveys" %} class="nav-active"{% endif %}>{% trans "Surveys" %}</a></li>
                        {% endif %}
                        {% if can_manage_event_types %}
                        <li><a href="{% url 'event_types:event_type_list' %}">{% trans "Event Types" %}</a></li>
                        {% endif %}
                        {% if can_manage_metrics %}
                        <li><a href="{% url 'metrics:metric_library' %}">{{ term.metric_plural|default:"Metrics" }}</a></li>
                        {% endif %}
                        {% if can_manage_registration %}
                        <li><a href="{% url 'registration:registration_link_list' %}">{% trans "Registration Links" %}</a></li>
                        <li><a href="{% url 'registration:submission_list' %}">{% trans "Pending Submissions" %}{% if pending_submissions_count %} <span class="badge badge-warning">{{ pending_submissions_count }}</span>{% endif %}</a></li>
                        {% endif %}
                        {% if can_see_audit %}
                        <li><a href="{% url 'audit:audit_log_list' %}">{% trans "Audit Log" %}</a></li>
                        {% endif %}
                    </ul>
                </details>
            </li>
            {% endif %}
            {% endif %}
            {% endif %}
            {% include "_program_switcher.html" %}
            <li class="nav-user-dropdown">
                <details class="dropdown" role="list" dir="rtl">
                    <summary aria-haspopup="listbox">{{ user.display_name }}{% if active_program_role_display %} <span class="badge badge-neutral nav-role-badge">{{ active_program_role_display }}</span>{% endif %}</summary>
                    <ul role="listbox">
                        <li><a href="{% url 'auth_app:logout' %}">{% trans "Sign Out" %}</a></li>
                    </ul>
                </details>
            </li>
            <li class="nav-user-mobile">
                <span class="nav-user-name">{{ user.display_name }}{% if active_program_role_display %} <span class="badge badge-neutral nav-role-badge">{{ active_program_role_display }}</span>{% endif %}</span>
            </li>
            <li class="nav-signout-mobile">
                <a href="{% url 'auth_app:logout' %}">{% trans "Sign Out" %}</a>
            </li>
            <li>{% include "_lang_toggle.html" with inline=True form_class="nav-lang-form" %}</li>
        </ul>
    </nav>
    {% endif %}

    <div id="offline-banner" class="offline-banner" hidden role="alert">
        {% trans "You appear to be offline. Your changes may not be saved." %}
        <button type="button" class="offline-retry">{% trans "Try again" %}</button>
    </div>

    <main id="main-content" class="container" tabindex="-1" aria-label="{% trans 'Main content' %}">
        {% if messages %}
        <div role="status" aria-live="polite" aria-atomic="false">
        {% for message in messages %}
        <article aria-label="notification" {% if message.tags %}class="{{ message.tags }}"{% endif %}>
            {{ message }}
        </article>
        {% endfor %}
        </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <!-- Screen reader announcer for HTMX form success (IMPROVE-9 / WCAG 4.1.3) -->
    <div id="sr-announcer" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>

    <!-- HTMX error toast — shown by app.js on network/server errors -->
    <div id="htmx-error-toast" class="toast toast-error" role="alert" hidden>
        <span id="htmx-error-toast-message"></span>
        <button type="button" id="htmx-error-toast-close" aria-label="{% trans 'Dismiss' %}" style="background:none;border:none;cursor:pointer;padding:0 0 0 1rem;font-size:1.2rem;color:inherit;">&times;</button>
    </div>

    <!-- HTMX success toast — shown by app.js for async confirmations (UXP2 / WCAG 4.1.3) -->
    <div id="htmx-success-toast" class="toast toast-success" role="status" hidden>
        <span id="htmx-success-toast-message"></span>
        <button type="button" id="htmx-success-toast-close" aria-label="{% trans 'Dismiss' %}" style="background:none;border:none;cursor:pointer;padding:0 0 0 1rem;font-size:1.2rem;color:inherit;">&times;</button>
    </div>

    <footer class="container site-footer" role="contentinfo">
        <div class="site-footer-inner">
            <div class="site-footer-brand">
                <strong>{{ site.product_name|default:"KoNote" }}</strong>
                {% if site.support_email %}<span>{% trans "Support:" %} <a href="mailto:{{ site.support_email }}">{{ site.support_email }}</a></span>{% endif %}
            </div>
            <div class="site-footer-links">
                <a href="https://github.com/gilliankerr/KoNote" target="_blank" rel="noopener">GitHub</a>
                <a href="{% url 'privacy' %}">{% trans "Privacy" %}</a>
                <a href="{% url 'help' %}">{% trans "Help" %}</a>
                <button type="button" class="keyboard-shortcuts-btn" id="show-shortcuts" aria-label="{% trans 'Keyboard shortcuts' %}">?</button>
                {% include "_lang_toggle.html" with inline=True form_class="footer-lang-form" %}
            </div>
            {% if user.is_authenticated %}
            <div class="site-footer-session">
                <span>{% trans "Logged in as" %} {{ user.display_name|default:user.username }}</span>
                <span class="session-timer" id="session-timer" data-timeout="{{ session_timeout_minutes|default:30 }}" data-warn="{% trans "Your login expires in {mins} minute(s)" %}" data-urgent="{% trans "You'll be logged out in {mins} minute(s)" %}" aria-live="polite" aria-atomic="true" hidden>
                    <span id="session-message"></span>
                </span>
                <button type="button" id="extend-session" class="extend-session-btn" hidden aria-label="{% trans 'Stay logged in' %}">{% trans "Stay logged in" %}</button>
            </div>
            {% endif %}
        </div>
    </footer>

    <!-- Keyboard shortcuts modal -->
    <div class="modal-backdrop" id="shortcuts-backdrop" hidden></div>
    <div class="keyboard-shortcuts-modal" id="shortcuts-modal" hidden role="dialog" aria-labelledby="shortcuts-title" aria-modal="true" tabindex="-1">
        <button type="button" class="modal-close" id="close-shortcuts" aria-label="{% trans 'Close' %}">&times;</button>
        <h2 id="shortcuts-title">{% trans "Keyboard Shortcuts" %}</h2>
        <dl>
            <dt>/</dt>
            <dd>{% trans "Focus search" %}</dd>
            <dt>g h</dt>
            <dd>{% trans "Go to Home" %}</dd>
            <dt>g m</dt>
            <dd>{% trans "Go to Meetings" %}</dd>
            <dt>n</dt>
            <dd>{% blocktrans with client=term.client %}New quick note (on {{ client }} page){% endblocktrans %}</dd>
            <dt>Ctrl+S</dt>
            <dd>{% trans "Save current form" %}</dd>
            <dt>Esc</dt>
            <dd>{% trans "Close modal / Cancel" %}</dd>
            <dt>?</dt>
            <dd>{% trans "Show this help" %}</dd>
        </dl>
    </div>

    <!-- HTMX — dynamic interactions without a JS framework -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <!-- Chart.js — for analysis charts (loaded globally for HTMX compatibility) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <!-- Translated strings for app.js (I18N-4) -->
    <script>
    window.KN = {
        dismissMessage: "{% trans 'Dismiss message' %}",
        errorGeneric: "{% trans 'Something went wrong. Please try again.' %}",
        error403: "{% trans "You don't have permission to do that." %}",
        error404: "{% trans 'The requested item was not found.' %}",
        error500: "{% trans 'A server error occurred. Please try again later.' %}",
        errorNetwork: "{% trans 'Could not connect to the server. Check your internet connection.' %}",
        justNow: "{% trans 'just now' %}",
        oneMinuteAgo: "{% trans '1 minute ago' %}",
        minutesAgo: "{% trans '{n} minutes ago' %}",
        oneHourAgo: "{% trans '1 hour ago' %}",
        hoursAgo: "{% trans '{n} hours ago' %}",
        earlier: "{% trans 'earlier' %}",
        draftFound: "{% trans 'Draft found' %}",
        unsavedWork: "{% trans 'You have unsaved work from {time}.' %}",
        restoreDraft: "{% trans 'Restore draft' %}",
        discard: "{% trans 'Discard' %}",
        draftRestored: "{% trans 'Draft restored' %}",
        saving: "{% trans 'Saving…' %}",
        saved: "{% trans 'Saved' %}",
        unsavedWarning: "{% trans 'You have unsaved changes. Are you sure you want to leave?' %}",
        loading: "{% trans 'Loading…' %}",
        resultsLoaded: "{% trans 'Results loaded.' %}",
        selected: "{% trans 'selected' %}",
        "on this page": "{% trans 'on this page' %}"
    };
    </script>
    <!-- App JS — CSRF handling, error handlers -->
    <script src="{% static 'js/app.js' %}"></script>
    <!-- Follow-up date picker — quick-pick chips for date inputs -->
    <script src="{% static 'js/followup-picker.js' %}"></script>

    <!-- Service worker — shows offline page when navigation fails (BUG-6) -->
    <script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js", { scope: "/" })
            .catch(function() { /* Service worker not critical */ });
    }
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
