{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktrans with note=term.progress_note|default:"Progress Note" %}New {{ note }}{% endblocktrans %} — {{ client.display_name }} {{ client.last_name }}{% endblock %}

{% block content %}
{% include "_breadcrumbs.html" %}
<hgroup>
    <h1>{% blocktrans with note=term.progress_note|default:"Progress Note" %}New {{ note }}{% endblocktrans %}</h1>
    <p>{{ client.display_name }} {{ client.last_name }}</p>
</hgroup>

<form method="post" data-autosave data-client-id="{{ client.pk }}" data-form-type="full">
    {% csrf_token %}

    <!-- Zone 1: Session Setup -->
    <fieldset class="session-setup" role="group" aria-label="{% trans 'Session setup' %}">
        <div class="session-setup-grid">
            <div class="field-template">
                <label for="{{ form.template.id_for_label }}">{% trans "Template" %}</label>
                {{ form.template }}
                {% if form.template.errors %}<small class="error" id="template-error" role="alert">{{ form.template.errors.0 }}</small>{% endif %}
                <div id="template-preview" aria-live="polite"></div>
            </div>
            <div class="field-interaction">
                <label for="{{ form.interaction_type.id_for_label }}">{% trans "Interaction type" %}</label>
                {{ form.interaction_type }}
                {% if form.interaction_type.errors %}<small class="error" id="interaction-type-error" role="alert">{{ form.interaction_type.errors.0 }}</small>{% endif %}
            </div>
            <div class="field-date">
                <label for="{{ form.session_date.id_for_label }}">{% trans "Session Date" %}</label>
                <input type="date" name="session_date" id="{{ form.session_date.id_for_label }}"
                       value="{{ form.session_date.value|default:'' }}"
                       hx-get="{% url 'notes:check_note_date' client_id=client.pk %}"
                       hx-trigger="change delay:300ms"
                       hx-target="#duplicate-note-warning"
                       hx-include="[name='session_date']">
                <small id="session-date-help">{{ form.session_date.help_text }}</small>
                {% if form.session_date.errors %}<small class="error" id="session-date-error" role="alert">{{ form.session_date.errors.0 }}</small>{% endif %}
                <div id="duplicate-note-warning" aria-live="polite"></div>
            </div>
        </div>
    </fieldset>

    <!-- Target selection — staff pick which targets they worked on -->
    {% if target_forms %}
    <fieldset>
        <legend>{% blocktrans with targets=term.target_plural|default:"targets" %}Which {{ targets }} did you work on?{% endblocktrans %}</legend>
        <small>{% blocktrans with targets=term.target_plural|default:"targets" %}Tick the {{ targets }} you want to record against. Only selected ones will appear below.{% endblocktrans %}</small>
        {% for tf in target_forms %}
        <label class="checkbox-item">
            <input type="checkbox" class="target-selector" data-target-id="{{ tf.target.pk }}">
            <span class="checkbox-label-text">
                {{ tf.target.name }}
                <small class="secondary">{{ tf.target.plan_section.name }}</small>
            </span>
        </label>
        {% endfor %}
    </fieldset>

    <!-- Zone 2: Target cards — compact by default, expandable -->
    <h2>{{ term.target_plural|default:"Targets" }}</h2>
    {% for tf in target_forms %}
    <div id="target-card-{{ tf.target.pk }}" class="target-card compact" hidden data-target-id="{{ tf.target.pk }}">
        {{ tf.note_form.target_id }}

        <div class="target-card-header" role="button" tabindex="0"
             aria-expanded="false" aria-controls="target-card-body-{{ tf.target.pk }}">
            <div class="target-card-title">
                <strong>{{ tf.target.name }}</strong>
                <span class="target-section-name">— {{ tf.target.plan_section.name }}</span>
            </div>
            <div class="target-card-actions">
                <button type="button" class="no-change-btn outline secondary"
                        data-target-id="{{ tf.target.pk }}"
                        aria-label="{% trans 'Mark as no change' %}">
                    {% trans "No change" %}
                </button>
                <button type="button" class="expand-btn outline secondary"
                        data-target-id="{{ tf.target.pk }}"
                        aria-label="{% trans 'Edit target:' %} {{ tf.target.name }}" hidden>
                    {% trans "Edit" %}
                </button>
                <span class="expand-indicator" aria-hidden="true">&#9662;</span>
            </div>
        </div>

        <!-- Compact: always visible — descriptor pills -->
        <div class="target-card-compact">
            {% if tf.target.client_goal %}
            <div class="client-goal-callout" role="note">
                <strong>{% trans "What did they say about this?" %}</strong> "{{ tf.target.client_goal }}"
            </div>
            {% endif %}

            <label>{% trans "How are things going?" %}</label>
            <div class="descriptor-pills">
            {% for radio in tf.note_form.progress_descriptor %}
                {% if radio.choice_value %}
                <label>{{ radio.tag }}<span>{{ radio.choice_label }}</span></label>
                {% endif %}
            {% endfor %}
            </div>
            {% if tf.note_form.progress_descriptor.help_text %}<small>{{ tf.note_form.progress_descriptor.help_text }}</small>{% endif %}
            {% if tf.note_form.progress_descriptor.errors %}<small class="error" id="descriptor-error-{{ tf.target.pk }}" role="alert">{{ tf.note_form.progress_descriptor.errors.0 }}</small>{% endif %}
        </div>

        <!-- Expanded: hidden until card is expanded -->
        <div id="target-card-body-{{ tf.target.pk }}" class="target-card-body" hidden>
            {% if tf.metric_forms %}
            <div class="target-metrics">
            {% for mf in tf.metric_forms %}
                {{ mf.metric_def_id }}
                {% if mf.auto_calc_value != None %}
                <div class="auto-calc-metric">
                    <span class="badge outline" aria-label="{{ mf.value.label }}: {{ mf.auto_calc_value }}, {% trans 'auto-calculated' %}">
                        {{ mf.value.label }}: <strong>{{ mf.auto_calc_value }}</strong> <small class="secondary">({% trans "auto-calculated" %})</small>
                    </span>
                </div>
                {% elif mf.is_achievement %}
                <div class="achievement-metric">
                    <label>{{ mf.value.label }}</label>
                    <div class="achievement-pills">
                    {% for radio in mf.value %}
                        {% if radio.choice_value %}
                        <label>{{ radio.tag }}<span>{{ radio.choice_label }}</span></label>
                        {% endif %}
                    {% endfor %}
                    </div>
                    {% if mf.value.help_text %}<small>{{ mf.value.help_text }}</small>{% endif %}
                    {% if mf.value.errors %}<small class="error" role="alert">{{ mf.value.errors.0 }}</small>{% endif %}
                </div>
                {% elif mf.is_scale %}
                <div class="scale-metric">
                    <label>{{ mf.value.label }}</label>
                    <div class="scale-pills">
                    {% for radio in mf.value %}
                        {% if radio.choice_value %}
                        <label>{{ radio.tag }}<span>{{ radio.choice_label }}</span></label>
                        {% endif %}
                    {% endfor %}
                    </div>
                    {% if mf.value.help_text %}<small>{{ mf.value.help_text }}</small>{% endif %}
                    {% if mf.value.errors %}<small class="error" role="alert">{{ mf.value.errors.0 }}</small>{% endif %}
                </div>
                {% else %}
                <label for="{{ mf.value.id_for_label }}">{{ mf.value.label }}</label>
                {{ mf.value }}
                {% if mf.value.help_text %}<small>{{ mf.value.help_text }}</small>{% endif %}
                {% if mf.value.errors %}<small class="error" id="metric-error-{{ forloop.counter }}-{{ tf.target.pk }}" role="alert">{{ mf.value.errors.0 }}</small>{% endif %}
                {% endif %}
            {% endfor %}
            </div>
            {% endif %}

            <label for="{{ tf.note_form.client_words.id_for_label }}">{% trans "What did they say about this?" %}</label>
            {{ tf.note_form.client_words }}
            {% if tf.note_form.client_words.help_text %}<small>{{ tf.note_form.client_words.help_text }}</small>{% endif %}
            {% if tf.note_form.client_words.errors %}<small class="error" id="client-words-error-{{ tf.target.pk }}" role="alert">{{ tf.note_form.client_words.errors.0 }}</small>{% endif %}

            <label for="{{ tf.note_form.notes.id_for_label }}">{% blocktrans with target=term.target|default:"target" %}Your notes for this {{ target }}{% endblocktrans %}</label>
            {{ tf.note_form.notes }}
            {% if tf.note_form.notes.errors %}<small class="error" id="notes-error-{{ tf.target.pk }}" role="alert">{{ tf.note_form.notes.errors.0 }}</small>{% endif %}
        </div>

        <!-- Done indicator (hidden until "No change" is clicked) -->
        <div class="target-done-indicator" hidden aria-live="polite">
            <span aria-hidden="true">&#10003;</span> {% trans "No change noted" %}
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="empty-state">{% blocktrans with targets=term.target_plural|default:"targets" %}No active {{ targets }} found.{% endblocktrans %} <a href="{% url 'plans:plan_view' client_id=client.pk %}">{% trans "Create a plan" %}</a> {% trans "first." %}</p>
    {% endif %}

    <!-- Zone 3: The Session Overall (Two-Lens Layout) -->
    <fieldset class="session-overall" role="group" aria-labelledby="session-overall-legend">
        <legend id="session-overall-legend" class="sr-only">{% trans "The session overall" %}</legend>
        <h2 aria-hidden="true">{% trans "The session overall" %}</h2>
        
        <div class="two-lens-grid">
            <!-- Left Lens: Their Perspective -->
            <div class="lens-participant">
                <h3>{% trans "Their perspective" %}</h3>

                <fieldset class="alliance-fieldset">
                    <legend>{% trans "Working relationship check-in" %}</legend>
                    <small class="alliance-intro">{% trans "Ratings of 1–3 are normal and helpful — they tell you what to adjust." %}</small>
                    <div class="alliance-pills" role="radiogroup" aria-label="{% trans 'Working relationship rating' %}">
                    {% for radio in form.alliance_rating %}
                        {% if radio.choice_value %}
                        <label class="alliance-anchor">{{ radio.tag }}<span>{{ radio.choice_label }}</span></label>
                        {% endif %}
                    {% endfor %}
                        <label class="alliance-anchor alliance-skip">
                            <input type="radio" name="alliance_rating" value=""><span>{% trans "Skip today" %}</span>
                        </label>
                    </div>
                    <div class="alliance-rater-row">
                        <small>{% trans "Who rated?" %}</small>
                        {% for radio in form.alliance_rater %}
                            {% if radio.choice_value %}
                            <label>{{ radio.tag }}<span>{{ radio.choice_label }}</span></label>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% if form.alliance_rating.errors %}<small class="error" role="alert">{{ form.alliance_rating.errors.0 }}</small>{% endif %}
                </fieldset>

                <label for="{{ form.participant_reflection.id_for_label }}">
                    {% trans "How did they feel about today's session?" %}
                </label>
                {{ form.participant_reflection }}
                {% if form.participant_reflection.errors %}<small class="error" id="reflection-error" role="alert">{{ form.participant_reflection.errors.0 }}</small>{% endif %}

                <label for="{{ form.participant_suggestion.id_for_label }}">{% trans "Anything they'd change about the program?" %}</label>
                {{ form.participant_suggestion }}
                {% if form.participant_suggestion.errors %}<small class="error" id="suggestion-error" role="alert">{{ form.participant_suggestion.errors.0 }}</small>{% endif %}

                <div class="suggestion-priority-row" id="suggestion-priority-row" hidden>
                    <label for="{{ form.suggestion_priority.id_for_label }}">{% trans "Priority" %}</label>
                    {{ form.suggestion_priority }}
                    <small>{% trans "Urgent = safety/access · Important = affects many · Worth exploring = good idea · Noted = heard and recorded" %}</small>
                    {% if form.suggestion_priority.errors %}<small class="error" id="priority-error" role="alert">{{ form.suggestion_priority.errors.0 }}</small>{% endif %}
                </div>
            </div>

            <!-- Right Lens: Your Observations -->
            <div class="lens-staff">
                <h3>{% trans "Your observations" %}</h3>
                
                <fieldset class="engagement-fieldset">
                    <legend>{% trans "Engagement" %}</legend>
                    <div class="engagement-pills" role="radiogroup" aria-label="{% trans 'Participant engagement level' %}">
                    {% for radio in form.engagement_observation %}
                        {% if radio.choice_value %}
                        <label class="{% if radio.choice_value == 'no_interaction' %}pill-separated{% endif %}">
                            {{ radio.tag }}<span>{{ radio.choice_label }}</span>
                        </label>
                        {% endif %}
                    {% endfor %}
                    </div>
                    <small>{% trans "Your observation, not a score." %}</small>
                    {% if form.engagement_observation.errors %}<small class="error" id="engagement-error" role="alert">{{ form.engagement_observation.errors.0 }}</small>{% endif %}
                </fieldset>

                <label for="{{ form.summary.id_for_label }}">{% trans "Session notes (optional)" %}</label>
                {{ form.summary }}
                {% if form.summary.errors %}<small class="error" id="summary-error" role="alert">{{ form.summary.errors.0 }}</small>{% endif %}
            </div>
        </div>
    </fieldset>

    <!-- Zone 4: Follow-up -->
    <fieldset class="session-followup">
        <legend class="sr-only">{% trans "Follow-up" %}</legend>
        <div class="field-followup">
            <label for="{{ form.follow_up_date.id_for_label }}">{% trans "Follow up by" %}</label>
            {{ form.follow_up_date }}
            <small>{% trans "(optional — adds to your home page reminders)" %}</small>
            {% if form.follow_up_date.errors %}<small class="error" id="follow-up-error" role="alert">{{ form.follow_up_date.errors.0 }}</small>{% endif %}
        </div>
    </fieldset>

    <!-- Sticky footer with confirmation and save -->
    <div class="sticky-form-footer" role="region" aria-label="{% trans 'Confirm and save' %}">
        <div class="sticky-form-footer-inner">
            <div class="completeness-indicator" aria-live="polite">
                <span id="completeness-text">✓ 0 {% trans "of" %} 0 {% trans "targets" %}</span>
            </div>
            <span class="autosave-indicator" id="autosave-status" hidden aria-live="polite" role="status">
                <span class="status-text">{% trans "Saved" %}</span>
            </span>
            <div class="button-group">
                <a href="{% url 'notes:note_list' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Cancel" %}</a>
                <button type="submit">{% blocktrans with note=term.progress_note|default:"Note" %}Save {{ note }}{% endblocktrans %}</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
{{ template_defaults|json_script:"template-defaults" }}
<script>
// Show/hide target cards based on checkbox selection
document.querySelectorAll(".target-selector").forEach(function (cb) {
    cb.addEventListener("change", function () {
        var targetId = this.getAttribute("data-target-id");
        var card = document.getElementById("target-card-" + targetId);
        if (card) {
            card.hidden = !this.checked;
        }
    });
});

// Target card expand/collapse
document.querySelectorAll(".target-card-header").forEach(function (header) {
    function toggle() {
        var card = header.closest(".target-card");
        var body = card.querySelector(".target-card-body");
        var isExpanded = !body.hidden;
        body.hidden = isExpanded;
        header.setAttribute("aria-expanded", !isExpanded);
        card.classList.toggle("compact", isExpanded);
        card.classList.toggle("expanded", !isExpanded);
        if (!isExpanded) {
            var firstInput = body.querySelector("input, textarea, select, [tabindex]");
            if (firstInput) firstInput.focus();
        }
    }
    header.addEventListener("click", function (e) {
        if (!e.target.closest(".no-change-btn")) toggle();
    });
    header.addEventListener("keydown", function (e) {
        if ((e.key === "Enter" || e.key === " ") && !e.target.closest(".no-change-btn")) {
            e.preventDefault();
            toggle();
        }
    });
});

// "No change" shortcut
document.querySelectorAll(".no-change-btn").forEach(function (btn) {
    btn.addEventListener("click", function (e) {
        e.stopPropagation();
        var card = btn.closest(".target-card");
        var targetId = btn.getAttribute("data-target-id");
        // Set descriptor to "holding" (Holding steady)
        var holdingRadio = card.querySelector(
            'input[name="target_' + targetId + '-progress_descriptor"][value="holding"]'
        );
        if (holdingRadio) holdingRadio.checked = true;
        
        // Collapse into single-line strip
        card.classList.add("collapsed-done");
        
        // Hide the card body
        var body = card.querySelector(".target-card-body");
        if (body) body.hidden = true;
        card.classList.remove("expanded");
        card.classList.add("compact");
        var header = card.querySelector(".target-card-header");
        if (header) header.setAttribute("aria-expanded", "false");
        
        updateCompleteness();
    });
});

// "Edit" button on collapsed strip
document.querySelectorAll(".expand-btn").forEach(function (btn) {
    btn.addEventListener("click", function (e) {
        e.stopPropagation();
        var card = btn.closest(".target-card");
        card.classList.remove("collapsed-done");
        
        // Expand the card body
        var body = card.querySelector(".target-card-body");
        if (body) body.hidden = false;
        card.classList.add("expanded");
        card.classList.remove("compact");
        var header = card.querySelector(".target-card-header");
        if (header) header.setAttribute("aria-expanded", "true");
        
        updateCompleteness();
    });
});

// Completeness Indicator Logic
function updateCompleteness() {
    var indicator = document.getElementById("completeness-text");
    if (!indicator) return;
    
    var selectedTargets = document.querySelectorAll(".target-selector:checked").length;
    var completedTargets = 0;
    
    document.querySelectorAll(".target-card:not([hidden])").forEach(function(card) {
        // A target is complete if it's collapsed-done OR if it has a progress descriptor selected
        var isCollapsed = card.classList.contains("collapsed-done");
        var hasDescriptor = card.querySelector('.descriptor-pills input[type="radio"]:checked');
        if (isCollapsed || hasDescriptor) {
            completedTargets++;
        }
    });
    
    indicator.textContent = "✓ " + completedTargets + " {% trans 'of' %} " + selectedTargets + " {% trans 'targets' %}";
    
    var container = indicator.closest(".completeness-indicator");
    if (container) {
        if (selectedTargets > 0 && completedTargets === selectedTargets) {
            container.classList.add("complete");
        } else {
            container.classList.remove("complete");
        }
    }
}

// Listen for changes to target selection and radio buttons to update completeness
document.querySelectorAll(".target-selector").forEach(function (cb) {
    cb.addEventListener("change", updateCompleteness);
});
document.querySelectorAll('.target-card input[type="radio"]').forEach(function (radio) {
    radio.addEventListener("change", updateCompleteness);
});

// Initial completeness check
updateCompleteness();

// Show priority dropdown only when suggestion has content
var suggestionField = document.querySelector('[name="participant_suggestion"]');
var priorityRow = document.getElementById('suggestion-priority-row');
if (suggestionField && priorityRow) {
    function togglePriority() { priorityRow.hidden = !suggestionField.value.trim(); }
    suggestionField.addEventListener('input', togglePriority);
    togglePriority(); // Handle pre-filled values on page load
}

// Auto-fill interaction type from template's default + preview (UX-PREVIEW1)
var templateSelect = document.querySelector('[name="template"]');
var interactionSelect = document.querySelector('[name="interaction_type"]');
var defaultsEl = document.getElementById("template-defaults");
var previewEl = document.getElementById("template-preview");
if (templateSelect && interactionSelect && defaultsEl) {
    var templateDefaults = JSON.parse(defaultsEl.textContent);
    templateSelect.addEventListener("change", function () {
        var tmplId = this.value;
        if (tmplId && templateDefaults[tmplId]) {
            interactionSelect.value = templateDefaults[tmplId];
        }
        // Fetch template preview
        if (tmplId && previewEl) {
            fetch("{% url 'notes:template_preview' template_id=0 %}".replace("/0/preview/", "/" + tmplId + "/preview/"), {
                headers: {"HX-Request": "true"}
            }).then(function (r) { return r.text(); })
              .then(function (html) { previewEl.innerHTML = html; });
        } else if (previewEl) {
            previewEl.innerHTML = "";
        }
    });
}
</script>
{% endblock %}
