{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ profile.name }} — {% trans "Report Template" %} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{{ profile.name }}</h1>
    <p>{% if profile.description %}{{ profile.description }}{% else %}{% trans "Reporting template" %}{% endif %}</p>
</hgroup>

<div class="grid" style="margin-bottom: 1.5rem;">
    <article>
        <header>{% trans "Details" %}</header>
        <dl>
            <dt>{% trans "Created" %}</dt>
            <dd>{{ profile.created_at|date:"Y-m-d H:i" }}{% if profile.created_by %} {% trans "by" %} {{ profile.created_by.display_name }}{% endif %}</dd>
            <dt>{% trans "Breakdowns" %}</dt>
            <dd>{{ profile.breakdowns.count }}</dd>
            <dt>{% trans "Outcome Metrics" %}</dt>
            <dd>{{ profile.report_metrics.count }}</dd>
            <dt>{% trans "Partner" %}</dt>
            <dd>
                {% if profile.partner %}
                    <a href="{% url 'admin_settings:partner_detail' profile.partner.pk %}">{{ profile.partner.name }}</a>
                    {% if profile.partner.programs.all %}
                        <br><small class="secondary">{% trans "Programs" %}: {% for p in profile.partner.programs.all %}{{ p.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</small>
                    {% endif %}
                {% else %}
                    <em>{% trans "No partner assigned" %}</em>
                {% endif %}
            </dd>
        </dl>
    </article>
</div>

<h2>{% trans "Demographic Breakdowns" %}</h2>

{% for bd in profile.breakdowns.all %}
<article>
    <header>
        <strong>{{ bd.label }}</strong>
        <small class="secondary"> —
            {% if bd.source_type == "age" %}
                {% trans "Age-based" %}
            {% elif bd.source_type == "custom_field" %}
                {% trans "Custom field" %}{% if bd.custom_field %}: {{ bd.custom_field.name }}{% endif %}
            {% endif %}
        </small>
    </header>

    {% if bd.bins_json %}
    <p><strong>{% trans "Age Bins" %}</strong></p>
    <table>
        <thead>
            <tr><th>{% trans "Label" %}</th><th>{% trans "Min Age" %}</th><th>{% trans "Max Age" %}</th></tr>
        </thead>
        <tbody>
            {% for bin in bd.bins_json %}
            <tr><td>{{ bin.label }}</td><td>{{ bin.min }}</td><td>{{ bin.max }}</td></tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if bd.merge_categories_json %}
    <p><strong>{% trans "Category Merging" %}</strong></p>
    <table>
        <thead>
            <tr><th>{% trans "Report As" %}</th><th>{% trans "Includes" %}</th></tr>
        </thead>
        <tbody>
            {% for target, sources in bd.merge_categories_json.items %}
            <tr><td><strong>{{ target }}</strong></td><td>{{ sources|join:", " }}</td></tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if bd.keep_all_categories %}
    <p><small>{% trans "Unmatched categories will be kept as-is (not merged into 'Other')." %}</small></p>
    {% endif %}
</article>
{% empty %}
<p>{% trans "No breakdowns defined." %}</p>
{% endfor %}

<h2>{% trans "Outcome Metrics" %}</h2>

{% for rm in profile.report_metrics.all %}
<article>
    <header>
        <strong>{{ rm.display_label|default:rm.metric_definition.name }}</strong>
        <small class="secondary"> — {{ rm.get_aggregation_display }}</small>
    </header>
    {% if rm.display_label and rm.display_label != rm.metric_definition.name %}
    <p style="margin-bottom: 0.25rem;"><small>{% trans "Source metric" %}: {{ rm.metric_definition.name }}</small></p>
    {% endif %}
    {% if rm.threshold_value %}
    <p style="margin-bottom: 0;"><small>{% trans "Threshold" %}: {{ rm.threshold_value }}</small></p>
    {% endif %}
</article>
{% empty %}
<article aria-label="{% trans 'No metrics configured' %}" style="background: var(--kn-warning-bg); border-left: 4px solid var(--kn-warning-fg); padding: 1rem;">
    <strong><span aria-hidden="true">⚠️</span> {% trans "No outcome metrics configured" %}</strong>
    <p style="margin-bottom: 0;">
        {% trans "This template has no specific metrics defined. Reports using this template will include all metrics with data. To limit which metrics appear, add metrics via the Django admin." %}
    </p>
</article>
{% endfor %}

<div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
    {% if profile.partner %}<a href="{% url 'admin_settings:partner_detail' profile.partner.pk %}" role="button" class="outline">{% trans "View Partner" %}</a>{% endif %}
    <a href="{% url 'admin_settings:report_template_download_csv' profile.pk %}" role="button" class="outline secondary">{% trans "Download CSV" %}</a>
    <a href="{% url 'admin_settings:report_template_delete' profile.pk %}" role="button" class="outline" style="color: var(--kn-danger-fg); border-color: var(--kn-danger-fg);">{% trans "Delete Template" %}</a>
</div>

<p style="margin-top: 1.5rem;"><a href="{% url 'admin_settings:report_template_list' %}">{% trans "← Back to Templates" %}</a></p>
{% endblock %}
