{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Instance Settings" %} â€” {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% trans "Instance Settings" %}</h1>
    <p>{% trans "Configure branding, date format, and session behaviour." %}</p>
</hgroup>

<form method="post">
    {% csrf_token %}

    <fieldset>
        <legend>{% trans "Access Tier" %}</legend>
        <p><small>{% trans "Controls which advanced permission features are active. The baseline role matrix (front desk, worker, manager, executive) is always enforced at every tier." %}</small></p>

        <div class="access-tier-options">
            {% for radio in form.access_tier %}
            <label class="tier-option">
                {{ radio.tag }}
                <strong>{{ radio.choice_label }}</strong>
                {% if radio.data.value == "1" %}
                <br><small>{% trans "Everyone on the team sees what they need for their role. Good for programs where data is non-sensitive and the team is small. Front desk still cannot see clinical notes. Executives see aggregate data only." %}</small>
                {% elif radio.data.value == "2" %}
                <br><small>{% trans "Different roles see different things, and you can configure exactly which fields front desk can see or edit. Good for agencies with distinct front desk, worker, and manager functions. DV-safe mode is available." %}</small>
                {% elif radio.data.value == "3" %}
                <br><small>{% trans "Additional protections for clinical and safety-sensitive data. Program managers must document why they need to view clinical notes, with time-limited access. DV-safe mode is prompted during setup." %}</small>
                {% endif %}
            </label>
            {% endfor %}
        </div>
        {% if form.access_tier.errors %}
        <small class="badge badge-danger">{{ form.access_tier.errors.0 }}</small>
        {% endif %}
    </fieldset>

    <fieldset>
        <legend>{% trans "Branding & Display" %}</legend>
        {% for field in form %}
            {% if field.name == "product_name" or field.name == "product_name_fr" or field.name == "support_email" or field.name == "logo_url" or field.name == "date_format" or field.name == "session_timeout_minutes" %}
            <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}<abbr title="{% trans 'required' %}">*</abbr>{% endif %}
            </label>
            {{ field }}
            {% if field.help_text %}<small>{{ field.help_text }}</small>{% endif %}
            {% if field.errors %}
            <small class="badge badge-danger">{{ field.errors.0 }}</small>
            {% endif %}
            {% endif %}
        {% endfor %}
    </fieldset>

    <fieldset>
        <legend>{% trans "Document Storage" %}</legend>
        <p><small>{% trans 'Connect to an external document storage system (SharePoint or Google Drive) to show a "Open Documents Folder" button on participant records.' %}</small></p>

        {% for field in form %}
            {% if field.name == "document_storage_provider" or field.name == "document_storage_url_template" %}
            <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}<abbr title="{% trans 'required' %}">*</abbr>{% endif %}
            </label>
            {{ field }}
            {% if field.help_text %}<small>{{ field.help_text }}</small>{% endif %}
            {% if field.errors %}
            <small class="badge badge-danger">{{ field.errors.0 }}</small>
            {% endif %}
            {% endif %}
        {% endfor %}

        <div id="test-url-container" style="margin-top: 1rem;">
            <a id="test-url-link"
               href="#"
               target="_blank"
               rel="noopener noreferrer"
               role="button"
               class="outline secondary"
               style="display: none;">
                {% trans "Test with sample Record ID: REC-2024-001" %}
            </a>
        </div>
    </fieldset>

    <fieldset>
        <legend>{% trans "Privacy Officer" %}</legend>
        <p><small>{% trans "Contact details displayed in privacy notices, erasure communications, and data access responses (PIPEDA compliance)." %}</small></p>

        {% for field in form %}
            {% if field.name == "privacy_officer_name" or field.name == "privacy_officer_email" %}
            <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}<abbr title="{% trans 'required' %}">*</abbr>{% endif %}
            </label>
            {{ field }}
            {% if field.help_text %}<small>{{ field.help_text }}</small>{% endif %}
            {% if field.errors %}
            <small class="badge badge-danger">{{ field.errors.0 }}</small>
            {% endif %}
            {% endif %}
        {% endfor %}
    </fieldset>

    <fieldset>
        <legend>{% trans "Participant Portal" %}</legend>
        <p><small>{% trans "Settings for the participant-facing portal." %}</small></p>

        {% for field in form %}
            {% if field.name == "portal_footer_text" or field.name == "portal_footer_text_fr" or field.name == "portal_safe_exit_url" %}
            <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}<abbr title="{% trans 'required' %}">*</abbr>{% endif %}
            </label>
            {{ field }}
            {% if field.help_text %}<small>{{ field.help_text }}</small>{% endif %}
            {% if field.errors %}
            <small class="badge badge-danger">{{ field.errors.0 }}</small>
            {% endif %}
            {% endif %}
        {% endfor %}
    </fieldset>

    <fieldset>
        <legend>{% trans "Meetings" %}</legend>
        <p><small>{% trans "Configure the location options and time slots shown when scheduling meetings." %}</small></p>

        {% for field in form %}
            {% if field.name == "meeting_location_options" or field.name == "meeting_time_start" or field.name == "meeting_time_end" or field.name == "meeting_time_step" %}
            <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}<abbr title="{% trans 'required' %}">*</abbr>{% endif %}
            </label>
            {{ field }}
            {% if field.help_text %}<small>{{ field.help_text }}</small>{% endif %}
            {% if field.errors %}
            <small class="badge badge-danger">{{ field.errors.0 }}</small>
            {% endif %}
            {% endif %}
        {% endfor %}
    </fieldset>

    <div role="group">
        <button type="submit">{% trans "Save Changes" %}</button>
        <a href="{% url 'admin_settings:dashboard' %}" role="button" class="outline">{% trans "Back" %}</a>
    </div>
</form>

<script>
(function() {
    const providerSelect = document.getElementById('id_document_storage_provider');
    const templateInput = document.getElementById('id_document_storage_url_template');
    const testLink = document.getElementById('test-url-link');
    const sampleRecordId = 'REC-2024-001';

    function updateTestLink() {
        const provider = providerSelect.value;
        const template = templateInput.value.trim();

        if (provider === 'none' || !template) {
            testLink.style.display = 'none';
            return;
        }

        const testUrl = template.replace('{record_id}', sampleRecordId);
        testLink.href = testUrl;
        testLink.style.display = 'inline-block';
    }

    providerSelect.addEventListener('change', updateTestLink);
    templateInput.addEventListener('input', updateTestLink);

    // Initial state
    updateTestLink();
})();
</script>
{% endblock %}
