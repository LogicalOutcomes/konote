{% load i18n %}
<!-- Partial: Plan tab content -->

{# ── Action bar (editors only) ── #}
{% if can_edit and active_service_model != "group" %}
<div class="action-bar">
    {# Primary action: Add a Goal (always links to goal_create — AI built into that page) #}
    <a href="{% url 'plans:goal_create' client_id=client.pk %}" role="button">
        {% blocktrans with target=term.target|default:"Goal" %}Add a {{ target }}{% endblocktrans %}
    </a>

    {# Secondary actions (text links, only when plan already has content) #}
    {% if active_sections or inactive_sections %}
    <span class="action-bar-secondary">
        <a href="{% url 'plans:section_create' client_id=client.pk %}" class="secondary">
            {% blocktrans with section=term.section|default:"Section" %}Add {{ section }}{% endblocktrans %}
        </a>
        {% if can_apply_template %}
        <span aria-hidden="true">&middot;</span>
        <a href="{% url 'plan_templates:template_apply_list' client_id=client.pk %}" class="secondary">
            {% trans "Apply template" %}
        </a>
        {% endif %}
    </span>
    {% endif %}
</div>
{% elif not can_edit %}
<p class="notice" role="status">
    <small>{% blocktrans with client=term.client|default:"participant" program=term.program|default:"program" %}View only — you can see this plan because this {{ client }} is on your caseload, but editing requires a staff role in one of their enrolled {{ program }}s. Contact your administrator if you need edit access.{% endblocktrans %}</small>
</p>
{% endif %}

{# ── Section create form (if open) ── #}
{% if show_section_form %}
<article aria-label="{% trans 'Add section form' %}">
    <header><h2>{% blocktrans with section=term.section|default:"Section" %}Add {{ section }}{% endblocktrans %}</h2></header>
    <form method="post" action="{% url 'plans:section_create' client_id=client.pk %}">
        {% csrf_token %}
        {% for field in section_form %}
        <div class="form-row">
            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% if field.errors %}
            <small class="error" role="alert">{{ field.errors.0 }}</small>
            {% endif %}
        </div>
        {% endfor %}
        <div role="group">
            <button type="submit">{% trans "Save" %}</button>
            <a href="{% url 'plans:plan_view' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Cancel" %}</a>
        </div>
    </form>
</article>
{% endif %}

{# ── Active sections ── #}
{% if active_sections %}
{% if show_grouping and grouped_active_sections %}
{# Multi-program: group sections by program with colour headers #}
{% for program_id, group in grouped_active_sections.items %}
<div class="program-group" style="border-left: 3px solid {{ group.program.colour_hex|default:'var(--pico-muted-border-color)' }};">
    <h2 class="program-group-heading">
        <span class="program-dot" style="background-color: {{ group.program.colour_hex }}" aria-hidden="true"></span>
        {{ group.program.translated_name }}
    </h2>
    {% for section in group.sections %}
    <article class="section-card" id="section-{{ section.pk }}" aria-label="{{ term.section|default:'Section' }}: {{ section.name }}">
        {% include "plans/_section.html" with section=section can_edit=can_edit hide_program_dot=True %}
    </article>
    {% endfor %}
</div>
{% endfor %}
{% if general_sections %}
<div class="program-group">
    <h2 class="program-group-heading">{% trans "General" %}</h2>
    {% for section in general_sections %}
    <article class="section-card" id="section-{{ section.pk }}" aria-label="{{ term.section|default:'Section' }}: {{ section.name }}">
        {% include "plans/_section.html" with section=section can_edit=can_edit hide_program_dot=True %}
    </article>
    {% endfor %}
</div>
{% endif %}
{% else %}
{# Single program or specific CONF9: flat list, no group headers #}
{% for section in active_sections %}
<article class="section-card" id="section-{{ section.pk }}" aria-label="{{ term.section|default:'Section' }}: {{ section.name }}">
    {% include "plans/_section.html" with section=section can_edit=can_edit %}
</article>
{% endfor %}
{% endif %}
{% endif %}

{# ── Inactive sections ── #}
{% if inactive_sections %}
<details>
    <summary>{% blocktrans with sections=term.section_plural|default:"sections" count=inactive_sections|length %}Completed & deactivated {{ sections }} ({{ count }}){% endblocktrans %}</summary>
    {% for section in inactive_sections %}
    <article class="section-card" id="section-{{ section.pk }}" aria-label="{{ term.section|default:'Section' }}: {{ section.name }}">
        {% include "plans/_section.html" with section=section can_edit=can_edit %}
    </article>
    {% endfor %}
</details>
{% endif %}

{# ── Empty state ── #}
{% if not active_sections and not inactive_sections and not show_section_form %}
<div class="empty-state" role="status">
    {% if can_edit %}
    <p>{% blocktrans with client=client.display_name %}This is where you'll build {{ client }}'s plan together.{% endblocktrans %}</p>
    <p>{% trans "Start by adding their first goal." %}</p>
    <a href="{% url 'plans:goal_create' client_id=client.pk %}" role="button">
        {% blocktrans with target=term.target|default:"Goal" %}Add a {{ target }}{% endblocktrans %}
    </a>
    {% if can_apply_template %}
    <p><small><a href="{% url 'plan_templates:template_apply_list' client_id=client.pk %}" class="secondary">{% trans "Or start from a template" %}</a></small></p>
    {% endif %}
    {% else %}
    <p>{% blocktrans with client=client.display_name %}No plan has been created yet for {{ client }}.{% endblocktrans %}</p>
    {% endif %}
</div>
{% endif %}
