{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktrans with target=term.target|default:"Goal" %}Add {{ target }}{% endblocktrans %} — {{ client.display_name }} {{ client.last_name }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% blocktrans with target=term.target|default:"Goal" %}Add {{ target }}{% endblocktrans %}</h1>
    <p>{{ client.display_name }} {{ client.last_name }}</p>
</hgroup>

{% if ai_enabled %}
<aside class="goal-builder-banner" role="note">
    <p>
        {% blocktrans with target=term.target|default:"goal" %}Want help turning participant words into a measurable {{ target }}?{% endblocktrans %}
        <a href="{% url 'plans:plan_view' client_id=client.pk %}#goal-builder-container">{% trans "Use the Goal Builder" %}</a>
    </p>
</aside>
{% endif %}

{% if form.non_field_errors %}
<div class="error-summary" role="alert" id="error-summary" tabindex="-1">
    <strong>{% trans "Please fix the following:" %}</strong>
    <ul>
        {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
        {% for field in form %}
            {% if field.errors %}
            <li><a href="#{{ field.id_for_label }}">{{ field.label }}: {{ field.errors.0 }}</a></li>
            {% endif %}
        {% endfor %}
    </ul>
</div>
{% endif %}

<form method="post" id="goal-form" novalidate>
    {% csrf_token %}

    {# ── 1. Participant's words ── #}
    <fieldset>
        <legend>{{ form.client_goal.label }}</legend>
        <small>{{ form.client_goal.help_text }}</small>
        <input type="text"
               id="{{ form.client_goal.id_for_label }}"
               name="client_goal"
               value="{{ form.client_goal.value|default_if_none:'' }}"
               placeholder="{% trans 'In their own words…' %}"
               maxlength="255">
        {% if form.client_goal.errors %}
        <small class="error" role="alert">{{ form.client_goal.errors.0 }}</small>
        {% endif %}
    </fieldset>

    {# ── 2. Goal name with common cards + autocomplete ── #}
    <fieldset>
        <legend>{{ form.name.label }}</legend>
        <small>{{ form.name.help_text }}</small>

        {% if common_goals %}
        <div class="common-goal-cards" role="group" aria-label="{% trans 'Common goals in this program' %}">
            <small class="secondary">{% trans "Quick pick — tap to use an existing goal:" %}</small>
            <div class="goal-card-grid">
                {% for goal in common_goals %}
                <button type="button"
                        class="goal-card outline"
                        data-goal-name="{{ goal.name }}"
                        data-metric-id="{{ goal.metric_id|default:'' }}"
                        aria-label="{% blocktrans with name=goal.name count=goal.count %}Use {{ name }} ({{ count }} participants){% endblocktrans %}">
                    <strong>{{ goal.name }}</strong>
                    {% if goal.metric_name %}
                    <small>{{ goal.metric_name }}</small>
                    {% endif %}
                    <small class="secondary">
                        {% blocktrans count count=goal.count %}{{ count }} participant{% plural %}{{ count }} participants{% endblocktrans %}
                    </small>
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="goal-name-autocomplete">
            <input type="text"
                   id="{{ form.name.id_for_label }}"
                   name="name"
                   value="{{ form.name.value|default_if_none:'' }}"
                   placeholder="{% trans 'e.g., Find stable housing' %}"
                   maxlength="255"
                   required
                   autocomplete="off"
                   role="combobox"
                   aria-expanded="false"
                   aria-autocomplete="list"
                   aria-controls="goal-suggestions-list"
                   aria-activedescendant=""
                   data-suggestions-url="{% url 'plans:goal_name_suggestions' client_id=client.pk %}">
            <div id="goal-suggestions-list"
                 role="listbox"
                 aria-label="{% trans 'Goal name suggestions' %}"
                 hidden></div>
            <div aria-live="polite" class="sr-only" id="suggestion-count"></div>
        </div>
        {% if form.name.errors %}
        <small class="error" role="alert">{{ form.name.errors.0 }}</small>
        {% endif %}
    </fieldset>

    {# ── 3. Section picker ── #}
    <fieldset>
        <legend>{{ form.section_choice.label }}</legend>

        {% if preselected_section %}
        {# Pre-selected and locked #}
        <input type="hidden" name="section_choice" value="{{ preselected_section.pk }}">
        <input type="text" value="{{ preselected_section.name }}" disabled
               aria-label="{% trans 'Section (pre-selected)' %}">
        {% else %}
        <select id="{{ form.section_choice.id_for_label }}"
                name="section_choice"
                aria-controls="new-section-row"
                required>
            {% for value, label in form.section_choice.field.choices %}
            <option value="{{ value }}" {% if form.section_choice.value == value|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
        <div id="new-section-row"
             {% if form.section_choice.value != "new" %}hidden{% endif %}
             aria-expanded="{% if form.section_choice.value == 'new' %}true{% else %}false{% endif %}">
            <label for="{{ form.new_section_name.id_for_label }}">{% trans "New section name" %}</label>
            <input type="text"
                   id="{{ form.new_section_name.id_for_label }}"
                   name="new_section_name"
                   value="{{ form.new_section_name.value|default_if_none:'' }}"
                   placeholder="{% trans 'New section name' %}"
                   maxlength="255">
            {% if form.new_section_name.errors %}
            <small class="error" role="alert">{{ form.new_section_name.errors.0 }}</small>
            {% endif %}
        </div>
        {% endif %}
        {% if form.section_choice.errors %}
        <small class="error" role="alert">{{ form.section_choice.errors.0 }}</small>
        {% endif %}
    </fieldset>

    {# ── 4. Description ── #}
    <fieldset>
        <legend>{{ form.description.label }}</legend>
        <textarea id="{{ form.description.id_for_label }}"
                  name="description"
                  rows="3"
                  placeholder="{% trans 'SMART outcome or additional context' %}">{{ form.description.value|default_if_none:'' }}</textarea>
        {% if form.description.errors %}
        <small class="error" role="alert">{{ form.description.errors.0 }}</small>
        {% endif %}
    </fieldset>

    {# ── 5. Metric picker — three tiers ── #}
    <fieldset>
        <legend>{{ form.metrics.label }}</legend>
        <small>{{ form.metrics.help_text }}</small>

        {# Tier 1: Universal metrics (always visible, card-style) #}
        {% if universal_metrics %}
        <div class="universal-metric-cards" role="group" aria-label="{% trans 'Universal metrics' %}">
            <small class="tier-label"><strong>{% trans "Recommended" %}</strong></small>
            {% for metric in universal_metrics %}
            <label class="metric-card" for="metric-{{ metric.pk }}">
                <input type="checkbox"
                       id="metric-{{ metric.pk }}"
                       name="metrics"
                       value="{{ metric.pk }}"
                       {% if metric.pk in selected_metric_ids %}checked{% endif %}>
                <div class="metric-card-body">
                    <strong>{{ metric.translated_name }}</strong>
                    <small>{{ metric.translated_definition }}</small>
                </div>
            </label>
            {% endfor %}
        </div>
        {% endif %}

        {# Tier 2: Used in this program (visible if any) #}
        {% if program_used_metrics %}
        <details class="metric-tier">
            <summary>{% trans "Used in this program" %}</summary>
            <div class="metric-tier-list" role="group" aria-label="{% trans 'Metrics used in this program' %}">
                {% for metric in program_used_metrics %}
                <label for="metric-{{ metric.pk }}">
                    <input type="checkbox"
                           id="metric-{{ metric.pk }}"
                           name="metrics"
                           value="{{ metric.pk }}"
                           {% if metric.pk in selected_metric_ids %}checked{% endif %}>
                    {{ metric.translated_name }}
                    <small class="secondary">
                        {% blocktrans with count=metric.usage_count %}used by {{ count }} participant(s){% endblocktrans %}
                    </small>
                </label>
                {% endfor %}
            </div>
        </details>
        {% endif %}

        {# Tier 3: All available metrics (collapsed with search) #}
        {% if metrics_by_category %}
        <details class="metric-tier">
            <summary>{% trans "All available metrics" %}</summary>
            <div class="metric-search-wrapper">
                <input type="search"
                       id="metric-search"
                       placeholder="{% trans 'Search metrics…' %}"
                       aria-label="{% trans 'Filter metrics by name' %}"
                       autocomplete="off">
                <div aria-live="polite" class="sr-only" id="metric-search-count"></div>
            </div>
            {% for category, metrics_list in metrics_by_category.items %}
            <fieldset class="metric-category" data-category="{{ category }}">
                <legend>{{ category }}</legend>
                {% for metric in metrics_list %}
                <label for="metric-{{ metric.pk }}" class="metric-search-item" data-name="{{ metric.translated_name|lower }}">
                    <input type="checkbox"
                           id="metric-{{ metric.pk }}"
                           name="metrics"
                           value="{{ metric.pk }}"
                           {% if metric.pk in selected_metric_ids %}checked{% endif %}>
                    {{ metric.translated_name }}
                    {% if metric.translated_definition %}
                    <small>{{ metric.translated_definition|truncatewords:15 }}</small>
                    {% endif %}
                </label>
                {% endfor %}
            </fieldset>
            {% endfor %}
        </details>
        {% endif %}

        {% if form.metrics.errors %}
        <small class="error" role="alert">{{ form.metrics.errors.0 }}</small>
        {% endif %}
    </fieldset>

    {# ── Submit ── #}
    <div role="group">
        <button type="submit">{% blocktrans with target=term.target|default:"Goal" %}Add {{ target }}{% endblocktrans %}</button>
        <a href="{% url 'plans:plan_view' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Cancel" %}</a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    "use strict";

    // --- Section picker: show/hide "Create new" field ---
    var sectionSelect = document.getElementById("{{ form.section_choice.id_for_label }}");
    var newSectionRow = document.getElementById("new-section-row");
    if (sectionSelect && newSectionRow) {
        sectionSelect.addEventListener("change", function() {
            var isNew = this.value === "new";
            newSectionRow.hidden = !isNew;
            newSectionRow.setAttribute("aria-expanded", isNew ? "true" : "false");
            if (isNew) {
                var nameInput = newSectionRow.querySelector("input[type=text]");
                if (nameInput) nameInput.focus();
            }
        });
    }

    // --- Common goal cards: pre-fill name + metric ---
    var goalCards = document.querySelectorAll(".goal-card");
    var nameInput = document.getElementById("{{ form.name.id_for_label }}");
    goalCards.forEach(function(card) {
        card.addEventListener("click", function() {
            if (nameInput) nameInput.value = this.dataset.goalName;
            // Pre-check the associated metric
            var metricId = this.dataset.metricId;
            if (metricId) {
                var cb = document.getElementById("metric-" + metricId);
                if (cb) cb.checked = true;
            }
            // Visual feedback
            goalCards.forEach(function(c) { c.classList.remove("selected"); });
            this.classList.add("selected");
        });
    });

    // --- Goal name autocomplete (load-once, filter client-side) ---
    var suggestionsLoaded = false;
    var allSuggestions = [];
    var suggestionsList = document.getElementById("goal-suggestions-list");
    var suggestionCount = document.getElementById("suggestion-count");
    var activeIndex = -1;

    function loadSuggestions() {
        if (suggestionsLoaded || !nameInput) return;
        var url = nameInput.dataset.suggestionsUrl;
        if (!url) return;
        fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest", "HX-Request": "true" } })
            .then(function(r) { return r.text(); })
            .then(function(html) {
                suggestionsList.innerHTML = html;
                allSuggestions = Array.from(suggestionsList.querySelectorAll("[role=option]"));
                suggestionsLoaded = true;
                filterSuggestions();
            });
    }

    function filterSuggestions() {
        if (!suggestionsLoaded) return;
        var query = (nameInput.value || "").toLowerCase().trim();
        var visibleCount = 0;
        activeIndex = -1;
        allSuggestions.forEach(function(opt) {
            var name = (opt.dataset.name || "").toLowerCase();
            var visible = query.length >= 2 && name.indexOf(query) !== -1;
            opt.hidden = !visible;
            opt.setAttribute("aria-selected", "false");
            if (visible) visibleCount++;
        });
        var show = visibleCount > 0;
        suggestionsList.hidden = !show;
        nameInput.setAttribute("aria-expanded", show ? "true" : "false");
        if (suggestionCount) {
            if (show) {
                suggestionCount.textContent = visibleCount + " " + (visibleCount === 1 ? "{% trans 'suggestion available' %}" : "{% trans 'suggestions available' %}");
            } else {
                suggestionCount.textContent = "";
            }
        }
    }

    function selectSuggestion(opt) {
        nameInput.value = opt.dataset.name;
        var metricId = opt.dataset.metricId;
        if (metricId) {
            var cb = document.getElementById("metric-" + metricId);
            if (cb) cb.checked = true;
        }
        closeSuggestions();
        nameInput.focus();
    }

    function closeSuggestions() {
        suggestionsList.hidden = true;
        nameInput.setAttribute("aria-expanded", "false");
        nameInput.setAttribute("aria-activedescendant", "");
        activeIndex = -1;
    }

    if (nameInput) {
        nameInput.addEventListener("input", function() {
            if (!suggestionsLoaded && this.value.length >= 2) {
                loadSuggestions();
            } else {
                filterSuggestions();
            }
        });
        nameInput.addEventListener("keydown", function(e) {
            var visible = allSuggestions.filter(function(s) { return !s.hidden; });
            if (!visible.length) return;
            if (e.key === "ArrowDown") {
                e.preventDefault();
                activeIndex = Math.min(activeIndex + 1, visible.length - 1);
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                activeIndex = Math.max(activeIndex - 1, 0);
            } else if (e.key === "Enter" && activeIndex >= 0) {
                e.preventDefault();
                selectSuggestion(visible[activeIndex]);
                return;
            } else if (e.key === "Escape") {
                closeSuggestions();
                return;
            } else {
                return;
            }
            visible.forEach(function(s, i) {
                s.setAttribute("aria-selected", i === activeIndex ? "true" : "false");
            });
            if (visible[activeIndex]) {
                nameInput.setAttribute("aria-activedescendant", visible[activeIndex].id);
                visible[activeIndex].scrollIntoView({ block: "nearest" });
            }
        });
        nameInput.addEventListener("blur", function() {
            // Delay to allow click on suggestion
            setTimeout(closeSuggestions, 300);
        });
    }
    if (suggestionsList) {
        suggestionsList.addEventListener("click", function(e) {
            var opt = e.target.closest("[role=option]");
            if (opt) selectSuggestion(opt);
        });
    }

    // --- Metric search/filter in Tier 3 ---
    var metricSearch = document.getElementById("metric-search");
    var metricSearchCount = document.getElementById("metric-search-count");
    if (metricSearch) {
        metricSearch.addEventListener("input", function() {
            var query = this.value.toLowerCase().trim();
            var items = document.querySelectorAll(".metric-search-item");
            var visibleCount = 0;
            items.forEach(function(item) {
                var name = item.dataset.name || "";
                var match = !query || name.indexOf(query) !== -1;
                item.hidden = !match;
                if (match) visibleCount++;
            });
            // Show/hide empty categories
            document.querySelectorAll(".metric-category").forEach(function(cat) {
                var hasVisible = cat.querySelector(".metric-search-item:not([hidden])");
                cat.hidden = !hasVisible;
            });
            if (metricSearchCount) {
                if (query) {
                    metricSearchCount.textContent = visibleCount + " " + (visibleCount === 1 ? "{% trans 'metric matches' %}" : "{% trans 'metrics match' %}");
                } else {
                    metricSearchCount.textContent = "";
                }
            }
        });
    }

    // --- Focus error summary on failed submission ---
    var errorSummary = document.getElementById("error-summary");
    if (errorSummary) errorSummary.focus();
})();
</script>
{% endblock %}
