{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktrans with target=term.target|default:"Goal" %}Add {{ target }}{% endblocktrans %} — {{ client.display_name }} {{ client.last_name }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% blocktrans with target=term.target|default:"Goal" %}Add {{ target }}{% endblocktrans %}</h1>
    <p>{{ client.display_name }} {{ client.last_name }}</p>
</hgroup>

{% if form.non_field_errors %}
<div class="error-summary" role="alert" id="error-summary" tabindex="-1">
    <strong>{% trans "Please fix the following:" %}</strong>
    <ul>
        {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
        {% for field in form %}
            {% if field.errors %}
            <li><a href="#{{ field.id_for_label }}">{{ field.label }}: {{ field.errors.0 }}</a></li>
            {% endif %}
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if ai_enabled %}
{# ====== Entry points (AI-assisted page) ====== #}
<div id="entry-points">

    {# ── AI-assisted path ── #}
    <fieldset id="ai-entry">
        <legend>{% blocktrans with client=term.client|default:"participant" %}What does the {{ client }} want to work on?{% endblocktrans %}</legend>
        <small>{% trans "Write what they said, in their own words." %}</small>
        <small class="secondary">
            {% trans "Names and personal details are removed before sending to AI." %}
        </small>
        <textarea id="participant-words"
                  name="participant_words"
                  rows="2"
                  placeholder="{% trans 'In their own words…' %}"
                  maxlength="1000"
                  aria-label="{% blocktrans with client=term.client|default:"participant" %}What does the {{ client }} want to work on?{% endblocktrans %}">{{ participant_words }}</textarea>
        <button type="button"
                id="btn-shape-target"
                hx-post="{% url 'ai:suggest_target' %}"
                hx-target="#suggestion-container"
                hx-swap="innerHTML"
                hx-indicator="#ai-loading"
                hx-include="#participant-words, #hidden-client-id"
                hx-disabled-elt="this">
            {% trans "Shape this target" %}
        </button>
        <input type="hidden" id="hidden-client-id"
               name="client_id" value="{{ client.pk }}">
        <div id="ai-loading" class="htmx-indicator">
            <div class="loading-bar"></div>
            <small aria-live="polite">{% trans "Working on a suggestion…" %}</small>
        </div>
    </fieldset>

    <div class="entry-divider" aria-hidden="true">
        <span>{% trans "or" %}</span>
    </div>

    {# ── Quick pick path ── #}
    {% if common_goals %}
    <fieldset id="quick-pick-entry">
        <legend>{% trans "Quick pick from existing goals" %}</legend>
        <div class="goal-card-grid" role="group" aria-label="{% trans 'Common goals in this program' %}">
            {% for goal in common_goals %}
            <button type="button"
                    class="goal-card outline"
                    data-goal-name="{{ goal.name }}"
                    data-metric-id="{{ goal.metric_id|default:'' }}"
                    aria-label="{% blocktrans with name=goal.name count=goal.count %}Use {{ name }} ({{ count }} participants){% endblocktrans %}">
                <strong>{{ goal.name }}</strong>
                {% if goal.metric_name %}
                <small>{{ goal.metric_name }}</small>
                {% endif %}
                <small class="secondary">
                    {% blocktrans count count=goal.count %}{{ count }} participant{% plural %}{{ count }} participants{% endblocktrans %}
                </small>
            </button>
            {% endfor %}
        </div>
    </fieldset>
    {% endif %}

    <p><a href="#" id="btn-manual-entry" class="secondary">
        {% trans "Or fill in the form manually" %}
    </a></p>
</div>

{# Container for AI suggestion (HTMX swaps here) #}
<div id="suggestion-container" aria-live="polite"></div>
{% endif %}

{# ====== The form (hidden when AI enabled, revealed by JS) ====== #}
<form method="post" id="goal-form" novalidate {% if ai_enabled %}hidden{% endif %}>
    {% csrf_token %}

    {% if not ai_enabled %}
    {# ====== Phase 1: Listen (non-AI only, hidden on POST) ====== #}
    <div id="goal-phase-1" {% if form.is_bound %}hidden{% endif %}>

        {# ── Participant's words ── #}
        <fieldset>
            <legend>{{ form.client_goal.label }}</legend>
            <small>{{ form.client_goal.help_text }}</small>
            <input type="text"
                   id="{{ form.client_goal.id_for_label }}"
                   name="client_goal"
                   value="{{ form.client_goal.value|default_if_none:'' }}"
                   placeholder="{% trans 'In their own words…' %}"
                   maxlength="255">
            {% if form.client_goal.errors %}
            <small class="error" role="alert">{{ form.client_goal.errors.0 }}</small>
            {% endif %}
        </fieldset>

        <div class="phase-action">
            <button type="button" id="btn-next-phase">
                {% trans "Next: shape this into a goal" %} &#9656;
            </button>
        </div>

        {% if common_goals %}
        <div class="entry-divider" aria-hidden="true">
            <span>{% trans "or" %}</span>
        </div>

        <div class="common-goal-cards" role="group" aria-label="{% trans 'Common goals in this program' %}">
            <small class="secondary">{% trans "Quick pick — tap to use an existing goal:" %}</small>
            <div class="goal-card-grid">
                {% for goal in common_goals %}
                <button type="button"
                        class="goal-card outline"
                        data-goal-name="{{ goal.name }}"
                        data-metric-id="{{ goal.metric_id|default:'' }}"
                        aria-label="{% blocktrans with name=goal.name count=goal.count %}Use {{ name }} ({{ count }} participants){% endblocktrans %}">
                    <strong>{{ goal.name }}</strong>
                    {% if goal.metric_name %}
                    <small>{{ goal.metric_name }}</small>
                    {% endif %}
                    <small class="secondary">
                        {% blocktrans count count=goal.count %}{{ count }} participant{% plural %}{{ count }} participants{% endblocktrans %}
                    </small>
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <a href="#" id="btn-show-all" class="show-all-link">
            {% trans "Show all fields" %}
        </a>
    </div>

    {# ====== Phase 2: Shape the goal (non-AI, hidden on GET) ====== #}
    <div id="goal-phase-2" {% if not form.is_bound %}hidden{% endif %}>

        {# ── Reference quote — shows what the participant said ── #}
        <blockquote id="participant-quote" class="participant-quote" hidden>
            <small>{% blocktrans with name=client.display_name %}{{ name }} said:{% endblocktrans %}</small>
            <p id="participant-quote-text"></p>
        </blockquote>

        {# ── Participant's words (hidden field to preserve value for POST) ── #}
        <input type="hidden"
               id="{{ form.client_goal.id_for_label }}-phase2"
               name="client_goal"
               value="{{ form.client_goal.value|default_if_none:'' }}">

        {# ── Goal name with autocomplete ── #}
        <fieldset>
            <legend>{% trans "Give this a short name (2–5 words)" %}</legend>

            <div class="goal-name-autocomplete">
                <input type="text"
                       id="{{ form.name.id_for_label }}"
                       name="name"
                       value="{{ form.name.value|default_if_none:'' }}"
                       placeholder="{% trans 'e.g., Connect with community' %}"
                       maxlength="255"
                       required
                       autocomplete="off"
                       role="combobox"
                       aria-expanded="false"
                       aria-autocomplete="list"
                       aria-controls="goal-suggestions-list"
                       aria-activedescendant=""
                       data-suggestions-url="{% url 'plans:goal_name_suggestions' client_id=client.pk %}">
                <div id="goal-suggestions-list"
                     role="listbox"
                     aria-label="{% trans 'Goal name suggestions' %}"
                     hidden></div>
                <div aria-live="polite" class="sr-only" id="suggestion-count"></div>
            </div>
            {% if form.name.errors %}
            <small class="error" role="alert">{{ form.name.errors.0 }}</small>
            {% endif %}
        </fieldset>

        {# ── Description with sentence template ── #}
        <fieldset>
            <legend>{% trans "What will they do, how much, and by when?" %}</legend>
            <small>{% trans "A good goal answers: What? How often? By when?" %}</small>
            <textarea id="{{ form.description.id_for_label }}"
                      name="description"
                      rows="3"
                      placeholder="{% blocktrans with name=client.display_name %}e.g., {{ name }} will attend one community event per month by June 2026{% endblocktrans %}">{{ form.description.value|default_if_none:'' }}</textarea>
            {% if form.description.errors %}
            <small class="error" role="alert">{{ form.description.errors.0 }}</small>
            {% endif %}
        </fieldset>

        {# ── Section picker ── #}
        <fieldset>
            <legend>{{ form.section_choice.label }}</legend>

            {% if preselected_section %}
            {# Pre-selected and locked #}
            <input type="hidden" name="section_choice" value="{{ preselected_section.pk }}">
            <input type="text" value="{{ preselected_section.name }}" disabled
                   aria-label="{% trans 'Section (pre-selected)' %}">
            {% else %}
            <select id="{{ form.section_choice.id_for_label }}"
                    name="section_choice"
                    aria-controls="new-section-row"
                    required>
                {% for value, label in form.section_choice.field.choices %}
                <option value="{{ value }}" {% if form.section_choice.value == value|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <div id="new-section-row"
                 {% if form.section_choice.value != "new" %}hidden{% endif %}
                 aria-expanded="{% if form.section_choice.value == 'new' %}true{% else %}false{% endif %}">
                <label for="{{ form.new_section_name.id_for_label }}">{% trans "New section name" %}</label>
                <input type="text"
                       id="{{ form.new_section_name.id_for_label }}"
                       name="new_section_name"
                       value="{{ form.new_section_name.value|default_if_none:'' }}"
                       placeholder="{% trans 'New section name' %}"
                       maxlength="255">
                {% if form.new_section_name.errors %}
                <small class="error" role="alert">{{ form.new_section_name.errors.0 }}</small>
                {% endif %}
            </div>
            {% endif %}
            {% if form.section_choice.errors %}
            <small class="error" role="alert">{{ form.section_choice.errors.0 }}</small>
            {% endif %}
        </fieldset>

        {# ── Metrics ── #}
        <fieldset>
            <legend>{% trans "How will you track progress?" %}</legend>
            <small>{{ form.metrics.help_text }}</small>

            {# Tier 1: Universal metrics (always visible, card-style) #}
            {% if universal_metrics %}
            <div class="universal-metric-cards" role="group" aria-label="{% trans 'Universal metrics' %}">
                <small class="tier-label"><strong>{% trans "Recommended" %}</strong></small>
                {% for metric in universal_metrics %}
                <label class="metric-card" for="metric-{{ metric.pk }}">
                    <input type="checkbox"
                           id="metric-{{ metric.pk }}"
                           name="metrics"
                           value="{{ metric.pk }}"
                           {% if metric.pk in selected_metric_ids %}checked{% endif %}>
                    <div class="metric-card-body">
                        <strong>{{ metric.translated_name }}</strong>
                        <small>{{ metric.translated_definition }}</small>
                    </div>
                </label>
                {% endfor %}
            </div>
            {% endif %}

            {# Tier 2: Used in this program (visible if any) #}
            {% if program_used_metrics %}
            <details class="metric-tier">
                <summary>{% trans "Used in this program" %}</summary>
                <div class="metric-tier-list" role="group" aria-label="{% trans 'Metrics used in this program' %}">
                    {% for metric in program_used_metrics %}
                    <label for="metric-{{ metric.pk }}">
                        <input type="checkbox"
                               id="metric-{{ metric.pk }}"
                               name="metrics"
                               value="{{ metric.pk }}"
                               {% if metric.pk in selected_metric_ids %}checked{% endif %}>
                        {{ metric.translated_name }}
                        <small class="secondary">
                            {% blocktrans with count=metric.usage_count %}used by {{ count }} participant(s){% endblocktrans %}
                        </small>
                    </label>
                    {% endfor %}
                </div>
            </details>
            {% endif %}

            {# Tier 3: All available metrics (collapsed with search) #}
            {% if metrics_by_category %}
            <details class="metric-tier">
                <summary>{% trans "All available metrics" %}</summary>
                <div class="metric-search-wrapper">
                    <input type="search"
                           id="metric-search"
                           placeholder="{% trans 'Search metrics…' %}"
                           aria-label="{% trans 'Filter metrics by name' %}"
                           autocomplete="off">
                    <div aria-live="polite" class="sr-only" id="metric-search-count"></div>
                </div>
                {% for category, metrics_list in metrics_by_category.items %}
                <fieldset class="metric-category" data-category="{{ category }}">
                    <legend>{{ category }}</legend>
                    {% for metric in metrics_list %}
                    <label for="metric-{{ metric.pk }}" class="metric-search-item" data-name="{{ metric.translated_name|lower }}">
                        <input type="checkbox"
                               id="metric-{{ metric.pk }}"
                               name="metrics"
                               value="{{ metric.pk }}"
                               {% if metric.pk in selected_metric_ids %}checked{% endif %}>
                        {{ metric.translated_name }}
                        {% if metric.translated_definition %}
                        <small>{{ metric.translated_definition|truncatewords:15 }}</small>
                        {% endif %}
                    </label>
                    {% endfor %}
                </fieldset>
                {% endfor %}
            </details>
            {% endif %}

            {% if form.metrics.errors %}
            <small class="error" role="alert">{{ form.metrics.errors.0 }}</small>
            {% endif %}
        </fieldset>

        {# ── Submit ── #}
        <div role="group">
            <button type="submit">{% blocktrans with target=term.target|default:"Goal" %}Add {{ target }}{% endblocktrans %}</button>
            <a href="{% url 'plans:plan_view' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Cancel" %}</a>
        </div>
    </div>

    {# ── Screen reader announcement region ── #}
    <div aria-live="polite" class="sr-only" id="phase-announce"></div>

    {% else %}
    {# ====== AI-enabled form layout (unchanged) ====== #}

    {# ── 1. Participant's words ── #}
    <fieldset>
        <legend>{{ form.client_goal.label }}</legend>
        <small>{{ form.client_goal.help_text }}</small>
        <input type="text"
               id="{{ form.client_goal.id_for_label }}"
               name="client_goal"
               value="{{ form.client_goal.value|default_if_none:'' }}"
               placeholder="{% trans 'In their own words…' %}"
               maxlength="255">
        {% if form.client_goal.errors %}
        <small class="error" role="alert">{{ form.client_goal.errors.0 }}</small>
        {% endif %}
    </fieldset>

    {# ── SMART guidance ── #}
    <aside class="smart-guidance" role="note">
        <details>
            <summary>{% trans "Tips for writing a good goal" %}</summary>
            <p>{% trans "Try turning their words into something Specific, Measurable, Achievable, Relevant, and Time-bound (SMART)." %}</p>
            <p class="secondary">{% trans "For example:" %} <em>&ldquo;{% trans "Make a friend" %}&rdquo;</em> &rarr; <em>&ldquo;{% trans "Build one social connection outside of program activities within 3 months" %}&rdquo;</em></p>
        </details>
    </aside>

    {# ── 2. Goal name with autocomplete ── #}
    <fieldset>
        <legend>{{ form.name.label }}</legend>
        <small>{{ form.name.help_text }}</small>

        <div class="goal-name-autocomplete">
            <input type="text"
                   id="{{ form.name.id_for_label }}"
                   name="name"
                   value="{{ form.name.value|default_if_none:'' }}"
                   placeholder="{% trans 'e.g., Find stable housing' %}"
                   maxlength="255"
                   required
                   autocomplete="off"
                   role="combobox"
                   aria-expanded="false"
                   aria-autocomplete="list"
                   aria-controls="goal-suggestions-list"
                   aria-activedescendant=""
                   data-suggestions-url="{% url 'plans:goal_name_suggestions' client_id=client.pk %}">
            <div id="goal-suggestions-list"
                 role="listbox"
                 aria-label="{% trans 'Goal name suggestions' %}"
                 hidden></div>
            <div aria-live="polite" class="sr-only" id="suggestion-count"></div>
        </div>
        {% if form.name.errors %}
        <small class="error" role="alert">{{ form.name.errors.0 }}</small>
        {% endif %}
    </fieldset>

    {# ── 3. Section picker ── #}
    <fieldset>
        <legend>{{ form.section_choice.label }}</legend>

        {% if preselected_section %}
        {# Pre-selected and locked #}
        <input type="hidden" name="section_choice" value="{{ preselected_section.pk }}">
        <input type="text" value="{{ preselected_section.name }}" disabled
               aria-label="{% trans 'Section (pre-selected)' %}">
        {% else %}
        <select id="{{ form.section_choice.id_for_label }}"
                name="section_choice"
                aria-controls="new-section-row"
                required>
            {% for value, label in form.section_choice.field.choices %}
            <option value="{{ value }}" {% if form.section_choice.value == value|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
        <div id="new-section-row"
             {% if form.section_choice.value != "new" %}hidden{% endif %}
             aria-expanded="{% if form.section_choice.value == 'new' %}true{% else %}false{% endif %}">
            <label for="{{ form.new_section_name.id_for_label }}">{% trans "New section name" %}</label>
            <input type="text"
                   id="{{ form.new_section_name.id_for_label }}"
                   name="new_section_name"
                   value="{{ form.new_section_name.value|default_if_none:'' }}"
                   placeholder="{% trans 'New section name' %}"
                   maxlength="255">
            {% if form.new_section_name.errors %}
            <small class="error" role="alert">{{ form.new_section_name.errors.0 }}</small>
            {% endif %}
        </div>
        {% endif %}
        {% if form.section_choice.errors %}
        <small class="error" role="alert">{{ form.section_choice.errors.0 }}</small>
        {% endif %}
    </fieldset>

    {# ── 4. Description ── #}
    <fieldset>
        <legend>{{ form.description.label }}</legend>
        <small>{% trans "Consider: What specifically will they do or achieve? How will you know when they've made progress? What's a realistic timeline?" %}</small>
        <textarea id="{{ form.description.id_for_label }}"
                  name="description"
                  rows="4"
                  placeholder="{% trans 'e.g., Participant will identify and reach out to one person outside the program for a social activity within 3 months, tracked through weekly check-ins.' %}">{{ form.description.value|default_if_none:'' }}</textarea>
        {% if form.description.errors %}
        <small class="error" role="alert">{{ form.description.errors.0 }}</small>
        {% endif %}
    </fieldset>

    {# ── 5. Metric picker — three tiers ── #}
    <fieldset>
        <legend>{{ form.metrics.label }}</legend>
        <small>{{ form.metrics.help_text }}</small>

        {# Tier 1: Universal metrics (always visible, card-style) #}
        {% if universal_metrics %}
        <div class="universal-metric-cards" role="group" aria-label="{% trans 'Universal metrics' %}">
            <small class="tier-label"><strong>{% trans "Recommended" %}</strong></small>
            {% for metric in universal_metrics %}
            <label class="metric-card" for="metric-{{ metric.pk }}">
                <input type="checkbox"
                       id="metric-{{ metric.pk }}"
                       name="metrics"
                       value="{{ metric.pk }}"
                       {% if metric.pk in selected_metric_ids %}checked{% endif %}>
                <div class="metric-card-body">
                    <strong>{{ metric.translated_name }}</strong>
                    <small>{{ metric.translated_definition }}</small>
                </div>
            </label>
            {% endfor %}
        </div>
        {% endif %}

        {# Tier 2: Used in this program (visible if any) #}
        {% if program_used_metrics %}
        <details class="metric-tier">
            <summary>{% trans "Used in this program" %}</summary>
            <div class="metric-tier-list" role="group" aria-label="{% trans 'Metrics used in this program' %}">
                {% for metric in program_used_metrics %}
                <label for="metric-{{ metric.pk }}">
                    <input type="checkbox"
                           id="metric-{{ metric.pk }}"
                           name="metrics"
                           value="{{ metric.pk }}"
                           {% if metric.pk in selected_metric_ids %}checked{% endif %}>
                    {{ metric.translated_name }}
                    <small class="secondary">
                        {% blocktrans with count=metric.usage_count %}used by {{ count }} participant(s){% endblocktrans %}
                    </small>
                </label>
                {% endfor %}
            </div>
        </details>
        {% endif %}

        {# Tier 3: All available metrics (collapsed with search) #}
        {% if metrics_by_category %}
        <details class="metric-tier">
            <summary>{% trans "All available metrics" %}</summary>
            <div class="metric-search-wrapper">
                <input type="search"
                       id="metric-search"
                       placeholder="{% trans 'Search metrics…' %}"
                       aria-label="{% trans 'Filter metrics by name' %}"
                       autocomplete="off">
                <div aria-live="polite" class="sr-only" id="metric-search-count"></div>
            </div>
            {% for category, metrics_list in metrics_by_category.items %}
            <fieldset class="metric-category" data-category="{{ category }}">
                <legend>{{ category }}</legend>
                {% for metric in metrics_list %}
                <label for="metric-{{ metric.pk }}" class="metric-search-item" data-name="{{ metric.translated_name|lower }}">
                    <input type="checkbox"
                           id="metric-{{ metric.pk }}"
                           name="metrics"
                           value="{{ metric.pk }}"
                           {% if metric.pk in selected_metric_ids %}checked{% endif %}>
                    {{ metric.translated_name }}
                    {% if metric.translated_definition %}
                    <small>{{ metric.translated_definition|truncatewords:15 }}</small>
                    {% endif %}
                </label>
                {% endfor %}
            </fieldset>
            {% endfor %}
        </details>
        {% endif %}

        {% if form.metrics.errors %}
        <small class="error" role="alert">{{ form.metrics.errors.0 }}</small>
        {% endif %}
    </fieldset>

    {# ── Submit ── #}
    <div role="group">
        <button type="submit">{% blocktrans with target=term.target|default:"Goal" %}Add {{ target }}{% endblocktrans %}</button>
        <a href="{% url 'plans:plan_view' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Cancel" %}</a>
    </div>
    {% endif %}
</form>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    "use strict";

    var goalForm = document.getElementById("goal-form");
    var entryPoints = document.getElementById("entry-points");
    var suggestionContainer = document.getElementById("suggestion-container");
    var nameInput = document.getElementById("{{ form.name.id_for_label }}");

    // ────────────────────────────────────────
    // Non-AI two-phase disclosure
    // ────────────────────────────────────────

    var phase1 = document.getElementById("goal-phase-1");
    var phase2 = document.getElementById("goal-phase-2");

    function revealPhase2() {
        if (!phase1 || !phase2) return;
        phase1.hidden = true;
        phase2.hidden = false;

        // Show participant quote if words were entered
        var wordsInput = phase1.querySelector("[name=client_goal]");
        var quote = document.getElementById("participant-quote");
        var quoteText = document.getElementById("participant-quote-text");
        var hiddenClientGoal = document.getElementById("{{ form.client_goal.id_for_label }}-phase2");
        if (wordsInput && wordsInput.value.trim()) {
            // Copy value to hidden field for POST
            if (hiddenClientGoal) hiddenClientGoal.value = wordsInput.value;
            // Show quote
            if (quote && quoteText) {
                quoteText.textContent = "\u201c" + wordsInput.value.trim() + "\u201d";
                quote.hidden = false;
            }
        }

        // Announce to screen readers
        var announce = document.getElementById("phase-announce");
        if (announce) announce.textContent = "{% trans 'Form expanded — complete the goal details below.' %}";

        // Focus goal name
        if (nameInput) nameInput.focus();
    }

    // Trigger 1: "Next: shape this into a goal" button
    var nextBtn = document.getElementById("btn-next-phase");
    if (nextBtn) {
        nextBtn.addEventListener("click", function() {
            revealPhase2();
        });
    }

    // Trigger 2: Quick pick cards (non-AI phase 1)
    if (phase1) {
        var phase1Cards = phase1.querySelectorAll(".goal-card");
        phase1Cards.forEach(function(card) {
            card.addEventListener("click", function() {
                // Pre-fill goal name
                if (nameInput) nameInput.value = this.dataset.goalName;
                // Pre-check metric
                var metricId = this.dataset.metricId;
                if (metricId) {
                    var cb = document.getElementById("metric-" + metricId);
                    if (cb) cb.checked = true;
                }
                revealPhase2();
            });
        });
    }

    // Trigger 3: Textarea blur with content
    if (phase1) {
        var wordsField = phase1.querySelector("[name=client_goal]");
        if (wordsField) {
            wordsField.addEventListener("blur", function() {
                if (this.value.trim().length > 0) {
                    revealPhase2();
                }
            });
        }
    }

    // Safety valve: "Show all fields" link
    var showAllBtn = document.getElementById("btn-show-all");
    if (showAllBtn) {
        showAllBtn.addEventListener("click", function(e) {
            e.preventDefault();
            revealPhase2();
        });
    }

    // ────────────────────────────────────────
    // AI path: Progressive disclosure helpers
    // ────────────────────────────────────────

    function revealForm() {
        if (entryPoints) entryPoints.hidden = true;
        if (goalForm) {
            goalForm.hidden = false;
            var firstInput = goalForm.querySelector("input:not([type=hidden]):not([disabled]), textarea, select");
            if (firstInput) firstInput.focus();
        }
    }

    function populateForm(suggestion, sectionPk, newSectionName) {
        if (!goalForm) return;

        // Participant's words
        var clientGoal = goalForm.querySelector("[name=client_goal]");
        if (clientGoal && suggestion.client_goal) clientGoal.value = suggestion.client_goal;

        // Goal name
        if (nameInput && suggestion.name) nameInput.value = suggestion.name;

        // Description
        var desc = goalForm.querySelector("[name=description]");
        if (desc && suggestion.description) desc.value = suggestion.description;

        // Section
        var sectionSelect = goalForm.querySelector("[name=section_choice]");
        var newSectionRow = document.getElementById("new-section-row");
        var newSectionInput = goalForm.querySelector("[name=new_section_name]");
        if (sectionSelect) {
            if (sectionPk) {
                // Select existing section
                sectionSelect.value = sectionPk;
                if (newSectionRow) newSectionRow.hidden = true;
            } else if (newSectionName) {
                // Create new section
                sectionSelect.value = "new";
                if (newSectionRow) {
                    newSectionRow.hidden = false;
                    newSectionRow.setAttribute("aria-expanded", "true");
                }
                if (newSectionInput) newSectionInput.value = newSectionName;
            }
        }

        // Metrics — check boxes matching suggestion metric IDs
        if (suggestion.metrics && suggestion.metrics.length) {
            suggestion.metrics.forEach(function(m) {
                var cb = document.getElementById("metric-" + m.metric_id);
                if (cb) cb.checked = true;
            });
        }
    }

    // ────────────────────────────────────────
    // AI suggestion card actions (event delegation)
    // ────────────────────────────────────────

    if (suggestionContainer) {
        // After HTMX swaps the suggestion card in, scroll and focus
        document.addEventListener("htmx:afterSwap", function(evt) {
            if (evt.detail.target.id !== "suggestion-container") return;

            var card = document.getElementById("ai-suggestion");
            if (card) {
                card.scrollIntoView({ behavior: "smooth" });
                card.focus();
            }
            // If error partial was loaded, wire up its button
            var showFormBtn = document.getElementById("btn-show-manual-form");
            if (showFormBtn) {
                showFormBtn.addEventListener("click", function() {
                    suggestionContainer.innerHTML = "";
                    // Copy participant words to the form's client_goal field
                    var pw = document.getElementById("participant-words");
                    var clientGoal = goalForm ? goalForm.querySelector("[name=client_goal]") : null;
                    if (pw && clientGoal) clientGoal.value = pw.value;
                    revealForm();
                });
            }
        });

        // Handle suggestion card button clicks
        suggestionContainer.addEventListener("click", function(e) {
            var btn = e.target.closest("button");
            if (!btn) return;

            if (btn.id === "btn-use-suggestion") {
                var suggestion = JSON.parse(btn.dataset.suggestion);
                populateForm(suggestion, btn.dataset.sectionPk, btn.dataset.newSection);
                // Submit the form directly
                revealForm();
                goalForm.submit();
                return;
            }

            if (btn.id === "btn-edit-suggestion") {
                var editSuggestion = JSON.parse(btn.dataset.suggestion);
                populateForm(editSuggestion, btn.dataset.sectionPk, btn.dataset.newSection);
                suggestionContainer.innerHTML = "";
                revealForm();
                return;
            }

            if (btn.id === "btn-start-over") {
                suggestionContainer.innerHTML = "";
                if (entryPoints) entryPoints.hidden = false;
                var pw = document.getElementById("participant-words");
                if (pw) {
                    pw.value = "";
                    pw.focus();
                }
                return;
            }
        });
    }

    // ────────────────────────────────────────
    // Entry point: "Or fill in the form manually"
    // ────────────────────────────────────────

    var manualBtn = document.getElementById("btn-manual-entry");
    if (manualBtn) {
        manualBtn.addEventListener("click", function(e) {
            e.preventDefault();
            // Copy participant words to the form's client_goal field
            var pw = document.getElementById("participant-words");
            var clientGoal = goalForm ? goalForm.querySelector("[name=client_goal]") : null;
            if (pw && pw.value && clientGoal) clientGoal.value = pw.value;
            revealForm();
        });
    }

    // ────────────────────────────────────────
    // Quick pick cards (entry point version — AI mode)
    // ────────────────────────────────────────

    var entryGoalCards = entryPoints ? entryPoints.querySelectorAll(".goal-card") : [];
    entryGoalCards.forEach(function(card) {
        card.addEventListener("click", function() {
            if (nameInput) nameInput.value = this.dataset.goalName;
            var metricId = this.dataset.metricId;
            if (metricId) {
                var cb = document.getElementById("metric-" + metricId);
                if (cb) cb.checked = true;
            }
            revealForm();
        });
    });

    // ────────────────────────────────────────
    // Section picker: show/hide "Create new" field
    // ────────────────────────────────────────

    var sectionSelect = document.getElementById("{{ form.section_choice.id_for_label }}");
    var newSectionRow = document.getElementById("new-section-row");
    if (sectionSelect && newSectionRow) {
        sectionSelect.addEventListener("change", function() {
            var isNew = this.value === "new";
            newSectionRow.hidden = !isNew;
            newSectionRow.setAttribute("aria-expanded", isNew ? "true" : "false");
            if (isNew) {
                var sectionNameInput = newSectionRow.querySelector("input[type=text]");
                if (sectionNameInput) sectionNameInput.focus();
            }
        });
    }

    // ────────────────────────────────────────
    // Goal name autocomplete (load-once, filter client-side)
    // ────────────────────────────────────────

    var suggestionsLoaded = false;
    var allSuggestions = [];
    var suggestionsList = document.getElementById("goal-suggestions-list");
    var autocompleteCount = document.getElementById("suggestion-count");
    var activeIndex = -1;

    function loadSuggestions() {
        if (suggestionsLoaded || !nameInput) return;
        var url = nameInput.dataset.suggestionsUrl;
        if (!url) return;
        fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest", "HX-Request": "true" } })
            .then(function(r) { return r.text(); })
            .then(function(html) {
                suggestionsList.innerHTML = html;
                allSuggestions = Array.from(suggestionsList.querySelectorAll("[role=option]"));
                suggestionsLoaded = true;
                filterSuggestions();
            });
    }

    function filterSuggestions() {
        if (!suggestionsLoaded) return;
        var query = (nameInput.value || "").toLowerCase().trim();
        var visibleCount = 0;
        activeIndex = -1;
        allSuggestions.forEach(function(opt) {
            var name = (opt.dataset.name || "").toLowerCase();
            var visible = query.length >= 2 && name.indexOf(query) !== -1;
            opt.hidden = !visible;
            opt.setAttribute("aria-selected", "false");
            if (visible) visibleCount++;
        });
        var show = visibleCount > 0;
        suggestionsList.hidden = !show;
        nameInput.setAttribute("aria-expanded", show ? "true" : "false");
        if (autocompleteCount) {
            if (show) {
                autocompleteCount.textContent = visibleCount + " " + (visibleCount === 1 ? "{% trans 'suggestion available' %}" : "{% trans 'suggestions available' %}");
            } else {
                autocompleteCount.textContent = "";
            }
        }
    }

    function selectSuggestion(opt) {
        nameInput.value = opt.dataset.name;
        var metricId = opt.dataset.metricId;
        if (metricId) {
            var cb = document.getElementById("metric-" + metricId);
            if (cb) cb.checked = true;
        }
        closeSuggestions();
        nameInput.focus();
    }

    function closeSuggestions() {
        suggestionsList.hidden = true;
        nameInput.setAttribute("aria-expanded", "false");
        nameInput.setAttribute("aria-activedescendant", "");
        activeIndex = -1;
    }

    if (nameInput) {
        nameInput.addEventListener("input", function() {
            if (!suggestionsLoaded && this.value.length >= 2) {
                loadSuggestions();
            } else {
                filterSuggestions();
            }
        });
        nameInput.addEventListener("keydown", function(e) {
            var visible = allSuggestions.filter(function(s) { return !s.hidden; });
            if (!visible.length) return;
            if (e.key === "ArrowDown") {
                e.preventDefault();
                activeIndex = Math.min(activeIndex + 1, visible.length - 1);
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                activeIndex = Math.max(activeIndex - 1, 0);
            } else if (e.key === "Enter" && activeIndex >= 0) {
                e.preventDefault();
                selectSuggestion(visible[activeIndex]);
                return;
            } else if (e.key === "Escape") {
                closeSuggestions();
                return;
            } else {
                return;
            }
            visible.forEach(function(s, i) {
                s.setAttribute("aria-selected", i === activeIndex ? "true" : "false");
            });
            if (visible[activeIndex]) {
                nameInput.setAttribute("aria-activedescendant", visible[activeIndex].id);
                visible[activeIndex].scrollIntoView({ block: "nearest" });
            }
        });
        nameInput.addEventListener("blur", function() {
            setTimeout(closeSuggestions, 300);
        });
    }
    if (suggestionsList) {
        suggestionsList.addEventListener("click", function(e) {
            var opt = e.target.closest("[role=option]");
            if (opt) selectSuggestion(opt);
        });
    }

    // ────────────────────────────────────────
    // Metric search/filter in Tier 3
    // ────────────────────────────────────────

    var metricSearch = document.getElementById("metric-search");
    var metricSearchCount = document.getElementById("metric-search-count");
    if (metricSearch) {
        metricSearch.addEventListener("input", function() {
            var query = this.value.toLowerCase().trim();
            var items = document.querySelectorAll(".metric-search-item");
            var visibleCount = 0;
            items.forEach(function(item) {
                var name = item.dataset.name || "";
                var match = !query || name.indexOf(query) !== -1;
                item.hidden = !match;
                if (match) visibleCount++;
            });
            document.querySelectorAll(".metric-category").forEach(function(cat) {
                var hasVisible = cat.querySelector(".metric-search-item:not([hidden])");
                cat.hidden = !hasVisible;
            });
            if (metricSearchCount) {
                if (query) {
                    metricSearchCount.textContent = visibleCount + " " + (visibleCount === 1 ? "{% trans 'metric matches' %}" : "{% trans 'metrics match' %}");
                } else {
                    metricSearchCount.textContent = "";
                }
            }
        });
    }

    // ────────────────────────────────────────
    // Focus error summary on failed submission
    // ────────────────────────────────────────

    var errorSummary = document.getElementById("error-summary");
    if (errorSummary) {
        // If form had errors, make sure it's visible (not hidden behind entry points)
        if (goalForm && goalForm.hidden) {
            revealForm();
        }
        errorSummary.focus();
    }
})();
</script>
{% endblock %}
