{% load i18n %}
{% load static %}
{% load survey_tags %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'en' }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ survey.name }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="{% static 'css/theme.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
<!-- Language toggle — FLSA active offer -->
{% get_current_language as CURRENT_LANG %}
<nav class="lang-nav" aria-label="{% trans 'Language selection' %}" style="max-width:720px; margin:0 auto">
    <form action="{% url 'switch_language' %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.path }}">
        {% if CURRENT_LANG == "en" %}
        <input type="hidden" name="language" value="fr">
        <button type="submit" class="lang-link" lang="fr" hreflang="fr">Fran&ccedil;ais</button>
        {% else %}
        <input type="hidden" name="language" value="en">
        <button type="submit" class="lang-link" lang="en" hreflang="en">English</button>
        {% endif %}
    </form>
</nav>
<main class="container" style="max-width:720px; padding-top:2rem">

<h1>{{ survey.name }}</h1>

{% if survey.description %}
<p>{{ survey.description }}</p>
{% endif %}

{% if errors %}
<article role="alert" aria-label="{% trans 'Errors' %}" style="background:var(--pico-del-color, #c62828); color:#fff; padding:1rem; border-radius:4px">
    <p><strong>{% trans "Please answer all required questions:" %}</strong></p>
    <ul>
    {% for err in errors %}
        <li>{{ err }}</li>
    {% endfor %}
    </ul>
</article>
{% endif %}

<form method="post">
    {% csrf_token %}

    {# Honeypot anti-spam: hidden from real users, filled by bots #}
    <div aria-hidden="true" style="position:absolute;left:-9999px" tabindex="-1">
        <label for="website">{% trans "Website" %}</label>
        <input type="text" name="website" id="website" autocomplete="off" tabindex="-1">
    </div>

    {% if link.collect_name %}
    <label for="respondent_name">{% trans "Your name (optional)" %}</label>
    <input type="text" id="respondent_name" name="respondent_name"
           value="{{ posted.respondent_name|default:'' }}">
    {% endif %}

    {% for section in sections %}
    <fieldset>
        <legend>{{ section.title }}</legend>
        {% if section.instructions %}<p><small>{{ section.instructions }}</small></p>{% endif %}

        {% for question in section.questions.all %}
        <div style="margin-bottom:1.5rem">
            <label for="q_{{ question.pk }}">
                {{ question.question_text }}{% if question.required %} <abbr title="{% trans 'required' %}">*</abbr>{% endif %}
            </label>

            {% if question.question_type == "short_text" %}
            <input type="text" id="q_{{ question.pk }}" name="q_{{ question.pk }}"
                   value="{{ question.pk|partial_value:repopulate }}"
                   {% if question.required %}required{% endif %}>

            {% elif question.question_type == "long_text" %}
            <textarea id="q_{{ question.pk }}" name="q_{{ question.pk }}" rows="4"
                      {% if question.required %}required{% endif %}>{{ question.pk|partial_value:repopulate }}</textarea>

            {% elif question.question_type == "yes_no" %}
            {% with saved=question.pk|partial_value:repopulate %}
            <select id="q_{{ question.pk }}" name="q_{{ question.pk }}"
                    {% if question.required %}required{% endif %}>
                <option value="">—</option>
                <option value="1" {% if saved == "1" %}selected{% endif %}>{% trans "Yes" %}</option>
                <option value="0" {% if saved == "0" %}selected{% endif %}>{% trans "No" %}</option>
            </select>
            {% endwith %}

            {% elif question.question_type == "single_choice" %}
            {% with saved=question.pk|partial_value:repopulate %}
            {% for opt in question.options_json %}
            <label>
                <input type="radio" name="q_{{ question.pk }}" value="{{ opt.value }}"
                       {% if saved == opt.value %}checked{% endif %}>
                {{ opt.label }}
            </label>
            {% endfor %}
            {% endwith %}

            {% elif question.question_type == "multiple_choice" %}
            {% with saved=question.pk|partial_value:repopulate %}
            {% for opt in question.options_json %}
            <label>
                <input type="checkbox" name="q_{{ question.pk }}" value="{{ opt.value }}"
                       {% if opt.value|in_multi_value:saved %}checked{% endif %}>
                {{ opt.label }}
            </label>
            {% endfor %}
            {% endwith %}

            {% elif question.question_type == "rating_scale" %}
            {% with saved=question.pk|partial_value:repopulate %}
            <div role="group">
            {% for opt in question.options_json %}
                <label style="text-align:center">
                    <input type="radio" name="q_{{ question.pk }}" value="{{ opt.value }}"
                           {% if saved == opt.value %}checked{% endif %}>
                    {{ opt.label }}
                </label>
            {% endfor %}
            </div>
            {% endwith %}
            {% if question.min_value is not None and question.max_value is not None %}
            <small class="secondary">{% blocktrans with min=question.min_value max=question.max_value %}Scale: {{ min }} to {{ max }}{% endblocktrans %}</small>
            {% endif %}

            {% endif %}
        </div>
        {% endfor %}
    </fieldset>
    {% endfor %}

    <button type="submit">{% trans "Submit" %}</button>
</form>

</main>
</body>
</html>
