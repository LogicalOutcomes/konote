{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Surveys" %} — {{ client.display_name }}{% endblock %}

{% block content %}
{% include "_breadcrumbs.html" %}

<hgroup>
    <h1>{% trans "Surveys" %}</h1>
    <p>{{ client.display_name }} {{ client.last_name }}</p>
</hgroup>

<div role="group">
    <a href="{% url 'surveys:assign_survey' client_id=client.pk %}" role="button" class="outline">{% trans "Assign Survey" %}</a>
</div>

{# Active assignments #}
{% if assignments %}
<h2>{% trans "Assigned Surveys" %}</h2>
<table aria-label="{% trans 'Survey assignments' %}">
    <thead>
        <tr>
            <th scope="col">{% trans "Survey" %}</th>
            <th scope="col">{% trans "Status" %}</th>
            <th scope="col">{% trans "Due" %}</th>
            <th scope="col">{% trans "Assigned" %}</th>
            <th scope="col">{% trans "Actions" %}</th>
        </tr>
    </thead>
    <tbody>
    {% for a in assignments %}
        <tr>
            <td>{{ a.survey.name }}</td>
            <td>
                {% if a.status == "completed" %}
                    <span class="badge badge-success">{% trans "Completed" %}</span>
                {% elif a.status == "pending" %}
                    <span class="badge badge-neutral">{% trans "Pending" %}</span>
                {% elif a.status == "in_progress" %}
                    <span class="badge badge-warning">{% trans "In Progress" %}</span>
                {% elif a.status == "awaiting_approval" %}
                    <span class="badge badge-warning">{% trans "Awaiting Approval" %}</span>
                {% elif a.status == "dismissed" %}
                    <span class="badge badge-neutral">{% trans "Dismissed" %}</span>
                {% endif %}
            </td>
            <td>{{ a.due_date|date:"N j, Y"|default:"—" }}</td>
            <td>{{ a.created_at|date:"N j, Y" }}</td>
            <td>
                {% if a.status == "awaiting_approval" %}
                <form method="post" action="{% url 'surveys:approve_assignment' assignment_id=a.pk %}" style="display:inline">
                    {% csrf_token %}
                    <button type="submit" class="outline" style="padding:0.25rem 0.5rem">{% trans "Approve" %}</button>
                </form>
                <form method="post" action="{% url 'surveys:dismiss_assignment' assignment_id=a.pk %}" style="display:inline">
                    {% csrf_token %}
                    <button type="submit" class="outline secondary" style="padding:0.25rem 0.5rem">{% trans "Dismiss" %}</button>
                </form>
                {% elif a.status == "pending" or a.status == "in_progress" %}
                <a href="{% url 'surveys:staff_data_entry' client_id=client.pk survey_id=a.survey.pk %}">{% trans "Enter on behalf" %}</a>
                ·
                <form method="post" action="{% url 'surveys:dismiss_assignment' assignment_id=a.pk %}" style="display:inline">
                    {% csrf_token %}
                    <button type="submit" class="outline secondary" style="padding:0.25rem 0.5rem">{% trans "Dismiss" %}</button>
                </form>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% endif %}

{# Staff data entry — any active survey #}
{% if active_surveys %}
<h2>{% trans "Enter Survey on Behalf" %}</h2>
<p><small>{% trans "Select an active survey to fill in on this participant's behalf." %}</small></p>
<div class="grid">
{% for s in active_surveys %}
    <a href="{% url 'surveys:staff_data_entry' client_id=client.pk survey_id=s.pk %}" role="button" class="outline">{{ s.name }}</a>
{% endfor %}
</div>
{% endif %}

{# Past responses #}
{% if responses %}
<h2>{% trans "Completed Responses" %}</h2>
<table aria-label="{% trans 'Survey responses' %}">
    <thead>
        <tr>
            <th scope="col">{% trans "Survey" %}</th>
            <th scope="col">{% trans "Submitted" %}</th>
            <th scope="col">{% trans "Channel" %}</th>
            <th scope="col">{% trans "Actions" %}</th>
        </tr>
    </thead>
    <tbody>
    {% for r in responses %}
        <tr>
            <td>{{ r.survey.name }}</td>
            <td>{{ r.submitted_at|date:"N j, Y g:i A" }}</td>
            <td>{{ r.get_channel_display }}</td>
            <td><a href="{% url 'surveys:client_response_detail' client_id=client.pk response_id=r.pk %}">{% trans "View" %}</a></td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% endif %}

{% if not assignments and not responses %}
<p class="empty-state">{% trans "No surveys assigned or completed yet." %}</p>
{% endif %}
{% endblock %}
