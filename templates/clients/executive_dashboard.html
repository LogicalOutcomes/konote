{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Executive Dashboard" %} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<header class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
        <div>
            <h1>{% trans "Executive Overview" %}</h1>
            <p class="page-subtitle">{% trans "A high-level look at how your programs are doing. This dashboard shows overall numbers — individual participant records are kept private." %}</p>
            {% if data_refreshed_at %}
            <p class="data-timestamp">{% trans "Last updated" %}: {{ data_refreshed_at|date:"SHORT_DATETIME_FORMAT" }}</p>
            {% endif %}
        </div>
        <a href="{% url 'clients:executive_dashboard_export' %}?start_date={{ start_date|date:'Y-m-d' }}{% if selected_program_id %}&program={{ selected_program_id }}{% endif %}" role="button" class="outline small">{% trans "Export CSV" %}</a>
    </div>
</header>

{# Program filter #}
{% if programs|length > 1 %}
<form method="get" action="" class="program-filter-form">
    <label for="program-filter">{% trans "Filter by" %} {{ term.program|default:"Program" }}:</label>
    <select id="program-filter" name="program" onchange="this.form.submit()">
        <option value="">{% trans "All" %} {{ term.program_plural|default:"Programs" }}</option>
        {% for prog in programs %}
        <option value="{{ prog.pk }}" {% if prog.pk == selected_program_id %}selected{% endif %}>
            {{ prog.translated_name }}
        </option>
        {% endfor %}
    </select>
</form>
{% endif %}

{# Start date filter (BUG-9/10) #}
<form method="get" action="" class="date-range-form">
    {% if selected_program_id %}<input type="hidden" name="program" value="{{ selected_program_id }}">{% endif %}
    <fieldset role="group">
        <legend class="sr-only">{% trans "Date range" %}</legend>
        <label for="start-date">{% trans "Show data from" %}</label>
        <input type="date" id="start-date" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
        <button type="submit" class="outline">{% trans "Update" %}</button>
    </fieldset>
</form>

{# Privacy compliance banner — event-driven, hidden when nothing pending #}
{% if privacy_banner_items %}
<section class="privacy-compliance-banner" aria-label="{% trans 'Privacy Compliance' %}">
    <article style="border-left: 4px solid var(--kn-warning-fg); background: var(--kn-warning-bg); margin-bottom: var(--kn-space-base);">
        <strong>{% trans "Privacy Action Required" %}</strong>
        <ul style="margin: 0.5rem 0 0; padding-left: 1.25rem;">
        {% for item in privacy_banner_items %}
            {% if item.type == "erasure" %}
            <li>
                {% blocktrans count count=item.count %}{{ count }} erasure request pending{% plural %}{{ count }} erasure requests pending{% endblocktrans %}
                — {% blocktrans with days=item.days %}submitted {{ days }} days ago{% endblocktrans %}
            </li>
            {% elif item.type == "data_access" %}
            <li {% if item.overdue %}style="color: var(--kn-danger-fg); font-weight: 600;"{% endif %}>
                {% if item.overdue %}
                {% blocktrans with name=item.client_name days=item.days_remaining %}{{ name }}'s data access request is overdue ({{ days }} days past deadline){% endblocktrans %}
                {% else %}
                {% blocktrans with name=item.client_name days=item.days_remaining %}{{ name }}'s data access request is due in {{ days }} days{% endblocktrans %}
                {% endif %}
            </li>
            {% endif %}
        {% endfor %}
        </ul>
    </article>
</section>
{% endif %}

{# Top-line summary cards #}
<section class="stats-overview" aria-label="{% trans 'Organization Summary' %}">
    <div class="stats-grid">
        <article class="stat-card">
            <div class="stat-value">{{ total_active }}</div>
            <div class="stat-label">{% trans "Active" %} {{ term.client_plural|default:"Participants" }}</div>
        </article>

        <article class="stat-card {% if without_notes > 0 %}stat-alert{% endif %}">
            <div class="stat-value">{{ without_notes }}</div>
            <div class="stat-label">{% trans "Without Notes This Month" %}</div>
            {% if without_notes > 0 %}
            <div class="stat-flag">{% trans "Needs attention" %}</div>
            {% endif %}
        </article>

        <article class="stat-card {% if overdue_followups > 5 %}stat-alert{% elif overdue_followups > 0 %}stat-warning{% endif %}">
            <div class="stat-value">{{ overdue_followups }}</div>
            <div class="stat-label">{% trans "Overdue Follow-ups" %}</div>
            {% if overdue_followups > 0 %}
            <div class="stat-flag">{% trans "Needs attention" %}</div>
            {% endif %}
        </article>

        {% if show_alerts and alert_oversight %}
        <article class="stat-card {% if alert_oversight.active > 0 %}stat-alert{% endif %}">
            <div class="stat-value">{{ alert_oversight.active }}</div>
            <div class="stat-label">{% trans "Active Safety Alerts" %}</div>
            {% if alert_oversight.aging > 0 %}
            <div class="stat-detail stat-warning-text">{{ alert_oversight.aging }} {% trans "older than 14 days" %}</div>
            {% endif %}
            {% if alert_oversight.pending_cancellation > 0 %}
            <div class="stat-detail">{{ alert_oversight.pending_cancellation }} {% trans "pending review" %}</div>
            {% endif %}
            {% if alert_oversight.active > 0 %}
            <a href="{% url 'clients:alert_overview' %}" class="stat-link">{% trans "View by program" %} &rarr;</a>
            {% endif %}
        </article>
        {% endif %}

        {% if total_suggestions_important > 0 %}
        <article class="stat-card stat-warning">
            <div class="stat-value">{{ total_suggestions_important }}</div>
            <div class="stat-label">{% trans "Important Suggestions" %}</div>
            <div class="stat-flag">{% trans "Review in Outcome Insights" %}</div>
        </article>
        {% endif %}
    </div>
</section>

{# Program breakdown #}
<section aria-label="{% trans 'Program Statistics' %}">
    <h2>{{ term.program_plural|default:"Programs" }}</h2>

    {% if program_stats %}
    <div class="program-cards">
        {% for stat in program_stats %}
        <article class="program-card">
            <header>
                <span class="program-dot" style="background-color: {{ stat.program.colour_hex }}" aria-hidden="true"></span>
                <h3>{{ stat.program.translated_name }}</h3>
            </header>

            <div class="program-metrics">
                {# Census #}
                <div class="metric-row">
                    <span class="metric-label">{% trans "Total" %} {{ term.client_plural|default:"Participants" }}</span>
                    <span class="metric-value">{{ stat.total }}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">{% trans "Active" %}</span>
                    <span class="metric-value">{{ stat.active }}</span>
                </div>

                <hr>

                {# Activity #}
                <div class="metric-row highlight">
                    <span class="metric-label">{% trans "New this month" %}</span>
                    <span class="metric-value">{{ stat.new_this_month }}</span>
                </div>
                <div class="metric-row highlight">
                    <span class="metric-label">{% trans "Notes this week" %}</span>
                    <span class="metric-value">{{ stat.notes_this_week }}</span>
                </div>

                <hr>

                {# Engagement & outcomes #}
                {% if stat.suppress_pct %}
                <div class="metric-row">
                    <span class="metric-label secondary"><small>{% trans "Percentages hidden (fewer than 5 active participants)" %}</small></span>
                </div>
                {% endif %}
                {% if stat.engagement_quality is not None %}
                <div class="metric-row {% if stat.engagement_quality >= 70 %}metric-success{% elif stat.engagement_quality >= 40 %}metric-neutral{% else %}metric-warning{% endif %}">
                    <span class="metric-label">{% trans "Engagement Quality" %}</span>
                    <span class="metric-value">{{ stat.engagement_quality }}%
                        <span class="sr-only">{% if stat.engagement_quality >= 70 %}({% trans "Good" %}){% elif stat.engagement_quality >= 40 %}({% trans "Fair" %}){% else %}({% trans "Low" %}){% endif %}</span>
                    </span>
                </div>
                {% endif %}

                {% if stat.goal_completion is not None %}
                <div class="metric-row">
                    <span class="metric-label">{% trans "Goal Completion Rate" %}</span>
                    <span class="metric-value">{{ stat.goal_completion }}%</span>
                </div>
                {% endif %}

                {% if show_events and stat.no_show_rate is not None %}
                <div class="metric-row {% if stat.no_show_rate > 30 %}metric-alert{% elif stat.no_show_rate > 15 %}metric-warning{% endif %}">
                    <span class="metric-label">{% trans "No-Show Rate" %}</span>
                    <span class="metric-value">{{ stat.no_show_rate }}%
                        {% if stat.no_show_rate > 30 %}<span class="sr-only">({% trans "High" %})</span>
                        {% elif stat.no_show_rate > 15 %}<span class="sr-only">({% trans "Elevated" %})</span>{% endif %}
                    </span>
                </div>
                {% endif %}

                {% if stat.group_attendance is not None %}
                <div class="metric-row {% if stat.group_attendance >= 75 %}metric-success{% elif stat.group_attendance >= 50 %}metric-neutral{% else %}metric-warning{% endif %}">
                    <span class="metric-label">{% trans "Group Attendance" %}</span>
                    <span class="metric-value">{{ stat.group_attendance }}%
                        <span class="sr-only">{% if stat.group_attendance >= 75 %}({% trans "Good" %}){% elif stat.group_attendance >= 50 %}({% trans "Fair" %}){% else %}({% trans "Low" %}){% endif %}</span>
                    </span>
                </div>
                {% endif %}

                <hr>

                {# Pipeline & adoption #}
                <div class="metric-row">
                    <span class="metric-label">{% trans "Intake Pipeline" %}</span>
                    <span class="metric-value">{{ stat.intake_pending }}</span>
                </div>

                {% if show_portal and stat.portal_adoption is not None %}
                <div class="metric-row">
                    <span class="metric-label">{% trans "Portal Adoption" %}</span>
                    <span class="metric-value">{{ stat.portal_adoption }}%</span>
                </div>
                {% endif %}

                {% if stat.top_themes %}
                <hr>
                {# Theme names — executives see what suggestions are about #}
                <div class="metric-row">
                    <span class="metric-label">{% trans "Suggestion Themes" %}</span>
                </div>
                <ul class="theme-compact-list" role="list" aria-label="{{ stat.program.translated_name }} {% trans 'suggestion themes' %}">
                    {% for theme in stat.top_themes %}
                    <li>
                        <span class="theme-name-compact">{{ theme.name }} <small class="theme-count">({{ theme.link_count }})</small></span>
                        {% if theme.priority == "urgent" %}
                        <span class="badge badge-danger badge-sm">{% trans "Urgent" %}</span>
                        {% elif theme.priority == "important" %}
                        <span class="badge badge-warning badge-sm">{% trans "Important" %}</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% if stat.theme_overflow > 0 %}
                <div class="metric-row">
                    <a href="{% url 'suggestion_themes:theme_list' %}?program={{ stat.program.pk }}" class="metric-link">+{{ stat.theme_overflow }} {% trans "more" %} &rarr;</a>
                </div>
                {% endif %}
                <div class="metric-row">
                    <a href="{% url 'suggestion_themes:theme_list' %}?program={{ stat.program.pk }}" class="metric-link">{% trans "View themes" %} &rarr;</a>
                </div>
                {% elif stat.suggestion_total > 0 %}
                <hr>
                {# Fallback: raw suggestion count when no themes exist #}
                <div class="metric-row {% if stat.suggestion_important > 0 %}metric-warning{% endif %}">
                    <span class="metric-label">{% trans "Suggestions" %}</span>
                    <span class="metric-value">
                        {{ stat.suggestion_total }}
                        {% if stat.suggestion_important > 0 %}
                        <small>({{ stat.suggestion_important }} {% trans "important" %})</small>
                        {% endif %}
                    </span>
                </div>
                <div class="metric-row">
                    <a href="{% url 'reports:program_insights' %}?program={{ stat.program.pk }}" class="metric-link">{% trans "View in Outcome Insights" %} &rarr;</a>
                </div>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p>{% trans "No programs assigned. Contact your administrator to request program access." %}</p>
    {% endif %}
</section>

{# Guidance #}
<section class="executive-guidance" aria-label="{% trans 'Getting More Information' %}">
    <h2>{% trans "Need More Details?" %}</h2>
    <p>{% trans "For detailed reports, reach out to the Program Manager for that program." %}</p>
</section>

<style>
/* Executive dashboard styles */
.page-header {
    margin-bottom: var(--kn-space-lg, 2rem);
}

.page-subtitle {
    color: var(--pico-muted-color);
    font-size: 0.95rem;
    max-width: 60ch;
}

.data-timestamp {
    color: var(--pico-muted-color);
    font-size: 0.8125rem;
    margin-top: 0;
}

/* Program filter */
.program-filter-form {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: var(--kn-space-lg, 2rem);
}

.program-filter-form label {
    margin-bottom: 0;
    font-size: 0.9rem;
    white-space: nowrap;
}

.program-filter-form select {
    margin-bottom: 0;
    width: auto;
    min-width: 200px;
}

/* Summary cards */
.stats-overview {
    margin-bottom: var(--kn-space-lg, 2rem);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: var(--kn-space-base, 1rem);
}

.stat-card {
    text-align: center;
    padding: var(--kn-space-base, 1rem);
    margin: 0;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.25rem;
}

.stat-label {
    color: var(--pico-muted-color);
    font-size: 0.875rem;
}

.stat-flag {
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.stat-success .stat-value { color: var(--kn-success-fg); }
.stat-warning .stat-value { color: var(--kn-warning-fg); }
.stat-warning .stat-flag { color: var(--kn-warning-fg); }
.stat-alert .stat-value { color: var(--kn-danger-fg); }
.stat-alert .stat-flag { color: var(--kn-danger-fg); }

/* Program cards */
.program-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--kn-space-base, 1rem);
}

.program-card {
    margin: 0;
}

.program-card header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: var(--kn-space-sm, 0.5rem);
}

.program-card h3 {
    margin: 0;
    font-size: 1.1rem;
}

.program-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
}

.program-metrics {
    font-size: 0.9rem;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    padding: 0.25rem 0;
}

.metric-label {
    color: var(--pico-muted-color);
}

.metric-value {
    font-weight: 600;
}

.metric-row.highlight {
    background: var(--pico-card-sectionning-background-color);
    margin: 0 -1rem;
    padding: 0.25rem 1rem;
}

.metric-success .metric-value { color: var(--kn-success-fg); }
.metric-neutral .metric-value { color: var(--pico-muted-color); }
.metric-warning .metric-value { color: var(--kn-warning-fg); }
.metric-alert .metric-value { color: var(--kn-danger-fg); }

.program-metrics hr {
    margin: 0.5rem 0;
    border: none;
    border-top: 1px solid var(--pico-muted-border-color);
}

.metric-link {
    font-size: 0.8125rem;
    color: var(--pico-primary);
    text-decoration: none;
}
.metric-link:hover { text-decoration: underline; }

/* Theme compact list (per-program cards) */
.theme-compact-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.theme-compact-list li {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0.15rem 0;
    font-size: 0.85rem;
    gap: 0.25rem;
}

.theme-name-compact {
    flex: 1;
    min-width: 0;
    /* Prefixed properties required — no unprefixed equivalent exists.
       Supported in all modern browsers (Chrome, Firefox 68+, Safari, Edge). */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.theme-count {
    color: var(--pico-muted-color);
    font-weight: 600;
}

.badge-sm {
    font-size: 0.7rem;
    padding: 1px 5px;
    flex-shrink: 0;
    white-space: nowrap;
}

/* Guidance */
.executive-guidance {
    margin-top: var(--kn-space-lg, 2rem);
    padding: var(--kn-space-base, 1rem);
    background: var(--pico-card-sectionning-background-color);
    border-radius: var(--pico-border-radius);
}

.executive-guidance h2 {
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.executive-guidance p {
    margin: 0;
    color: var(--pico-muted-color);
    font-size: 0.9rem;
}
</style>
{% endblock %}
