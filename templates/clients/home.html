{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Home" %} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<!-- Organization header -->
<header class="org-header">
    <div class="org-brand">
        <h1 class="org-name">{{ org_name }}</h1>
        <p class="org-tagline">{% trans "Participant Outcome Management" %}</p>
    </div>
    <div class="org-welcome">
        {% blocktrans with name=user.first_name|default:user.display_name %}Welcome back, <strong>{{ name }}</strong>{% endblocktrans %}
    </div>
</header>

<!-- First-time onboarding banner (QA-W19) — dismissed permanently via localStorage -->
<article class="onboarding-banner" id="onboarding-banner" role="complementary" aria-label="{% trans 'Welcome banner' %}" hidden>
    <header>
        <strong>{% trans "Welcome to KoNote! Need help getting started?" %}</strong>
        <button type="button" class="close-btn" id="dismiss-onboarding" aria-label="{% trans 'Dismiss welcome banner' %}">&times;</button>
    </header>
    <ul>
        <li>{% blocktrans with clients=term.client_plural|default:"participants" %}Use the search bar to find {{ clients }}, or the "+ New" button to register one{% endblocktrans %}</li>
        <li>{% blocktrans with client=term.client|default:"participant" %}Open a {{ client }} profile to view their plan, notes, and progress{% endblocktrans %}</li>
        <li>{% trans "Need help? Ask your program manager or administrator" %}</li>
    </ul>
    <p class="onboarding-help-link"><a href="{% url 'help' %}">{% trans "View help guide" %} &rarr;</a></p>
</article>

<!-- Search and actions bar -->
<div class="search-bar">
    <form id="search-filters">
        <div class="search-input-wrapper">
            <label for="client-search" class="search-label">{% blocktrans with clients=term.client_plural|default:"participants" %}Search {{ clients }}{% endblocktrans %}</label>
            <input type="search"
                   id="client-search"
                   name="q"
                   autofocus
                   placeholder="{% trans 'Name or ID...' %}"
                   aria-label="{% blocktrans with clients=term.client_plural|default:'participants' %}Search {{ clients }}{% endblocktrans %}"
                   hx-get="{% url 'clients:client_search' %}"
                   hx-trigger="input changed delay:300ms"
                   hx-target="#search-results"
                   hx-include="#search-filters"
                   hx-indicator="#loading-bar">
        </div>
    </form>
    <div class="search-actions" role="group">
        {% if can_create %}<a href="{% url 'clients:client_create' %}" role="button">+ {% blocktrans with client=term.client|default:"Participant" %}New {{ client }}{% endblocktrans %}</a>{% endif %}
        <a href="{% url 'clients:client_list' %}" role="button" class="outline">{% trans "View All" %}</a>
    </div>
</div>

<!-- Search filters -->
<details class="search-filters-panel">
    <summary>{% trans "Search filters" %}</summary>
    <div class="filter-row">
        <div class="filter-field">
            <label for="filter-status">{% trans "Status" %}</label>
            <select id="filter-status"
                    name="status"
                    form="search-filters"
                    hx-get="{% url 'clients:client_search' %}"
                    hx-target="#search-results"
                    hx-include="#search-filters"
                    hx-indicator="#loading-bar">
                <option value="">{% trans "All statuses" %}</option>
                <option value="active">{% trans "Active" %}</option>
                <option value="inactive">{% trans "Inactive" %}</option>
                <option value="discharged">{% trans "Discharged" %}</option>
            </select>
        </div>
        {% if features.programs and accessible_programs %}
        <div class="filter-field">
            <label for="filter-program">{{ term.program|default:"Program" }}</label>
            <select id="filter-program"
                    name="program"
                    form="search-filters"
                    hx-get="{% url 'clients:client_search' %}"
                    hx-target="#search-results"
                    hx-include="#search-filters"
                    hx-indicator="#loading-bar">
                <option value="">{% blocktrans with programs=term.program_plural|default:"programs" %}All {{ programs }}{% endblocktrans %}</option>
                {% for prog in accessible_programs %}
                <option value="{{ prog.pk }}">{{ prog.translated_name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <div class="filter-field">
            <label for="filter-date-from">{% trans "Created after" %}</label>
            <input type="date"
                   id="filter-date-from"
                   name="date_from"
                   form="search-filters"
                   hx-get="{% url 'clients:client_search' %}"
                   hx-trigger="change"
                   hx-target="#search-results"
                   hx-include="#search-filters"
                   hx-indicator="#loading-bar">
        </div>
        <div class="filter-field">
            <label for="filter-date-to">{% trans "Created before" %}</label>
            <input type="date"
                   id="filter-date-to"
                   name="date_to"
                   form="search-filters"
                   hx-get="{% url 'clients:client_search' %}"
                   hx-trigger="change"
                   hx-target="#search-results"
                   hx-include="#search-filters"
                   hx-indicator="#loading-bar">
        </div>
    </div>
</details>

<!-- Search results (hidden until search) -->
<div id="search-results" aria-live="polite">
    {% include "clients/_search_results.html" %}
</div>

{% if is_executive %}
  {% include "clients/_dashboard_executive_summary.html" %}
{% elif is_pm %}
  {% include "clients/_dashboard_pm_summary.html" %}
{% elif is_receptionist %}
<!-- Front Desk orientation (UX-FRONTDESK1) -->
<article class="orientation-card">
    <header class="card-header"><span>{% trans "Your Front Desk Tools" %}</span></header>
    <ul class="card-list">
        <li>{% blocktrans with clients=term.client_plural|default:"participants" %}Search for {{ clients }} using the search bar above{% endblocktrans %}</li>
        <li>{% blocktrans with client=term.client|default:"participant" %}Register a new {{ client }} using the "+ New" button{% endblocktrans %}</li>
        <li>{% trans "Update contact information on any profile you can access" %}</li>
        <li>{% trans "Leave messages for staff on a participant's profile" %}</li>
    </ul>
    <footer class="card-footer">
        <small class="secondary">{% trans "Need access to something else? Ask your program manager." %}</small>
    </footer>
</article>
{% endif %}

<!-- Stats row (clinical staff only — Front Desk and executives don't need these) -->
{% if not is_receptionist and not is_executive %}
<div class="stats-row">
    <dl class="stat-card">
        <dt>{% blocktrans with clients=term.client_plural|default:"Participants" %}Active {{ clients }}{% endblocktrans %}</dt>
        <dd class="stat-value">{{ active_count }}</dd>
        <dd class="stat-subtext">{% blocktrans with total=total_count %}of {{ total }} total{% endblocktrans %}</dd>
    </dl>
    <dl class="stat-card{% if alert_count > 0 %} stat-card-alert{% endif %}">
        <dt>{% if alert_count > 0 %}<span class="stat-icon" aria-hidden="true">&#9888;</span> {% endif %}{% trans "Active Alerts" %}</dt>
        <dd class="stat-value">{{ alert_count }}</dd>
        <dd class="stat-subtext">{% trans "requiring action" %}</dd>
    </dl>
    <dl class="stat-card{% if needs_attention_count > 0 %} stat-card-warning{% endif %}">
        <dt>{% trans "Needs Attention" %}</dt>
        <dd class="stat-value">{{ needs_attention_count }}</dd>
        <dd class="stat-subtext">{% trans "no notes in 30 days" %}</dd>
    </dl>
    <dl class="stat-card">
        <dt>{% trans "Notes Today" %}</dt>
        <dd class="stat-value">{{ notes_today_count }}</dd>
        <dd class="stat-subtext">{% trans "recorded" %}</dd>
    </dl>
    <dl class="stat-card{% if follow_up_count > 0 %} stat-card-warning{% endif %}">
        <dt>{% trans "Follow-ups Due" %}</dt>
        <dd class="stat-value">{{ follow_up_count }}</dd>
        <dd class="stat-subtext">{% trans "need your attention" %}</dd>
    </dl>
</div>
{% endif %}

<!-- Quick links — moved up for faster access (UX-TASKDASH1) -->
{% if features.programs or user.is_admin %}
<nav class="quick-links" aria-label="{% trans 'Quick links' %}">
    <span class="quick-links-label">{% trans "Quick links:" %}</span>
    {% if features.programs %}
    <a href="{% url 'programs:program_list' %}">{{ term.program_plural|default:"Programs" }}</a>
    {% endif %}
    {% if user.is_admin %}
    <a href="{% url 'reports:export_form' %}">{% trans "Reports" %}</a>
    <a href="{% url 'admin_settings:dashboard' %}">{% trans "Settings" %}</a>
    {% endif %}
</nav>
{% endif %}

<!-- Two-column dashboard -->
<div class="dashboard-grid">
    <!-- Priority items (alerts + needs attention) — hidden from Front Desk and executives -->
    {% if not is_receptionist and not is_executive %}
    <article>
        <header class="card-header">
            <span>{% trans "What needs your attention" %}</span>
            {% if alert_count > 0 or needs_attention_count > 0 or follow_up_count > 0 %}
            <span class="badge badge-warning">{{ alert_count|add:needs_attention_count|add:follow_up_count }}</span>
            {% endif %}
        </header>
        {% if active_alerts %}
        <div class="priority-section">
            <h2 class="priority-label"><span class="stat-icon" aria-hidden="true">&#9888;</span> {% trans "Alerts" %}</h2>
            <ul class="card-list">
                {% for alert in active_alerts %}
                <li class="priority-item priority-alert dismissable-item" data-dismiss-key="alert-{{ alert.pk }}">
                    <a href="{% url 'clients:client_detail' client_id=alert.client_file.pk %}">
                        {{ alert.client_file.display_name }} {{ alert.client_file.last_name }}
                    </a>
                    <span class="priority-detail">{{ alert.content|truncatechars:40 }}</span>
                    <small class="secondary">{{ alert.created_at|date:"M j" }}</small>
                    <button type="button" class="dismiss-btn outline secondary" aria-label="{% trans 'Dismiss' %}" title="{% trans 'Dismiss for today' %}">&times;</button>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% if pending_follow_ups %}
        <div class="priority-section">
            <h2 class="priority-label">{% trans "Follow-ups Due" %}</h2>
            <ul class="card-list">
                {% for note in pending_follow_ups %}
                <li class="priority-item{% if note.follow_up_date < today %} priority-overdue{% endif %} dismissable-item" data-dismiss-key="followup-{{ note.pk }}">
                    <a href="{% url 'clients:client_detail' client_id=note.client_file.pk %}">
                        {{ note.client_file.display_name }} {{ note.client_file.last_name }}
                    </a>
                    <span class="priority-detail">{{ note.notes_text|truncatechars:40 }}</span>
                    <small class="secondary">{{ note.follow_up_date|date:"M j" }}</small>
                    <button type="button" class="dismiss-btn outline secondary" aria-label="{% trans 'Dismiss' %}" title="{% trans 'Dismiss for today' %}">&times;</button>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% if needs_attention %}
        <div class="priority-section">
            <h2 class="priority-label">{% trans "No Recent Notes" %}</h2>
            <ul class="card-list">
                {% for item in needs_attention %}
                <li class="priority-item dismissable-item" data-dismiss-key="attention-{{ item.client.pk }}">
                    <a href="{% url 'clients:client_detail' client_id=item.client.pk %}">{{ item.name }}</a>
                    <span class="priority-detail secondary">{% trans "30+ days without notes" %}</span>
                    <button type="button" class="dismiss-btn outline secondary" aria-label="{% trans 'Dismiss' %}" title="{% trans 'Dismiss for today' %}">&times;</button>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% if not active_alerts and not pending_follow_ups and not needs_attention %}
        <p class="empty-message"><em>{% trans "All caught up! No items need attention." %}</em></p>
        {% endif %}
    </article>
    {% endif %}

    <!-- Recent activity -->
    <article>
        <header class="card-header">
            <span>{% trans "Pick up where you left off" %}</span>
        </header>
        {% if recent_clients %}
        <ul class="card-list">
            {% for item in recent_clients %}
            <li>
                <a href="{% url 'clients:client_detail' client_id=item.client.pk %}">{{ item.name }}</a>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-message"><em>{% blocktrans with clients=term.client_plural|default:"participants" %}No recent {{ clients }} yet. Start by searching above.{% endblocktrans %}</em></p>
        {% endif %}
        <footer class="card-footer">
            <a href="{% url 'clients:client_list' %}" class="outline" role="button">{% blocktrans with clients=term.client_plural|default:"participants" %}View all {{ clients }}{% endblocktrans %} &rarr;</a>
        </footer>
    </article>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// BUG-19: Dismissable priority items (localStorage, expires daily)
(function () {
    var today = new Date().toISOString().slice(0, 10);
    var storageKey = "konote_dismissed_" + today;
    var dismissed;
    try { dismissed = JSON.parse(localStorage.getItem(storageKey)) || {}; } catch (e) { dismissed = {}; }

    // Clean up old days
    try {
        for (var i = 0; i < localStorage.length; i++) {
            var k = localStorage.key(i);
            if (k && k.indexOf("konote_dismissed_") === 0 && k !== storageKey) {
                localStorage.removeItem(k);
            }
        }
    } catch (e) { /* ignore */ }

    // Hide already-dismissed items
    document.querySelectorAll(".dismissable-item").forEach(function (item) {
        var key = item.getAttribute("data-dismiss-key");
        if (key && dismissed[key]) item.hidden = true;
    });

    // Dismiss on click
    document.querySelectorAll(".dismiss-btn").forEach(function (btn) {
        btn.addEventListener("click", function (e) {
            e.preventDefault();
            var item = btn.closest(".dismissable-item");
            if (!item) return;
            var key = item.getAttribute("data-dismiss-key");
            item.hidden = true;
            if (key) {
                dismissed[key] = true;
                try { localStorage.setItem(storageKey, JSON.stringify(dismissed)); } catch (e) { /* ignore */ }
            }
        });
    });
})();
</script>
{% endblock %}
