{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ term.client_plural|default:"Participants" }} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<div class="page-header page-header--with-action">
    <div>
        <h1>{{ term.client_plural|default:"Participants" }}</h1>
        <p>{% blocktrans with client=term.client|default:"participant" %}All {{ client }} files you have access to.{% endblocktrans %}</p>
    </div>
    {% if can_create %}
    <a href="{% url 'clients:client_create' %}" role="button" class="page-header__action">{% blocktrans with client=term.client|default:"Participant" %}New {{ client }}{% endblocktrans %}</a>
    {% endif %}
</div>

<!-- Search and filters — combined toolbar -->
<form id="client-filters" class="client-toolbar" role="search">
    <div class="client-toolbar__search">
        <input type="search"
               id="client-search"
               name="q"
               placeholder="{% trans 'Search by name, ID, or note content...' %}"
               value="{{ search_query }}"
               aria-label="{% blocktrans with clients=term.client_plural|default:'participants' %}Search {{ clients }}{% endblocktrans %}"
               hx-get="{% url 'clients:client_list' %}"
               hx-trigger="input changed delay:300ms"
               hx-target="#client-list-container"
               hx-include="#client-filters"
               hx-indicator="#loading-bar">
    </div>
    <div class="client-toolbar__filters">
        <div class="filter-field">
            <label for="filter-status" class="visually-hidden">{% trans "Filter by status" %}</label>
            <select id="filter-status"
                    name="status"
                    title="{% trans 'Filter by status' %}"
                    hx-get="{% url 'clients:client_list' %}"
                    hx-target="#client-list-container"
                    hx-include="#client-filters"
                    hx-indicator="#loading-bar"
                    hx-push-url="true">
                <option value="">{% trans "All statuses" %}</option>
                <option value="active"{% if status_filter == "active" %} selected{% endif %}>{% trans "Active" %}</option>
                <option value="inactive"{% if status_filter == "inactive" %} selected{% endif %}>{% trans "Inactive" %}</option>
                <option value="discharged"{% if status_filter == "discharged" %} selected{% endif %}>{% trans "Discharged" %}</option>
            </select>
        </div>
        {% if features.programs and accessible_programs %}
        <div class="filter-field">
            <label for="filter-program" class="visually-hidden">{% blocktrans with program=term.program|default:"Program" %}Filter by {{ program }}{% endblocktrans %}</label>
            <select id="filter-program"
                    name="program"
                    title="{% blocktrans with program=term.program|default:"Program" %}Filter by {{ program }}{% endblocktrans %}"
                    hx-get="{% url 'clients:client_list' %}"
                    hx-target="#client-list-container"
                    hx-include="#client-filters"
                    hx-indicator="#loading-bar"
                    hx-push-url="true">
                <option value="">{% blocktrans with programs=term.program_plural|default:"programs" %}All {{ programs }}{% endblocktrans %}</option>
                {% for prog in accessible_programs %}
                <option value="{{ prog.pk }}"{% if program_filter == prog.pk|stringformat:"d" %} selected{% endif %}>{{ prog.translated_name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        {% if has_plan_edit_programs %}
        <div class="filter-field">
            <label class="filter-checkbox">
                <input type="checkbox"
                       id="filter-editable"
                       name="editable"
                       value="1"
                       {% if editable_filter %}checked{% endif %}
                       hx-get="{% url 'clients:client_list' %}"
                       hx-target="#client-list-container"
                       hx-include="#client-filters"
                       hx-indicator="#loading-bar"
                       hx-push-url="true">
                {% trans "Can edit plans" %}
            </label>
        </div>
        {% endif %}
        <a href="{% url 'clients:client_list' %}" class="client-toolbar__clear">{% trans "Clear" %}</a>
    </div>
</form>

<!-- Screen reader loading announcement (BLOCKER-1 / WCAG 4.1.3) -->
<div id="search-status" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>

<!-- Client list container (updated via HTMX) -->
<div id="client-list-container" aria-live="polite">
    {% include "clients/_client_list_table.html" %}
</div>

{% if show_bulk %}
<!-- Bulk action bar (UX17) — hidden until checkboxes are selected -->
<div id="bulk-action-bar" class="bulk-action-bar" hidden aria-live="polite">
    <span id="bulk-count" class="bulk-action-bar__count"></span>
    <div class="bulk-action-bar__actions">
        {% if can_bulk_status %}
        <button type="button"
                id="bulk-status-btn"
                class="btn btn-secondary btn-sm"
                hx-post="{% url 'clients:bulk_status' %}"
                hx-target="#bulk-modal-container"
                hx-swap="innerHTML"
                aria-label="{% trans 'Change status for selected participants' %}">{% trans "Change Status" %}</button>
        {% endif %}
        {% if can_bulk_transfer %}
        <button type="button"
                id="bulk-transfer-btn"
                class="btn btn-secondary btn-sm"
                hx-post="{% url 'clients:bulk_transfer' %}"
                hx-target="#bulk-modal-container"
                hx-swap="innerHTML"
                aria-label="{% blocktrans with programs=term.program_plural|default:'programs' %}Transfer selected participants between {{ programs }}{% endblocktrans %}">{% trans "Transfer Programs" %}</button>
        {% endif %}
    </div>
</div>

<!-- Bulk modal container (filled by HTMX) -->
<div class="modal-backdrop" id="bulk-modal-backdrop" hidden></div>
<div id="bulk-modal-container" class="bulk-modal" hidden role="dialog" aria-labelledby="bulk-modal-title" aria-modal="true" tabindex="-1"></div>
{% endif %}
{% endblock %}
