{% extends "base.html" %}
{% load i18n %}

{% block title %}{% if editing %}{% blocktrans with client=term.client|default:"Participant" %}Edit {{ client }}{% endblocktrans %}{% else %}{% blocktrans with client=term.client|default:"Participant" %}New {{ client }}{% endblocktrans %}{% endif %} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
{% include "_breadcrumbs.html" %}
<hgroup>
    <h1>{% if editing %}{% blocktrans with first=client.display_name last=client.last_name %}Edit {{ first }} {{ last }}{% endblocktrans %}{% else %}{% blocktrans with client=term.client|default:"Participant" %}New {{ client }}{% endblocktrans %}{% endif %}</h1>
</hgroup>

<form method="post" novalidate>
    {% csrf_token %}

    {% include "includes/_form_errors.html" %}

    <div id="duplicate-banner" aria-live="polite"></div>
    {% if editing %}<input type="hidden" name="exclude" value="{{ client.pk }}">{% endif %}

    <div class="grid">
        <div>
            <label for="id_first_name">{% trans "First Name" %} <abbr title="{% trans 'required' %}">*</abbr></label>
            <input type="text" name="first_name" id="id_first_name" value="{{ form.first_name.value|default:'' }}" required {% if not editing and not form.errors %}autofocus{% endif %}{% if form.first_name.errors %} aria-invalid="true" aria-describedby="err_first_name"{% endif %}
                   hx-get="{% url 'clients:check_duplicate' %}"
                   hx-trigger="input[this.value.length >= 3 && document.getElementById('id_birth_date').value !== ''] changed delay:1s"
                   hx-target="#duplicate-banner"
                   hx-include="[name='phone'], [name='first_name'], [name='birth_date'], [name='exclude']"
                   hx-sync="#duplicate-banner:replace">
            {% if form.first_name.errors %}<small class="error" id="err_first_name" role="alert">{{ form.first_name.errors.0 }}</small>{% endif %}
        </div>
        <div>
            <label for="id_last_name">{% trans "Last Name" %} <abbr title="{% trans 'required' %}">*</abbr></label>
            <input type="text" name="last_name" id="id_last_name" value="{{ form.last_name.value|default:'' }}" required{% if form.last_name.errors %} aria-invalid="true" aria-describedby="err_last_name"{% endif %}>
            {% if form.last_name.errors %}<small class="error" id="err_last_name" role="alert">{{ form.last_name.errors.0 }}</small>{% endif %}
        </div>
    </div>

    <div class="grid">
        <div>
            <label for="id_preferred_name">{% trans "Preferred Name" %}</label>
            <input type="text" name="preferred_name" id="id_preferred_name" value="{{ form.preferred_name.value|default:'' }}" placeholder="{% trans "What do you prefer to be called?" %}">
            <small>{% trans "Leave blank if same as first name" %}</small>
        </div>
        <div>
            <label for="id_middle_name">{% trans "Middle Name" %}</label>
            <input type="text" name="middle_name" id="id_middle_name" value="{{ form.middle_name.value|default:'' }}">
        </div>
    </div>

    <div class="grid">
        <div>
            <label for="id_phone">{% trans "Phone Number" %}</label>
            <input type="tel" name="phone" id="id_phone" value="{{ form.phone.value|default:'' }}" placeholder="(613) 555-1234"{% if form.phone.errors %} aria-invalid="true" aria-describedby="err_phone"{% endif %}
                   hx-get="{% url 'clients:check_duplicate' %}"
                   hx-trigger="input changed delay:500ms"
                   hx-target="#duplicate-banner"
                   hx-include="[name='phone'], [name='first_name'], [name='birth_date'], [name='exclude']"
                   hx-sync="#duplicate-banner:replace">
            {% if form.phone.errors %}<small class="error" id="err_phone" role="alert">{{ form.phone.errors.0 }}</small>{% endif %}
        </div>
        <div></div>
    </div>

    <div class="grid">
        <div>
            <label for="id_birth_date">{% trans "Date of Birth" %}</label>
            <input type="date" name="birth_date" id="id_birth_date" value="{{ form.birth_date.value|default:'' }}"
                   data-year-shortcut="true"
                   hx-get="{% url 'clients:check_duplicate' %}"
                   hx-trigger="change"
                   hx-target="#duplicate-banner"
                   hx-include="[name='phone'], [name='first_name'], [name='birth_date'], [name='exclude']"
                   hx-sync="#duplicate-banner:replace">
            <small>{% trans "Tip: You can type a 4-digit year (for example 1955) and the date will jump to that year." %}</small>
        </div>
        <div>
            <label for="id_record_id">{% trans "Record ID" %}</label>
            <input type="text" name="record_id" id="id_record_id" value="{{ form.record_id.value|default:'' }}">
        </div>
    </div>

    <div class="grid">
        <div>
            <label for="id_status">{% trans "Status" %}</label>
            <select name="status" id="id_status">
                {% for value, label in form.status.field.choices %}
                <option value="{{ value }}" {% if form.status.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div></div>
    </div>

    {% if form.programs.field.queryset.exists %}
    <fieldset>
        <legend>{{ term.program_plural|default:"Programs" }}</legend>
        {% for program in form.programs.field.queryset %}
        <label>
            <input type="checkbox" name="programs" value="{{ program.pk }}"
                   {% if program.pk in form.programs.value or program.pk|stringformat:"d" in form.programs.value %}checked{% endif %}>
            <span class="program-dot" style="background-color: {{ program.colour_hex }}" aria-hidden="true"></span>
            {{ program.translated_name }}
        </label>
        {% endfor %}
    </fieldset>
    {% endif %}

    {% if form.existing_circle %}
    <fieldset>
        <legend>{{ term.circle|default:"Circle" }}</legend>
        <small>{% blocktrans with circle=term.circle|default:"circle" %}Optional — link to an existing {{ circle }} or create a new one.{% endblocktrans %}</small>

        <label for="id_existing_circle">{% blocktrans with circle=term.circle|default:"circle" %}Link to existing {{ circle }}{% endblocktrans %}</label>
        {{ form.existing_circle }}
        {% if form.existing_circle.errors %}<small class="error" role="alert">{{ form.existing_circle.errors.0 }}</small>{% endif %}

        <label for="id_new_circle_name">{% blocktrans with circle=term.circle|default:"circle" %}Or create a new {{ circle }}{% endblocktrans %}</label>
        {{ form.new_circle_name }}
        {% if form.new_circle_name.errors %}<small class="error" role="alert">{{ form.new_circle_name.errors.0 }}</small>{% endif %}
    </fieldset>
    {% endif %}

    <div role="group">
        <button type="submit">{% if editing %}{% trans "Save Changes" %}{% else %}{% blocktrans with client=term.client|default:"Participant" %}Create {{ client }}{% endblocktrans %}{% endif %}</button>
        {% if editing %}
        <a href="{% url 'clients:client_detail' client_id=client.pk %}" role="button" class="outline">{% trans "Cancel" %}</a>
        {% else %}
        <a href="{% url 'clients:client_list' %}" role="button" class="outline">{% trans "Cancel" %}</a>
        {% endif %}
    </div>
</form>
{% endblock %}
