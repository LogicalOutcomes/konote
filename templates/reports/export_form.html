{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Program Outcome Report" %} ‚Äî {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% trans "Program Outcome Report" %}</h1>
    <p>{% trans "Generate a report of aggregate metric data for a program and date range." %}</p>
</hgroup>

{% if no_data %}
<article aria-label="{% trans 'No results' %}">
    <p><strong>{% trans "No data found." %}</strong> {% trans "There are no metric values matching the selected program, metrics, and date range. Try adjusting your filters." %}</p>
</article>
{% endif %}

{% if is_aggregate_only %}
<article aria-label="{% trans 'Aggregate Export Info' %}" style="margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">üìä</span> {% trans "Aggregate Data Only" %}</strong>
    <p style="margin-bottom: 0;">
        {% trans "This export contains summary statistics only: averages, counts, minimums, and maximums per metric. No individual participant record IDs, names, or staff information are included." %}
    </p>
</article>
{% else %}
<article aria-label="{% trans 'What this export contains' %}" style="margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">üìã</span> {% trans "What This Export Contains" %}</strong>
    <p>{% trans "Each row in the exported file represents one metric value recorded for one participant. The columns are:" %}</p>
    <ul style="margin-bottom: 0.5rem;">
        <li>{% trans "Client Record ID (an internal number ‚Äî not the participant's name)" %}</li>
        <li>{% trans "Metric Name" %}</li>
        <li>{% trans "Value" %}</li>
        <li>{% trans "Date of Service" %}</li>
        <li>{% trans "Author (the staff member who recorded the value)" %}</li>
    </ul>
    <p style="margin-bottom: 0;">
        {% trans "If demographic grouping is selected, an additional column will show the group label (e.g. age range) ‚Äî not the underlying birth date or field value." %}
    </p>
</article>

<article aria-label="{% trans 'Personal information notice' %}" role="alert" style="background: var(--kn-warning-bg); border-left: 4px solid var(--kn-warning-fg); padding: 1rem; margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">‚ö†Ô∏è</span> {% trans "Personal information notice" %}</strong>
    <p>
        {% blocktrans with strong_open="<strong>" strong_close="</strong>" %}This export {{ strong_open }}does not{{ strong_close }} contain participant names, contact information, addresses, or session notes. However, it {{ strong_open }}does{{ strong_close }} contain client record IDs and staff names, which are considered personal information.{% endblocktrans %}
    </p>
    <p style="margin-bottom: 0;">
        {% trans "Handle the exported file according to your organisation's data protection policies." %}
    </p>
</article>

{% if is_pm_export %}
<article aria-label="{% trans 'Elevated export notice' %}" style="background: var(--kn-warning-bg); border-left: 4px solid var(--kn-warning-fg); padding: 1rem; margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">&#x23F3;</span> {% trans "Elevated Export ‚Äî Delay Applied" %}</strong>
    <p style="margin-bottom: 0;">
        {% blocktrans with minutes=delay_minutes %}Because this export contains individual client data, a {{ minutes }}-minute delay will be applied before the download link becomes active. Administrators will be notified by email.{% endblocktrans %}
    </p>
</article>
{% endif %}
{% endif %}

<form method="post">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <article aria-label="{% trans 'Form errors' %}" role="alert" style="background: var(--kn-danger-bg); color: var(--kn-danger-fg);">
        {% for error in form.non_field_errors %}
        <p>{{ error }}</p>
        {% endfor %}
    </article>
    {% endif %}

    {# 1. Program dropdown #}
    <label for="{{ form.program.id_for_label }}">
        {{ form.program.label }}
        {{ form.program }}
    </label>
    {% if form.program.errors %}
    <small class="error" role="alert">{{ form.program.errors.0 }}</small>
    {% endif %}

    {# 2. Report template (optional) ‚Äî auto-fills downstream fields #}
    {% if form.report_template %}
    <label for="{{ form.report_template.id_for_label }}">
        {{ form.report_template.label }}
        {{ form.report_template }}
        {% if form.report_template.help_text %}
        <small>{{ form.report_template.help_text }}</small>
        {% endif %}
        {% if form.report_template.errors %}
        <small class="error" role="alert">{{ form.report_template.errors.0 }}</small>
        {% endif %}
    </label>

    {# Dynamic preview: shows breakdowns for the selected template #}
    {% for preview_template in template_preview_items %}
    <article class="template-preview" data-template-id="{{ preview_template.pk }}"
             style="display: none; margin-bottom: 1rem; border-left: 4px solid var(--kn-info-fg); padding: 0.75rem 1rem;"
             aria-live="polite">
        <strong>{{ preview_template.name }}</strong>
        {% if preview_template.description %}
        <br><small class="secondary">{{ preview_template.description }}</small>
        {% endif %}

        <p style="margin-top: 0.5rem; margin-bottom: 0.25rem;"><strong>{% trans "Demographic breakdowns in this template:" %}</strong></p>
        {% for bd in preview_template.breakdowns.all %}
        <p style="margin-bottom: 0.25rem; padding-left: 1rem;"><strong>{{ bd.label }}</strong> ‚Äî
            {% if bd.source_type == "age" %}
            {% trans "Age" %}
            {% else %}
            {% trans "Custom field" %}{% if bd.custom_field %}: {{ bd.custom_field.name }}{% endif %}
            {% endif %}
        </p>
        {% if bd.source_type == "age" and bd.bins_json %}
        <ul style="margin-top: 0; margin-bottom: 0.5rem; padding-left: 2rem;">
            {% for age_bin in bd.bins_json %}
            <li>{{ age_bin.label }}</li>
            {% endfor %}
        </ul>
        {% elif bd.source_type == "custom_field" %}
        <p style="margin-top: 0; margin-bottom: 0.5rem; padding-left: 1rem;">
            <small>
                {% if bd.keep_all_categories %}
                {% trans "Keeps all source categories" %}
                {% elif bd.merge_categories_json %}
                {% blocktrans with count=bd.merge_categories_json|length %}Includes {{ count }} category merge group(s){% endblocktrans %}
                {% else %}
                {% trans "No category merges configured" %}
                {% endif %}
            </small>
        </p>
        {% endif %}
        {% empty %}
        <p><small>{% trans "No demographic breakdowns configured." %}</small></p>
        {% endfor %}
    </article>
    {% endfor %}
    {% endif %}

    {% if show_template_hint %}
    <p style="color: var(--pico-muted-color); margin-bottom: 1rem;">
        <small>
            {% blocktrans with settings_url="/admin/settings/report-templates/" %}
            <strong>Admin tip:</strong> You have report templates configured, but none are linked to programs yet.
            To use them here, go to <a href="{{ settings_url }}">Settings &rarr; Report Templates</a>,
            open a template, and assign it to the relevant program(s).
            {% endblocktrans %}
        </small>
    </p>
    {% endif %}

    {# Consortium warning (shown dynamically when template is selected) #}
    <div id="consortium-warning" style="display: none;">
        <article aria-label="{% trans 'Consortium notice' %}" style="background: var(--kn-info-bg); border-left: 4px solid var(--kn-info-fg); padding: 1rem; margin-bottom: 1rem;">
            <strong>{% trans "Consortium reporting" %}</strong>
            <p style="margin-bottom: 0;" id="consortium-warning-text"></p>
        </article>
    </div>

    {# 3. Fiscal year / Date range #}
    <label for="{{ form.fiscal_year.id_for_label }}">
        {{ form.fiscal_year.label }}
        {{ form.fiscal_year }}
        {% if form.fiscal_year.help_text %}
        <small>{{ form.fiscal_year.help_text }}</small>
        {% endif %}
        {% if form.fiscal_year.errors %}
        <small class="error" role="alert">{{ form.fiscal_year.errors.0 }}</small>
        {% endif %}
    </label>

    <div class="grid">
        <label for="{{ form.date_from.id_for_label }}">
            {{ form.date_from.label }}
            {{ form.date_from }}
            {% if form.date_from.errors %}
            <small class="error" role="alert">{{ form.date_from.errors.0 }}</small>
            {% endif %}
        </label>
        <label for="{{ form.date_to.id_for_label }}">
            {{ form.date_to.label }}
            {{ form.date_to }}
            {% if form.date_to.errors %}
            <small class="error" role="alert">{{ form.date_to.errors.0 }}</small>
            {% endif %}
        </label>
    </div>

    {# 4. Metrics ‚Äî auto-checked from template when selected #}
    <fieldset id="metrics-fieldset">
        <legend>{{ form.metrics.label }}</legend>
        {% if form.metrics.errors %}
        <small class="error" role="alert">{{ form.metrics.errors.0 }}</small>
        {% endif %}
        <div style="margin-bottom: 0.5rem;">
            <a href="#" id="select-all-metrics" class="secondary">{% trans "Select all" %}</a>
            &nbsp;|&nbsp;
            <a href="#" id="deselect-all-metrics" class="secondary">{% trans "Deselect all" %}</a>
        </div>
        {% for checkbox in form.metrics %}
        <label data-metric-id="{{ checkbox.data.value }}">
            {{ checkbox.tag }}
            {{ checkbox.choice_label }}
        </label>
        {% endfor %}
    </fieldset>

    {# 5. Grouping ‚Äî disabled when template selected #}
    <label for="{{ form.group_by.id_for_label }}" id="grouping-container">
        {{ form.group_by.label }}
        {{ form.group_by }}
        <small id="grouping-note">{{ form.group_by.help_text }}</small>
        {% if form.group_by.errors %}
        <small class="error" role="alert">{{ form.group_by.errors.0 }}</small>
        {% endif %}
    </label>

    {# 6. Additional options ‚Äî achievement rate #}
    <fieldset>
        <legend>{% trans "Additional Options" %}</legend>
        <label>
            {{ form.include_achievement_rate }}
            {{ form.include_achievement_rate.label }}
            {% if form.include_achievement_rate.help_text %}
            <small style="display: block; margin-top: 0.25rem;">{{ form.include_achievement_rate.help_text }}</small>
            {% endif %}
        </label>
    </fieldset>

    {# 7. Export format #}
    <fieldset>
        <legend>{{ form.format.label }}</legend>
        {% for radio in form.format %}
        <label>
            {{ radio.tag }}
            {{ radio.choice_label }}
        </label>
        {% endfor %}
    </fieldset>

    {# 8. Recipient details #}
    <fieldset>
        <legend>{% trans "Export recipient details" %}</legend>
        <p class="helper-text" style="margin-bottom: 1rem; color: var(--pico-muted-color);">
            {% trans "For audit purposes, please indicate who will receive this exported data." %}
        </p>
        <label for="{{ form.recipient.id_for_label }}">
            {{ form.recipient.label }}
            {{ form.recipient }}
            {% if form.recipient.help_text %}
            <small>{{ form.recipient.help_text }}</small>
            {% endif %}
            {% if form.recipient.errors %}
            <small class="error" role="alert">{{ form.recipient.errors.0 }}</small>
            {% endif %}
        </label>
        <label for="{{ form.recipient_reason.id_for_label }}" id="recipient-detail-wrapper">
            {{ form.recipient_reason.label }}
            {{ form.recipient_reason }}
            {% if form.recipient_reason.help_text %}
            <small>{{ form.recipient_reason.help_text }}</small>
            {% endif %}
            {% if form.recipient_reason.errors %}
            <small class="error" role="alert">{{ form.recipient_reason.errors.0 }}</small>
            {% endif %}
        </label>
    </fieldset>

    {# 9. Generate / Preview buttons #}
    <input type="hidden" name="preview" id="id_preview" value="">
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <button type="submit" id="btn-generate">{% trans "Generate Report" %}</button>
        <button type="submit" id="btn-preview" class="secondary outline" onclick="document.getElementById('id_preview').value='1';">
            {% trans "Preview on Screen" %}
        </button>
    </div>
</form>

<script>
/**
 * Ad-hoc export form interactivity.
 *
 * 1. Fiscal year auto-fill (Canadian fiscal year: April 1 ‚Äì March 31)
 * 2. Template preview toggle
 * 3. Grouping disable when template selected
 * 4. Template auto-fill: check/uncheck metrics from template
 */
document.addEventListener('DOMContentLoaded', function() {
    var fiscalYearSelect = document.getElementById('id_fiscal_year');
    var dateFromInput = document.getElementById('id_date_from');
    var dateToInput = document.getElementById('id_date_to');
    var templateSelect = document.getElementById('id_report_template');
    var groupBySelect = document.getElementById('id_group_by');

    // 1. Fiscal year / quarter auto-fill
    if (fiscalYearSelect && dateFromInput && dateToInput) {
        fiscalYearSelect.addEventListener('change', function() {
            var val = this.value;
            if (!val) {
                dateFromInput.value = '';
                dateToInput.value = '';
                return;
            }

            function pad(n) { return String(n).padStart(2, '0'); }

            if (val.startsWith('Q')) {
                // Quarter preset, e.g. "Q1-2025"
                var parts = val.split('-');
                var qNum = parseInt(parts[0].substring(1), 10);
                var fyStart = parseInt(parts[1], 10);
                // Q1=Apr-Jun, Q2=Jul-Sep, Q3=Oct-Dec, Q4=Jan-Mar
                // Keep in sync with _QUARTER_STARTS in apps/reports/utils.py
                var qStarts = {1:[fyStart,4], 2:[fyStart,7], 3:[fyStart,10], 4:[fyStart+1,1]};
                var sYear = qStarts[qNum][0], sMonth = qStarts[qNum][1];
                var eMonth = sMonth + 2, eYear = sYear;
                if (eMonth > 12) { eMonth -= 12; eYear += 1; }
                var lastDay = new Date(eYear, eMonth, 0).getDate();
                dateFromInput.value = sYear + '-' + pad(sMonth) + '-01';
                dateToInput.value = eYear + '-' + pad(eMonth) + '-' + pad(lastDay);
            } else {
                // Fiscal year preset (April 1 to March 31)
                var startYear = parseInt(val, 10);
                dateFromInput.value = startYear + '-04-01';
                dateToInput.value = (startYear + 1) + '-03-31';
            }
        });
    }

    if (!templateSelect) return;

    // 2. Template preview toggle
    function showSelectedPreview() {
        var previews = document.querySelectorAll('.template-preview');
        previews.forEach(function(el) { el.style.display = 'none'; });
        var selected = templateSelect.value;
        if (selected) {
            var match = document.querySelector('.template-preview[data-template-id="' + selected + '"]');
            if (match) match.style.display = 'block';
        }
    }
    templateSelect.addEventListener('change', showSelectedPreview);
    showSelectedPreview();

    // 3. Grouping disable
    if (groupBySelect) {
        var groupingContainer = document.getElementById('grouping-container');
        var groupingNote = document.getElementById('grouping-note');
        var defaultHelpText = groupingNote ? groupingNote.textContent : '';
        groupBySelect.setAttribute('aria-describedby', 'grouping-note');

        function toggleGrouping() {
            var templateSelected = templateSelect.value !== '';
            groupBySelect.disabled = templateSelected;
            if (groupingContainer) {
                groupingContainer.style.opacity = templateSelected ? '0.5' : '1';
            }
            if (groupingNote) {
                groupingNote.textContent = templateSelected
                    ? '{% filter escapejs %}{% trans "Grouping is handled by the selected reporting template." %}{% endfilter %}'
                    : defaultHelpText;
            }
        }
        templateSelect.addEventListener('change', toggleGrouping);
        toggleGrouping();
    }

    // 4. Template auto-fill: fetch metric IDs and check/lock checkboxes
    var autofillUrl = '{% url "reports:adhoc_template_autofill" %}';
    var consortiumWarning = document.getElementById('consortium-warning');
    var consortiumText = document.getElementById('consortium-warning-text');
    var currentAutoFillController = null;

    function autoFillFromTemplate() {
        var templateId = templateSelect.value;
        // Reset consortium warning
        if (consortiumWarning) consortiumWarning.style.display = 'none';

        // Cancel any in-flight request
        if (currentAutoFillController) {
            currentAutoFillController.abort();
            currentAutoFillController = null;
        }

        // Reset previously locked checkboxes
        var metricLabels = document.querySelectorAll('#metrics-fieldset label[data-metric-id]');
        metricLabels.forEach(function(label) {
            var checkbox = label.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.disabled = false;
                label.title = '';
            }
            var hidden = label.querySelector('input[type="hidden"][name="metrics"]');
            if (hidden) hidden.remove();
        });

        if (!templateId) return;

        currentAutoFillController = new AbortController();
        fetch(autofillUrl + '?template_id=' + templateId, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            signal: currentAutoFillController.signal
        })
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
            currentAutoFillController = null;
            if (!data.metric_ids || !data.metric_ids.length) return;

            // Check metrics from template
            metricLabels.forEach(function(label) {
                var metricId = parseInt(label.getAttribute('data-metric-id'), 10);
                var checkbox = label.querySelector('input[type="checkbox"]');
                if (!checkbox) return;

                if (data.metric_ids.indexOf(metricId) !== -1) {
                    checkbox.checked = true;
                    // Lock consortium-required metrics
                    if (data.consortium_locked.indexOf(metricId) !== -1) {
                        checkbox.disabled = true;
                        label.title = '{% filter escapejs %}{% trans "Required by consortium reporting standards" %}{% endfilter %}';
                        // Add hidden input so disabled checkbox value still submits
                        var hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.name = 'metrics';
                        hidden.value = metricId;
                        label.appendChild(hidden);
                    }
                }
            });

            // Show consortium warning if applicable (using createElement, not innerHTML)
            if (data.consortium_locked.length > 0 && data.partner_name && consortiumWarning && consortiumText) {
                while (consortiumText.firstChild) consortiumText.removeChild(consortiumText.firstChild);
                consortiumText.appendChild(
                    document.createTextNode('{% filter escapejs %}{% trans "This program reports to a consortium partner. For partner-compliant reports, use the" %}{% endfilter %} ')
                );
                var link = document.createElement('a');
                link.href = '{% url "reports:generate_report" %}';
                link.textContent = '{% filter escapejs %}{% trans "template-driven report" %}{% endfilter %}';
                consortiumText.appendChild(link);
                consortiumText.appendChild(
                    document.createTextNode(' {% filter escapejs %}{% trans "instead." %}{% endfilter %}')
                );
                consortiumWarning.style.display = 'block';
            }
        })
        .catch(function(err) {
            if (err.name === 'AbortError') return; // Expected cancellation
            currentAutoFillController = null;
            console.warn('Template auto-fill failed for template', templateId, err);
        });
    }

    templateSelect.addEventListener('change', autoFillFromTemplate);
    // Auto-fill on page load if template is pre-selected (POST re-render)
    if (templateSelect.value) autoFillFromTemplate();
});
</script>
{% endblock %}
