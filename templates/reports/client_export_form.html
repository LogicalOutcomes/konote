{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Export Participant Data" %} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% trans "Export Participant Data" %}</h1>
    <p>{% blocktrans with name=client_name %}Export all data for {{ name }}.{% endblocktrans %}</p>
</hgroup>

<article aria-label="{% trans 'Privacy notice' %}" style="border-left: 4px solid var(--kn-info-fg); padding: 1rem; margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">&#x1F6C8;</span> {% trans "PIPEDA Data Portability" %}</strong>
    <p style="margin-bottom: 0;">
        {% trans "For security, this export includes participant-identifying information and should only be shared with authorised recipients." %}
    </p>
</article>

{% if duplicate_warning %}
<article aria-label="{% trans 'Duplicate export' %}" role="alert" style="border-left: 4px solid var(--kn-warning-fg); padding: 1rem; margin-bottom: 1.5rem;">
    <strong>{% trans "This export was already submitted." %}</strong>
    <p style="margin-bottom: 0;">{% trans "If you need another copy, please use the form below." %}</p>
</article>
{% endif %}

<form method="post" id="export-form">
    {% csrf_token %}
    <input type="hidden" name="_export_nonce" value="{{ export_nonce }}">

    <fieldset>
        <legend>{% trans "What to include" %}</legend>

        <label>
            <input type="checkbox" name="include_plans" value="1" checked>
            {% trans "Plan sections and targets" %}
        </label>

        <label>
            <input type="checkbox" name="include_notes" value="1" checked>
            {% trans "Progress notes" %}
        </label>

        <label>
            <input type="checkbox" name="include_metrics" value="1" checked>
            {% trans "Metric values" %}
        </label>

        <label>
            <input type="checkbox" name="include_events" value="1" checked>
            {% trans "Events" %}
        </label>

        <label>
            <input type="checkbox" name="include_custom_fields" value="1" checked>
            {% trans "Custom fields" %}
        </label>
    </fieldset>

    <fieldset>
        <legend>{% trans "Format" %}</legend>
        {{ form.format }}
    </fieldset>

    <fieldset>
        <legend>{% trans "Export recipient details" %}</legend>
        <p class="helper-text" style="margin-bottom: 1rem; color: var(--pico-muted-color);">
            {% trans "For security, funders are not valid recipients for participant-identifying exports." %}
        </p>
        <div class="grid">
            <div>
                <label for="id_recipient">{{ form.recipient.label }}</label>
                {{ form.recipient }}
                {% if form.recipient.help_text %}<small>{{ form.recipient.help_text }}</small>{% endif %}
            </div>
            <div>
                <label for="id_recipient_reason">{{ form.recipient_reason.label }}</label>
                {{ form.recipient_reason }}
                {% if form.recipient_reason.help_text %}<small>{{ form.recipient_reason.help_text }}</small>{% endif %}
            </div>
        </div>
    </fieldset>

    {% if form.errors %}
    <article aria-label="{% trans 'Errors' %}" role="alert" style="background: var(--kn-danger-bg); border-left: 4px solid var(--kn-danger-fg); padding: 1rem; margin-bottom: 1.5rem;">
        <strong>{% trans "Please correct the following:" %}</strong>
        <ul>
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                <li>{{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </article>
    {% endif %}

    <div class="grid">
        <button type="submit" id="export-submit-btn">
            <span aria-hidden="true">&#x1F4E5;</span> {% trans "Export Participant Data" %}
        </button>
        <a href="{% url 'clients:client_detail' client_id=client.pk %}" role="button" class="secondary">
            {% trans "Cancel" %}
        </a>
    </div>
</form>

<script>
(function() {
    var form = document.getElementById('export-form');
    var btn = document.getElementById('export-submit-btn');
    if (!form || !btn) return;
    form.addEventListener('submit', function() {
        btn.disabled = true;
        btn.setAttribute('aria-busy', 'true');
        btn.textContent = '{% trans "Exporting…" %}';
    });
})();
</script>
{% endblock %}
