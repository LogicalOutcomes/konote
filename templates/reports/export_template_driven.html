{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Generate Report" %} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% trans "Generate Report" %}</h1>
    <p>{% trans "Select a report template and period to generate a partner-ready report." %}</p>
</hgroup>

<article aria-label="{% trans 'Data Contents' %}" style="margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">&#x1F4CA;</span> {% trans "Aggregate Data Export" %}</strong>
    <p style="margin-bottom: 0;">
        {% blocktrans with strong_open="<strong>" strong_close="</strong>" %}This report contains {{ strong_open }}summary counts only{{ strong_close }} — counts and percentages grouped by category. No personal identifiers are included.{% endblocktrans %}
    </p>
</article>

{% if not has_templates %}
<article aria-label="{% trans 'No templates available' %}" style="background: var(--kn-warning-bg); border-left: 4px solid var(--kn-warning-fg); padding: 1rem;">
    <strong>{% trans "No report templates available" %}</strong>
    <p style="margin-bottom: 0;">
        {% blocktrans %}No report templates have been set up yet. Report templates define what metrics and demographic breakdowns to include. Contact your administrator to configure one, or ask the Program Manager for a custom data export.{% endblocktrans %}
    </p>
</article>
{% else %}

<form method="post">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <article aria-label="{% trans 'Form errors' %}" role="alert" style="background: var(--kn-danger-bg); color: var(--kn-danger-fg);">
        {% for error in form.non_field_errors %}
        <p>{{ error }}</p>
        {% endfor %}
    </article>
    {% endif %}

    {# Report template dropdown — HTMX cascade triggers period panel update #}
    <label for="{{ form.report_template.id_for_label }}">
        {{ form.report_template.label }}
        <select name="report_template" id="{{ form.report_template.id_for_label }}"
                hx-get="{% url 'reports:template_period_options' %}"
                hx-target="#period-panel"
                hx-swap="innerHTML"
                hx-trigger="change"
                hx-vals='js:{"template_id": this.value}'
                {% if form.report_template.errors %}aria-invalid="true" aria-describedby="err_report_template"{% endif %}>
            <option value="">{% trans "— Select a report —" %}</option>
            {% for choice in form.report_template.field.queryset %}
            <option value="{{ choice.pk }}" {% if form.report_template.value|stringformat:"s" == choice.pk|stringformat:"s" %}selected{% endif %}>
                {{ choice.partner.translated_name }} — {{ choice.name }}
            </option>
            {% endfor %}
        </select>
    </label>
    {% if form.report_template.errors %}
    <small class="error" id="err_report_template" role="alert">{{ form.report_template.errors.0 }}</small>
    {% endif %}

    {# Period panel — populated by HTMX after template selection #}
    <div id="period-panel" aria-live="polite">
        {% if form.period.field.choices %}
        {# On POST re-render, show the period field inline #}
        <label for="id_period">
            {{ form.period.label }}
            {{ form.period }}
        </label>
        {% if form.period.errors %}
        <small class="error" role="alert">{{ form.period.errors.0 }}</small>
        {% endif %}
        {% endif %}
        {% if form.date_from.value or form.date_to.value %}
        <div class="grid">
            <label for="id_date_from">
                {{ form.date_from.label }}
                {{ form.date_from }}
                {% if form.date_from.errors %}<small class="error" role="alert">{{ form.date_from.errors.0 }}</small>{% endif %}
            </label>
            <label for="id_date_to">
                {{ form.date_to.label }}
                {{ form.date_to }}
                {% if form.date_to.errors %}<small class="error" role="alert">{{ form.date_to.errors.0 }}</small>{% endif %}
            </label>
        </div>
        {% endif %}
    </div>

    {# Export format #}
    <fieldset>
        <legend>{{ form.format.label }}</legend>
        {% for radio in form.format %}
        <label>
            {{ radio.tag }}
            {{ radio.choice_label }}
        </label>
        {% endfor %}
    </fieldset>

    {# Recipient tracking for audit purposes #}
    <fieldset>
        <legend>{% trans "Export recipient details" %}</legend>
        <p class="helper-text" style="margin-bottom: 1rem; color: var(--pico-muted-color);">
            {% trans "For audit purposes, please indicate who will receive this exported data." %}
        </p>
        <label for="{{ form.recipient.id_for_label }}">
            {{ form.recipient.label }}
            {{ form.recipient }}
            {% if form.recipient.help_text %}
            <small>{{ form.recipient.help_text }}</small>
            {% endif %}
            {% if form.recipient.errors %}
            <small class="error" role="alert">{{ form.recipient.errors.0 }}</small>
            {% endif %}
        </label>
        <label for="{{ form.recipient_reason.id_for_label }}">
            {{ form.recipient_reason.label }}
            {{ form.recipient_reason }}
            {% if form.recipient_reason.help_text %}
            <small>{{ form.recipient_reason.help_text }}</small>
            {% endif %}
            {% if form.recipient_reason.errors %}
            <small class="error" role="alert">{{ form.recipient_reason.errors.0 }}</small>
            {% endif %}
        </label>
    </fieldset>

    <button type="submit">{% trans "Generate Report" %}</button>
</form>
{% endif %}
{% endblock %}
