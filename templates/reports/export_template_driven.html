{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Generate Report" %} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% trans "Generate Report" %}</h1>
    <p>{% trans "Select a report template and period to generate a partner-ready report." %}</p>
</hgroup>

<article aria-label="{% trans 'Data Contents' %}" style="margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">&#x1F4CA;</span> {% trans "Aggregate Data Export" %}</strong>
    <p style="margin-bottom: 0;">
        {% blocktrans with strong_open="<strong>" strong_close="</strong>" %}This report contains {{ strong_open }}summary counts only{{ strong_close }} — counts and percentages grouped by category. No personal identifiers are included.{% endblocktrans %}
    </p>
</article>

{% if not has_templates %}
<article aria-label="{% trans 'No templates available' %}" style="background: var(--kn-warning-bg); border-left: 4px solid var(--kn-warning-fg); padding: 1rem;">
    <strong>{% trans "No report templates available" %}</strong>
    <p>
        {% blocktrans %}No report templates have been set up yet. Report templates define what metrics and demographic breakdowns to include for recurring partner reports. Contact your administrator to create one.{% endblocktrans %}
    </p>
    {% if can_custom_export %}
    <p style="margin-bottom: 0;">
        {% blocktrans %}In the meantime, you can create a one-off report using <strong>Custom Export</strong>, where you choose the program, metrics, and date range yourself.{% endblocktrans %}
    </p>
    <p><a href="{% url 'reports:export_form' %}">{% trans "Go to Custom Export" %}</a></p>
    {% endif %}
    {% if user.is_admin %}
    <p style="margin-bottom: 0;"><a href="{% url 'admin_settings:report_template_list' %}">{% trans "Set up report templates" %}</a></p>
    {% endif %}
</article>
{% else %}

<form method="post">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <article aria-label="{% trans 'Form errors' %}" role="alert" style="background: var(--kn-danger-bg); color: var(--kn-danger-fg);">
        {% for error in form.non_field_errors %}
        <p>{{ error }}</p>
        {% endfor %}
    </article>
    {% endif %}

    {# Report template dropdown — HTMX cascade triggers period panel update #}
    <label for="{{ form.report_template.id_for_label }}">
        {{ form.report_template.label }}
        <select name="report_template" id="{{ form.report_template.id_for_label }}"
                hx-get="{% url 'reports:template_period_options' %}"
                hx-target="#period-panel"
                hx-swap="innerHTML"
                hx-trigger="change"
                hx-indicator="#period-loading"
                hx-params="report_template"
                {% if form.report_template.errors %}aria-invalid="true" aria-describedby="err_report_template"{% endif %}>
            <option value="">{% trans "— Select a report —" %}</option>
            {% for choice in form.report_template.field.queryset %}
            <option value="{{ choice.pk }}" {% if form.report_template.value|stringformat:"s" == choice.pk|stringformat:"s" %}selected{% endif %}>
                {{ choice.name }}
            </option>
            {% endfor %}
        </select>
    </label>
    {% if form.report_template.errors %}
    <small class="error" id="err_report_template" role="alert">{{ form.report_template.errors.0 }}</small>
    {% endif %}

    {# Period panel — populated by HTMX after template selection #}
    <div id="period-loading" class="htmx-indicator" aria-hidden="true" style="padding: 0.5rem 0;">
        <span aria-busy="true">{% trans "Loading period options…" %}</span>
    </div>
    <div id="period-panel" aria-live="polite">
        {% if form.period.field.choices %}
        {# On POST re-render, show the period field inline #}
        <label for="id_period">
            {{ form.period.label }}
            {{ form.period }}
        </label>
        {% if form.period.errors %}
        <small class="error" role="alert">{{ form.period.errors.0 }}</small>
        {% endif %}
        {% endif %}
        {% if form.date_from.value or form.date_to.value %}
        <div class="grid">
            <label for="id_date_from">
                {{ form.date_from.label }}
                {{ form.date_from }}
                {% if form.date_from.errors %}<small class="error" role="alert">{{ form.date_from.errors.0 }}</small>{% endif %}
            </label>
            <label for="id_date_to">
                {{ form.date_to.label }}
                {{ form.date_to }}
                {% if form.date_to.errors %}<small class="error" role="alert">{{ form.date_to.errors.0 }}</small>{% endif %}
            </label>
        </div>
        {% endif %}
    </div>

    {# Export format #}
    <fieldset>
        <legend>{{ form.format.label }}</legend>
        {% for radio in form.format %}
        <label>
            {{ radio.tag }}
            {{ radio.choice_label }}
        </label>
        {% endfor %}
    </fieldset>

    {# Recipient tracking for audit purposes #}
    <fieldset>
        <legend>{% trans "Export recipient details" %}</legend>
        <p class="helper-text" style="margin-bottom: 1rem; color: var(--pico-muted-color);">
            {% trans "For audit purposes, please indicate who will receive this exported data." %}
        </p>
        <label for="{{ form.recipient.id_for_label }}">
            {{ form.recipient.label }}
            {{ form.recipient }}
            {% if form.recipient.help_text %}
            <small>{{ form.recipient.help_text }}</small>
            {% endif %}
            {% if form.recipient.errors %}
            <small class="error" role="alert">{{ form.recipient.errors.0 }}</small>
            {% endif %}
        </label>
        <label for="{{ form.recipient_reason.id_for_label }}">
            {{ form.recipient_reason.label }}
            {{ form.recipient_reason }}
            {% if form.recipient_reason.help_text %}
            <small>{{ form.recipient_reason.help_text }}</small>
            {% endif %}
            {% if form.recipient_reason.errors %}
            <small class="error" role="alert">{{ form.recipient_reason.errors.0 }}</small>
            {% endif %}
        </label>
    </fieldset>

    <button type="submit">{% trans "Generate Report" %}</button>
</form>
{% endif %}

{% if has_templates %}
{# Guidance section — only shown when templates exist (the no-templates warning box handles the other case) #}
<hr style="margin: 2rem 0;">
<details>
    <summary><strong>{% trans "Need a different report?" %}</strong></summary>
    <div style="margin-top: 1rem;">
        {% if can_custom_export %}
        <h2>{% trans "Create a custom export" %}</h2>
        <p>
            {% blocktrans %}If none of the templates above match what you need, you can build a one-off report by choosing your own program, metrics, date range, and groupings.{% endblocktrans %}
        </p>
        <p><a href="{% url 'reports:export_form' %}" role="button" class="outline">{% trans "Custom Export" %}</a></p>
        {% endif %}

        <h2>{% trans "Request a new report template" %}</h2>
        <p>
            {% blocktrans %}Report templates are set up by your administrator. If you need a recurring report for a partner, funder, or board that isn't listed above, ask your administrator to create one. They can define which metrics, demographics, and time periods to include so the report is ready to generate each period.{% endblocktrans %}
        </p>
        {% if user.is_admin %}
        <p><a href="{% url 'admin_settings:report_template_list' %}" role="button" class="outline">{% trans "Manage Report Templates" %}</a></p>
        {% endif %}
    </div>
</details>
{% endif %}
{% endblock %}
