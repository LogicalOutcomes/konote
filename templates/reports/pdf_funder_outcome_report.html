{% extends "reports/pdf_base.html" %}
{% load i18n %}

{% block title %}{% blocktrans with name=report_data.program_name %}Program Outcome Report — {{ name }}{% endblocktrans %}{% endblock %}

{% block styles %}
{{ block.super }}
/* Funder outcome report styles */
.report-header {
    background-color: #0d7377;
    color: #ffffff;
    padding: 0.3cm 0.5cm;
    margin-top: 1cm;
    font-size: 12pt;
    font-weight: 600;
}
.stat-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 0.4cm;
    margin: 0.5cm 0;
}
.stat-box {
    border: 1px solid #d1d5db;
    border-radius: 4px;
    padding: 0.3cm;
    text-align: center;
}
.stat-box .value {
    font-size: 18pt;
    font-weight: 700;
    color: #0d7377;
}
.stat-box .label {
    font-size: 9pt;
    color: #718096;
    margin-top: 0.1cm;
}
.outcome-card {
    border: 2px solid #0d7377;
    border-radius: 4px;
    padding: 0.4cm;
    margin: 0.3cm 0;
}
.outcome-card h4 {
    margin: 0 0 0.2cm 0;
    color: #0d7377;
    font-size: 11pt;
}
.outcome-card .rate {
    font-size: 24pt;
    font-weight: 700;
    color: #0d7377;
}
.outcome-card .details {
    font-size: 9pt;
    color: #4a5568;
    margin-top: 0.2cm;
}
.demo-row {
    display: grid;
    grid-template-columns: 1fr 80px 80px;
    padding: 4px 10px;
    border-bottom: 1px solid #e5e7eb;
}
.demo-row.header {
    background-color: #f7f8fa;
    font-weight: 600;
}
.demo-bar {
    background-color: #e5e7eb;
    height: 8px;
    border-radius: 4px;
    margin-top: 4px;
}
.demo-bar-fill {
    background-color: #0d7377;
    height: 100%;
    border-radius: 4px;
}
.footer-note {
    font-size: 9pt;
    color: #718096;
    font-style: italic;
    margin-top: 1cm;
    padding-top: 0.3cm;
    border-top: 1px solid #e5e7eb;
}
.metrics-table {
    width: 100%;
    border-collapse: collapse;
    margin: 0.5cm 0;
}
.metrics-table th, .metrics-table td {
    border: 1px solid #d1d5db;
    padding: 6px 10px;
    text-align: right;
    font-size: 10pt;
}
.metrics-table th:first-child, .metrics-table td:first-child {
    text-align: left;
}
.metrics-table thead th {
    background-color: #f7f8fa;
    font-weight: 600;
}
.narrative-section {
    border-left: 4px solid #0d7377;
    padding: 0.4cm 0.5cm;
    margin: 0.5cm 0;
    background-color: #f7f8fa;
}
.narrative-section .placeholder {
    font-style: italic;
    color: #718096;
}
.chart-section {
    margin: 0.5cm 0;
}
.chart-container {
    margin: 0.4cm 0;
    text-align: center;
}
.chart-image {
    max-width: 100%;
    height: auto;
}
.chart-caption {
    font-size: 9pt;
    color: #718096;
    margin-top: 0.1cm;
    font-style: italic;
}
{% endblock %}

{% block content %}
<!-- Report Header (merged title + organisation info) -->
<div class="pdf-header">
    <h1>{% trans "Program Outcome Report" %}</h1>
    <div class="subtitle">{{ report_data.program_name }}</div>
    <dl class="meta-grid">
        <dt>{% trans "Organisation" %}</dt>
        <dd>{{ report_data.organisation_name }}</dd>
        <dt>{% trans "Program" %}</dt>
        <dd>{{ report_data.program_name }}</dd>
        {% if report_data.program_description %}
        <dt>{% trans "Description" %}</dt>
        <dd>{{ report_data.program_description }}</dd>
        {% endif %}
        <dt>{% trans "Period" %}</dt>
        <dd>{{ report_data.reporting_period }}</dd>
        <dt>{% trans "Generated" %}</dt>
        <dd>{% blocktrans with date=report_data.generated_at|date:"Y-m-d" author=generated_by %}{{ date }} by {{ author }}{% endblocktrans %}</dd>
    </dl>
    <div class="draft-notice">
        <strong>{% trans "Draft Template:" %}</strong> {% trans "Verify this format matches the specific reporting requirements before submission." %}
    </div>
</div>

{% if sections %}
{# Section-driven layout: render in ReportSection.sort_order #}
{% for section in sections %}
{% if section.section_type == "service_stats" %}
<div class="report-header">{{ section.title }}</div>
<div class="stat-grid">
    <div class="stat-box">
        <div class="value">{{ report_data.total_individuals_served|default:"0" }}</div>
        <div class="label">{% trans "Total Individuals Served" %}</div>
    </div>
    <div class="stat-box">
        <div class="value">{{ report_data.new_clients_this_period|default:"0" }}</div>
        <div class="label">{% trans "New Participants This Period" %}</div>
    </div>
    <div class="stat-box">
        <div class="value">{{ report_data.total_contacts|default:"0" }}</div>
        <div class="label">{% trans "Total Service Contacts" %}</div>
    </div>
</div>

{% elif section.section_type == "metrics_table" %}
<div class="report-header">{{ section.title }}</div>
{% if metric_results %}
<table class="metrics-table">
    <thead>
        <tr>
            <th scope="col">{% trans "Metric" %}</th>
            {% for mr in metric_results %}
            {% if forloop.first %}
            {% for group_label, group_data in mr.values.items %}
            <th scope="col">{{ group_label }}</th>
            {% endfor %}
            {% endif %}
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for mr in metric_results %}
        <tr>
            <td>{{ mr.label }}</td>
            {% for group_label, group_data in mr.values.items %}
            <td>
                {% if group_data.n > 0 and group_data.n < suppression_threshold %}
                &lt; {{ suppression_threshold }}
                {% elif mr.aggregation == "threshold_percentage" or mr.aggregation == "percentage" %}
                {{ group_data.value }}%
                {% else %}
                {{ group_data.value }}
                {% endif %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
{# Fallback to legacy outcome display #}
{% if report_data.primary_outcome %}
<div class="outcome-card">
    <h4>{{ report_data.primary_outcome.name }}</h4>
    <div class="rate">{{ report_data.primary_outcome.achievement_rate }}%</div>
    <div class="details">
        <strong>{% trans "Target:" %}</strong> {{ report_data.primary_outcome.target_value }}<br>
        <strong>{% trans "Clients Measured:" %}</strong> {{ report_data.primary_outcome.clients_measured }}
    </div>
</div>
{% endif %}
{% if report_data.secondary_outcomes %}
<table>
    <thead>
        <tr>
            <th scope="col">{% trans "Indicator Name" %}</th>
            <th scope="col">{% trans "Target" %}</th>
            <th scope="col">{% trans "Measured" %}</th>
            <th scope="col">{% trans "Achieved" %}</th>
            <th scope="col">{% trans "Rate" %}</th>
        </tr>
    </thead>
    <tbody>
        {% for outcome in report_data.secondary_outcomes %}
        <tr>
            <td>{{ outcome.name }}</td>
            <td>{{ outcome.target_value }}</td>
            <td>{{ outcome.clients_measured }}</td>
            <td>{{ outcome.clients_achieved }}</td>
            <td>{{ outcome.achievement_rate }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
{% endif %}

{% elif section.section_type == "demographic_summary" %}
<div class="report-header">{{ section.title }}</div>
<div style="margin: 0.5cm 0;">
    <div class="demo-row header">
        <div>{% trans "Age Group" %}</div>
        <div style="text-align: right;">{% trans "Count" %}</div>
        <div style="text-align: right;">{% trans "Percentage" %}</div>
    </div>
    {% for age_group, count in report_data.age_demographics.items %}
    <div class="demo-row">
        <div>
            {{ age_group }}
            {% if report_data.age_demographics_total > 0 %}
            <div class="demo-bar">
                <div class="demo-bar-fill" style="width: {% widthratio count report_data.age_demographics_total 100 %}%;"></div>
            </div>
            {% endif %}
        </div>
        <div style="text-align: right;">{{ count }}</div>
        <div style="text-align: right;">
            {% if report_data.age_demographics_total > 0 %}
            {% widthratio count report_data.age_demographics_total 100 %}%
            {% else %}
            {% trans "N/A" %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
    <div class="demo-row header">
        <div>{% trans "Total" %}</div>
        <div style="text-align: right;">{{ report_data.age_demographics_total }}</div>
        <div style="text-align: right;">100%</div>
    </div>
</div>

{% elif section.section_type == "narrative" %}
<div class="report-header">{{ section.title }}</div>
<div class="narrative-section">
    {% if section.instructions %}
    <p>{{ section.instructions }}</p>
    {% endif %}
    <p class="placeholder">{% trans "[To be added during review]" %}</p>
</div>

{% elif section.section_type == "chart" %}
<div class="report-header">{{ section.title }}</div>
{% if chart_images %}
<div class="chart-section">
    {% for chart in chart_images %}
    <div class="chart-container avoid-break">
        <img src="{{ chart.chart_data_uri }}" alt="{% blocktrans with label=chart.label %}Bar chart showing {{ label }} across demographic groups{% endblocktrans %}" class="chart-image">
        <p class="chart-caption">{{ chart.label }}</p>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="narrative-section">
    <p class="placeholder">{% trans "No chart data available for this report." %}</p>
</div>
{% endif %}

{% endif %}
{% endfor %}

{# Overall summary after all sections #}
{% if report_data.achievement_summary.total_clients > 0 %}
<div class="report-header">{% trans "Overall Summary" %}</div>
<div class="summary-grid">
    <div class="summary-card">
        <div class="number">{{ report_data.achievement_summary.overall_rate }}%</div>
        <div class="label">{% trans "Overall Achievement Rate" %}</div>
    </div>
    <div class="summary-card">
        <div class="number">{{ report_data.achievement_summary.clients_met_any_target }} / {{ report_data.achievement_summary.total_clients }}</div>
        <div class="label">{% trans "Participants Met at Least One Target" %}</div>
    </div>
</div>
{% endif %}

{% else %}
{# Legacy layout: no ReportSection records — hard-coded order for backwards compatibility #}

<!-- Service Statistics -->
<div class="report-header">{% trans "Service Statistics" %}</div>
<div class="stat-grid">
    <div class="stat-box">
        <div class="value">{{ report_data.total_individuals_served|default:"0" }}</div>
        <div class="label">{% trans "Total Individuals Served" %}</div>
    </div>
    <div class="stat-box">
        <div class="value">{{ report_data.new_clients_this_period|default:"0" }}</div>
        <div class="label">{% trans "New Participants This Period" %}</div>
    </div>
    <div class="stat-box">
        <div class="value">{{ report_data.total_contacts|default:"0" }}</div>
        <div class="label">{% trans "Total Service Contacts" %}</div>
    </div>
</div>

<!-- Age Demographics -->
<div class="report-header">{% trans "Age Demographics" %}</div>
<div style="margin: 0.5cm 0;">
    <div class="demo-row header">
        <div>{% trans "Age Group" %}</div>
        <div style="text-align: right;">{% trans "Count" %}</div>
        <div style="text-align: right;">{% trans "Percentage" %}</div>
    </div>
    {% for age_group, count in report_data.age_demographics.items %}
    <div class="demo-row">
        <div>
            {{ age_group }}
            {% if report_data.age_demographics_total > 0 %}
            <div class="demo-bar">
                <div class="demo-bar-fill" style="width: {% widthratio count report_data.age_demographics_total 100 %}%;"></div>
            </div>
            {% endif %}
        </div>
        <div style="text-align: right;">{{ count }}</div>
        <div style="text-align: right;">
            {% if report_data.age_demographics_total > 0 %}
            {% widthratio count report_data.age_demographics_total 100 %}%
            {% else %}
            {% trans "N/A" %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
    <div class="demo-row header">
        <div>{% trans "Total" %}</div>
        <div style="text-align: right;">{{ report_data.age_demographics_total }}</div>
        <div style="text-align: right;">100%</div>
    </div>
</div>

<!-- Outcome Indicators -->
<div class="page-break"></div>
<h2>{% trans "Outcome Indicators" %}</h2>

{% if report_data.primary_outcome %}
<h3>{% trans "Primary Outcome" %}</h3>
<div class="outcome-card">
    <h4>{{ report_data.primary_outcome.name }}</h4>
    <div class="rate">{{ report_data.primary_outcome.achievement_rate }}%</div>
    <div class="details">
        <strong>{% trans "Target:" %}</strong> {{ report_data.primary_outcome.target_value }}<br>
        <strong>{% trans "Clients Measured:" %}</strong> {{ report_data.primary_outcome.clients_measured }}<br>
        <strong>{% trans "Clients Achieving Target:" %}</strong> {% blocktrans with achieved=report_data.primary_outcome.clients_achieved measured=report_data.primary_outcome.clients_measured %}{{ achieved }} of {{ measured }}{% endblocktrans %}
    </div>
</div>
{% endif %}

{% if report_data.secondary_outcomes %}
<h3>{% trans "Secondary Outcomes" %}</h3>
<table>
    <thead>
        <tr>
            <th scope="col">{% trans "Indicator Name" %}</th>
            <th scope="col">{% trans "Target" %}</th>
            <th scope="col">{% trans "Measured" %}</th>
            <th scope="col">{% trans "Achieved" %}</th>
            <th scope="col">{% trans "Rate" %}</th>
        </tr>
    </thead>
    <tbody>
        {% for outcome in report_data.secondary_outcomes %}
        <tr>
            <td>{{ outcome.name }}</td>
            <td>{{ outcome.target_value }}</td>
            <td>{{ outcome.clients_measured }}</td>
            <td>{{ outcome.clients_achieved }}</td>
            <td>{{ outcome.achievement_rate }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if not report_data.primary_outcome and not report_data.secondary_outcomes %}
<p><em>{% trans "No outcome indicators with targets defined for this program." %}</em></p>
{% endif %}

<!-- Overall Summary -->
{% if report_data.achievement_summary.total_clients > 0 %}
<div class="report-header">{% trans "Overall Summary" %}</div>
<div class="summary-grid">
    <div class="summary-card">
        <div class="number">{{ report_data.achievement_summary.overall_rate }}%</div>
        <div class="label">{% trans "Overall Achievement Rate" %}</div>
    </div>
    <div class="summary-card">
        <div class="number">{{ report_data.achievement_summary.clients_met_any_target }} / {{ report_data.achievement_summary.total_clients }}</div>
        <div class="label">{% trans "Participants Met at Least One Target" %}</div>
    </div>
</div>
{% endif %}
{% endif %}

<div class="footer-note">
    <strong>{% trans "Draft Template:" %}</strong> {% trans "This report was generated using KoNote's Program Outcome Report Template." %}
    {% trans "Verify this format matches the specific reporting requirements before submission." %}
    {% blocktrans with period=report_data.reporting_period %}Data reflects client outcomes recorded during the {{ period }} reporting period.{% endblocktrans %}
</div>
{% endblock %}
