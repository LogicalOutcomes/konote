{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% if editing %}{% trans "Edit Meeting" %}{% else %}{% trans "New Meeting" %}{% endif %} — {{ client.display_name }} {{ client.last_name }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/meeting-picker.css' %}">
{% endblock %}

{% block content %}
<hgroup>
    <h1>{% if editing %}{% trans "Edit Meeting" %}{% else %}{% trans "New Meeting" %}{% endif %}</h1>
    <p>{{ client.display_name }} {{ client.last_name }}{% if client.record_id %} ({{ client.record_id }}){% endif %}</p>
</hgroup>

<form method="post" id="meeting-form">
    {% csrf_token %}

    {# ---- Location (first — determines context for the rest) ---- #}
    <label for="{{ form.location.id_for_label }}">
        {{ form.location.label }}
    </label>
    {{ form.location }}
    {% if form.location.errors %}
    <small class="badge badge-danger" role="alert">{{ form.location.errors.0 }}</small>
    {% endif %}

    {# Custom location text input — shown when "Other" is selected #}
    <div id="location-custom-wrapper" style="display: none; margin-top: 0.5rem;">
        <label for="{{ form.location_custom.id_for_label }}">
            {{ form.location_custom.label }}
        </label>
        {{ form.location_custom }}
        {% if form.location_custom.errors %}
        <small class="badge badge-danger" role="alert">{{ form.location_custom.errors.0 }}</small>
        {% endif %}
    </div>

    {# ---- Date and Time (enhanced by meeting-picker.js) ---- #}
    <div id="meeting-time-config"
         data-time-start="{{ meeting_time_start|default:'9' }}"
         data-time-end="{{ meeting_time_end|default:'17' }}"
         data-time-step="{{ meeting_time_step|default:'30' }}">
        <label for="{{ form.start_timestamp.id_for_label }}">
            {{ form.start_timestamp.label }}
        </label>
        <small id="meeting-start-required">{% trans "* Required field." %}</small>
        {{ form.start_timestamp }}
        {# Fallback button — hidden when JS enhancement loads #}
        <button type="button" id="open-datetime-picker" class="secondary outline">
            <span aria-hidden="true">&#x1f4c5;</span>
            {% trans "Open calendar and time picker" %}
        </button>
        <small id="meeting-start-help">{% trans "Required. Pick from the calendar or type the date and time." %}</small>
        {% if form.start_timestamp.errors %}
        <small class="badge badge-danger" role="alert">{{ form.start_timestamp.errors.0 }}</small>
        {% endif %}
    </div>

    {# ---- Reminder (create mode only) ---- #}
    {% if not editing %}
    {% if features.messaging_sms or features.messaging_email %}
    {% if can_send_reminders %}
    <fieldset>
        <label for="{{ form.send_reminder.id_for_label }}">
            {{ form.send_reminder }}
            {{ form.send_reminder.label }}
        </label>
    </fieldset>
    {% else %}
    <fieldset>
        <label class="secondary">
            <input type="checkbox" disabled>
            {% trans "Send reminder" %}
            <small>({% trans "Participant has not consented to reminders" %})</small>
        </label>
    </fieldset>
    {% endif %}
    {% endif %}
    {% endif %}

    {# ---- Duration & Status (edit mode only) ---- #}
    {% if editing %}
    <label for="{{ form.duration_minutes.id_for_label }}">
        {{ form.duration_minutes.label }}
    </label>
    {{ form.duration_minutes }}
    {% if form.duration_minutes.errors %}
    <small class="badge badge-danger" role="alert">{{ form.duration_minutes.errors.0 }}</small>
    {% endif %}

    <label for="{{ form.status.id_for_label }}">
        {{ form.status.label }}
    </label>
    {{ form.status }}
    {% if form.status.errors %}
    <small class="badge badge-danger" role="alert">{{ form.status.errors.0 }}</small>
    {% endif %}
    {% endif %}

    {# ---- Action buttons ---- #}
    <div role="group">
        <button type="submit">{% if editing %}{% trans "Save Changes" %}{% else %}{% trans "Create Meeting" %}{% endif %}</button>
        {% if not editing %}
        <button type="submit" name="save_and_new" value="1" class="secondary">{% trans "Save & Schedule Another" %}</button>
        {% endif %}
        <a href="{% url 'events:event_list' client_id=client.pk %}" role="button" class="outline">{% trans "Cancel" %}</a>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="{% static 'js/meeting-picker.js' %}"></script>
<script>
(function () {
    var locationSelect = document.getElementById("{{ form.location.id_for_label }}");
    var customWrapper = document.getElementById("location-custom-wrapper");
    var customInput = document.getElementById("{{ form.location_custom.id_for_label }}");

    if (!locationSelect || !customWrapper) return;

    function toggleCustom() {
        if (locationSelect.value === "__other__") {
            customWrapper.style.display = "";
            if (customInput) customInput.focus();
        } else {
            customWrapper.style.display = "none";
        }
    }

    locationSelect.addEventListener("change", toggleCustom);
    // Show on page load if "Other" is pre-selected (edit mode)
    toggleCustom();
})();
</script>
{% endblock %}
